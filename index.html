<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yuvia Flights Mini App</title>
  <link href="https://unpkg.com/@picocss/pico@2/css/pico.classless.min.css" rel="stylesheet">
  <style>
    body{max-width:980px;margin:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 700px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Yuvia Flights Mini App</h1>
  <p><strong>Шаг 1:</strong> репозиторий готов ✅</p>

  <article>
    <header><strong>Шаг 2:</strong> заполните параметры — откроем поиск на Aviasales в новой вкладке.</header>

    <form id="searchForm">
      <div class="row">
        <label>
          Город вылета
          <input id="origin_city" name="origin_city" type="text" placeholder="Москва" value="Москва" required>
        </label>
        <label>
          Город назначения
          <input id="destination_city" name="destination_city" type="text" placeholder="Казань" value="Казань" required>
        </label>
      </div>

      <div class="row">
        <label>
          Дата вылета (ДД.ММ.ГГГГ)
          <input id="departure_date" name="departure_date" type="text" placeholder="15.11.2025" value="15.11.2025" required>
        </label>
        <label>
          Дата возвращения (опционально)
          <input id="return_date" name="return_date" type="text" placeholder="18.11.2025" value="18.11.2025">
        </label>
      </div>

      <div class="row">
        <label>
          Валюта
          <select id="currency">
            <option value="RUB" selected>RUB ₽</option>
            <option value="USD">USD $</option>
            <option value="EUR">EUR €</option>
          </select>
        </label>

        <label>
          Пассажиры
          <select id="adults">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>
          Только в одну сторону
          <select id="one_way">
            <option value="no" selected>Нет</option>
            <option value="yes">Да</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="direct_only">
          Только прямые рейсы
        </label>
      </div>

      <div class="row" style="grid-template-columns:auto auto">
        <button type="submit"><strong>Искать билеты</strong></button>
        <button id="swapBtn" type="button" class="secondary">Поменять местами</button>
      </div>
    </form>
  </article>

  <script>
    // ====== ВАШ ПАРТНЁРСКИЙ ID ======
    const MARKER = '672309';

    // --- утилиты дат ---
    function toISO(d){ // из "ДД.ММ.ГГГГ" -> "ГГГГ-ММ-ДД"
      if(!d) return '';
      const p = d.split('.'); if(p.length !== 3) return '';
      return `${p[2]}-${p[1]}-${p[0]}`;
    }

    // --- простая обвязка автодополнения для IATA ---
    async function cityToIata(city){
      try{
        const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(city)}&locale=ru&types[]=city`;
        const resp = await fetch(url, {mode: 'cors'});
        const data = await resp.json();
        // берём первый подходящий элемент с полем code
        return (Array.isArray(data) && data[0] && data[0].code) ? data[0].code : '';
      }catch(e){
        return '';
      }
    }

    // --- логика формы ---
    const form = document.getElementById('searchForm');
    const originI = document.getElementById('origin_city');
    const destI = document.getElementById('destination_city');
    const depI = document.getElementById('departure_date');
    const retI = document.getElementById('return_date');
    const curI = document.getElementById('currency');
    const aduI = document.getElementById('adults');
    const oneWayI = document.getElementById('one_way');
    const directCbx = document.getElementById('direct_only');

    // переключение one-way: очищаем возврат
    oneWayI.addEventListener('change', () => {
      if(oneWayI.value === 'yes'){ retI.value = ''; }
    });

    // кнопка "поменять местами"
    document.getElementById('swapBtn').addEventListener('click', () => {
      const a = originI.value; originI.value = destI.value; destI.value = a;
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const originCity = originI.value.trim();
      const destCity = destI.value.trim();
      const depISO = toISO(depI.value.trim());
      let retISO = toISO(retI.value.trim());

      if(oneWayI.value === 'yes'){ retISO = ''; }

      // получаем IATA для городов
      const [origin_iata, destination_iata] = await Promise.all([
        cityToIata(originCity),
        cityToIata(destCity)
      ]);

      // если не смогли определить IATA — просто открываем главную с marker
      if(!origin_iata || !destination_iata || !depISO){
        const fallback = `https://www.aviasales.ru/?marker=${encodeURIComponent(MARKER)}`;
        window.open(fallback, '_blank');
        return;
      }

      // собираем параметры запроса
      const params = new URLSearchParams();
      params.set('marker', MARKER);
      params.set('origin_iata', origin_iata);
      params.set('destination_iata', destination_iata);
      params.set('depart_date', depISO);
      if(retISO) params.set('return_date', retISO);
      params.set('adults', aduI.value);
      params.set('currency', curI.value);
      if(directCbx.checked) params.set('direct', 'true');
      params.set('with_request', 'true'); // сразу открыть результаты

      const url = `https://www.aviasales.ru/?${params.toString()}`;
      window.open(url, '_blank');
    });
  </script>
</body>
</html>

