<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yuvia Flights Mini App</title>
  <link href="https://unpkg.com/@picocss/pico@2/css/pico.classless.min.css" rel="stylesheet">
  <style>
    body{max-width:980px;margin:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width: 700px){.row{grid-template-columns:1fr}}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{border:1px solid #e3e3e3;border-radius:999px;padding:6px 10px;cursor:pointer}
    .muted{opacity:.75}
    .alt-links{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  </style>
</head>
<body>
  <h1>Yuvia Flights Mini App</h1>
  <p><strong>Шаг 1:</strong> репозиторий готов ✅</p>

  <article>
    <header><strong>Шаг 2:</strong> заполните параметры — откроем поиск на Aviasales в новой вкладке.</header>

    <form id="searchForm">
      <div class="row">
        <label>
          Город вылета
          <input id="origin_city" name="origin_city" type="text" placeholder="Москва" value="Москва" required>
        </label>
        <label>
          Город назначения
          <input id="destination_city" name="destination_city" type="text" placeholder="Казань" value="Казань" required>
        </label>
      </div>

      <div class="row">
        <label>
          Дата вылета (ДД.ММ.ГГГГ)
          <input id="departure_date" name="departure_date" type="text" placeholder="15.11.2025" value="15.11.2025" required>
        </label>
        <label>
          Дата возвращения (опционально)
          <input id="return_date" name="return_date" type="text" placeholder="18.11.2025" value="18.11.2025">
        </label>
      </div>

      <div class="row">
        <label>
          Валюта
          <select id="currency">
            <option value="RUB" selected>RUB ₽</option>
            <option value="USD">USD $</option>
            <option value="EUR">EUR €</option>
          </select>
        </label>

        <label>
          Пассажиры
          <select id="adults">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>
          Только в одну сторону
          <select id="one_way">
            <option value="no" selected>Нет</option>
            <option value="yes">Да</option>
          </select>
        </label>

        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="direct_only">
          Только прямые рейсы
        </label>
      </div>

      <div class="row">
        <label>
          Гибкие даты
          <select id="flex_mode" title="Дополнительно покажем альтернативные даты">
            <option value="exact" selected>Точно в выбранные даты</option>
            <option value="p3">±3 дня (подборка ссылок)</option>
            <option value="p7">±7 дней (подборка ссылок)</option>
            <option value="weekend">Выходные рядом</option>
          </select>
        </label>

        <div style="display:flex;align-items:end;gap:8px">
          <button type="submit"><strong>Искать билеты</strong></button>
          <button id="swapBtn" type="button" class="secondary">Поменять местами</button>
          <button id="copyBtn" type="button" class="secondary">Скопировать ссылку</button>
        </div>
      </div>
    </form>

    <div id="altBox" class="alt-links" hidden></div>

    <details style="margin-top:18px">
      <summary><strong>Недавние запросы</strong> (до 5)</summary>
      <div id="recentBox" class="chips"></div>
    </details>
  </article>

  <p class="muted">Подсказка: «В одну сторону» очищает дату возврата. Гибкие даты — это просто набор удобных ссылок на соседние дни.</p>

  <script>
    // ====== ВАШ ПАРТНЁРСКИЙ ID ======
    const MARKER = '672309';

    // --- утилиты дат ---
    function toISO(d){ // из "ДД.ММ.ГГГГ" -> "ГГГГ-ММ-ДД"
      if(!d) return '';
      const p = d.split('.'); if(p.length !== 3) return '';
      return `${p[2]}-${p[1]}-${p[0]}`;
    }
    function fromText(d){ // "ДД.ММ.ГГГГ" -> Date
      const p = d.split('.'); if(p.length !== 3) return null;
      return new Date(Number(p[2]), Number(p[1])-1, Number(p[0]));
    }
    function fmtISO(date){ // Date -> "ГГГГ-ММ-ДД"
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function addDays(date, n){
      const d = new Date(date); d.setDate(d.getDate()+n); return d;
    }
    function weekendAround(date){
      // ближайшие выходные относительно выбранной даты: пятница -> воскресенье
      const d = new Date(date);
      const day = d.getDay(); // 0-вс, 5-пт, 6-сб
      // смещаемся к пятнице
      const shiftToFri = (day <= 5) ? (5 - day) : ((12 - day)); // если сб(6)->+6, вс(0)->+5
      const fri = addDays(d, shiftToFri);
      const sun = addDays(fri, 2);
      return {depart: fri, ret: sun};
    }

    // --- получение IATA ---
    async function cityToIata(city){
      try{
        const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(city)}&locale=ru&types[]=city`;
        const resp = await fetch(url, {mode: 'cors'});
        const data = await resp.json();
        return (Array.isArray(data) && data[0] && data[0].code) ? data[0].code : '';
      }catch(e){
        return '';
      }
    }

    // --- элементы формы ---
    const form = document.getElementById('searchForm');
    const originI = document.getElementById('origin_city');
    const destI = document.getElementById('destination_city');
    const depI = document.getElementById('departure_date');
    const retI = document.getElementById('return_date');
    const curI = document.getElementById('currency');
    const aduI = document.getElementById('adults');
    const oneWayI = document.getElementById('one_way');
    const directCbx = document.getElementById('direct_only');
    const flexI = document.getElementById('flex_mode');
    const altBox = document.getElementById('altBox');
    const recentBox = document.getElementById('recentBox');

    // переключение one-way: очищаем возврат
    oneWayI.addEventListener('change', () => {
      if(oneWayI.value === 'yes'){ retI.value = ''; }
    });

    // кнопка "поменять местами"
    document.getElementById('swapBtn').addEventListener('click', () => {
      const a = originI.value; originI.value = destI.value; destI.value = a;
    });

    // кнопка "копировать ссылку"
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const url = await buildMainLink();
      if(!url){ alert('Заполните города и дату вылета'); return; }
      try{
        await navigator.clipboard.writeText(url);
        alert('Ссылка скопирована');
      }catch(e){
        prompt('Скопируйте ссылку вручную:', url);
      }
    });

    // сохранение/отрисовка последних запросов
    const RECENT_KEY = 'yuvia_recent';
    function pushRecent(q){
      try{
        const arr = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
        arr.unshift(q);
        // удаляем дубликаты по "from-to-date-ret-oneway"
        const seen = new Set();
        const dedup = [];
        for(const it of arr){
          const key = [it.o, it.d, it.dep, it.ret||'', it.ow].join('|');
          if(!seen.has(key)){ seen.add(key); dedup.push(it); }
        }
        localStorage.setItem(RECENT_KEY, JSON.stringify(dedup.slice(0,5)));
      }catch(e){}
    }
    function renderRecent(){
      recentBox.innerHTML = '';
      try{
        const arr = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
        arr.forEach(it=>{
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = `${it.o} → ${it.d} • ${it.dep}${it.ret?`—${it.ret}`:''} • ${it.ow==='yes'?'OW':'RT'}`;
          chip.onclick = async ()=>{
            originI.value = it.o; destI.value = it.d;
            depI.value = it.depText; retI.value = it.retText || '';
            oneWayI.value = it.ow; curI.value = it.cur; aduI.value = it.ad;
            const link = await buildMainLink();
            if(link) window.open(link, '_blank');
          };
          recentBox.appendChild(chip);
        });
      }catch(e){}
    }
    renderRecent();

    // конструктор главной ссылки
    async function buildMainLink(customDates){
      const originCity = originI.value.trim();
      const destCity = destI.value.trim();
      const depISO = customDates?.departISO ?? toISO(depI.value.trim());
      let retISO = customDates?.returnISO ?? toISO(retI.value.trim());
      if(oneWayI.value === 'yes'){ retISO = ''; }
      if(!originCity || !destCity || !depISO){ return ''; }

      const [origin_iata, destination_iata] = await Promise.all([
        cityToIata(originCity),
        cityToIata(destCity)
      ]);
      if(!origin_iata || !destination_iata){ return ''; }

      const params = new URLSearchParams();
      params.set('marker', MARKER);
      params.set('origin_iata', origin_iata);
      params.set('destination_iata', destination_iata);
      params.set('depart_date', depISO);
      if(retISO) params.set('return_date', retISO);
      params.set('adults', aduI.value);
      params.set('currency', curI.value);
      if(directCbx.checked) params.set('direct', 'true');
      params.set('with_request', 'true');
      return `https://www.aviasales.ru/?${params.toString()}`;
    }

    // обработчик формы
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      altBox.hidden = true; altBox.innerHTML = '';

      // сохраняем в «недавние»
      pushRecent({
        o: originI.value.trim(),
        d: destI.value.trim(),
        dep: toISO(depI.value.trim()),
        ret: toISO(retI.value.trim()) || '',
        depText: depI.value.trim(),
        retText: retI.value.trim() || '',
        ow: oneWayI.value,
        cur: curI.value,
        ad: aduI.value
      });
      renderRecent();

      const baseDep = fromText(depI.value.trim());
      const baseRet = retI.value.trim() ? fromText(retI.value.trim()) : null;

      // основной переход
      const main = await buildMainLink();
      if(!main){ alert('Заполните города и дату вылета'); return; }
      window.open(main, '_blank');

      // гибкие даты: показываем набор ссылок
      const mode = flexI.value;
      if(mode === 'exact') return;

      const makeBtn = (title, url)=>{
        const a = document.createElement('a');
        a.href = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
        a.className = 'secondary';
        a.textContent = title;
        return a;
      };

      const produceRange = async (radiusDays)=>{
        // если round-trip, сохраняем длительность
        let tripLen = 0;
        if(baseRet){ tripLen = Math.max(1, Math.round((baseRet - baseDep)/86400000)); }
        for(let d=-radiusDays; d<=radiusDays; d++){
          const depart = addDays(baseDep, d);
          const departISO = fmtISO(depart);
          let returnISO = '';
          if(oneWayI.value !== 'yes' && tripLen>0){
            returnISO = fmtISO(addDays(depart, tripLen));
          }
          const url = await buildMainLink({departISO, returnISO});
          if(url){
            altBox.appendChild(makeBtn(`${depart.toLocaleDateString('ru-RU')}`, url));
          }
        }
      };

      if(mode === 'p3'){ await produceRange(3); }
      if(mode === 'p7'){ await produceRange(7); }
      if(mode === 'weekend'){
        const {depart, ret} = weekendAround(baseDep);
        const departISO = fmtISO(depart);
        const returnISO = (oneWayI.value === 'yes') ? '' : fmtISO(ret);
        const url = await buildMainLink({departISO, returnISO});
        if(url){
          altBox.appendChild(makeBtn(`Ближайшие выходные: ${depart.toLocaleDateString('ru-RU')} — ${ret.toLocaleDateString('ru-RU')}`, url));
        }
      }

      if(altBox.children.length){ altBox.hidden = false; }
    });
  </script>
</body>
</html>
