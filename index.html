<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Yuvia Flight Concierge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    body {
      margin: 0;
      background: #F7F4EF;
      color: #1F2733;
    }
    a { color: inherit; text-decoration: none; }
    button { font-family: inherit; }
    input, select { font-family: inherit; }

    .page {
      min-height: 100vh;
      background: #F7F4EF;
    }
    .top-nav {
      padding: 16px 24px;
    }
    .top-nav-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .logo-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #11A26A 0%, #F97316 60%, #FACC6B 100%);
    }
    .content-wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    .card {
      background: #FFFFFF;
      border-radius: 20px;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.12);
      padding: 24px;
    }

    .intro-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .intro-sub {
      font-size: 14px;
      color: #6B7280;
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid #E2E8F0;
      font-size: 14px;
      background: transparent;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #EEF3F1;
      border-color: #11A26A;
      color: #1F2733;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }
    .field-label {
      font-size: 13px;
      color: #6B7280;
    }
    .field-input {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #E2E8F0;
      font-size: 14px;
    }

    .section-title {
      font-weight: 500;
      font-size: 14px;
      margin-top: 16px;
      margin-bottom: 8px;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid #E2E8F0;
      font-size: 13px;
      background: #FFFFFF;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .chip input {
      margin: 0;
    }
    .chip-toggle.active {
      background: #EEF3F1;
      border-color: #11A26A;
    }

    .form-footer {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .form-hint {
      font-size: 13px;
      color: #6B7280;
    }
    .btn-primary {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #11A26A;
      color: #FFFFFF;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-primary[disabled] {
      background: #0B7C4E;
      opacity: 0.8;
      cursor: default;
    }

    .layout-results {
      margin-top: 20px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      .layout-results {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .results-header {
      margin-bottom: 10px;
      font-size: 13px;
      color: #6B7280;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .route-card {
      border-radius: 16px;
      border: 1px solid #E2E8F0;
      padding: 14px;
      margin-bottom: 10px;
      cursor: pointer;
      background: #FFFFFF;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    .route-card.selected {
      border-color: #11A26A;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.14);
    }
    .route-card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
    }
    .route-title {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .route-price-block {
      text-align: right;
      min-width: 110px;
    }
    .route-price {
      font-weight: 600;
      font-size: 16px;
    }
    .btn-ghost {
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #E2E8F0;
      background: transparent;
      font-size: 12px;
      cursor: pointer;
    }
    .btn-ghost.active {
      border-color: #11A26A;
      background: #EEF3F1;
    }

    .timeline-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #6B7280;
      margin-bottom: 6px;
    }
    .timeline-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: #E5E7EB;
      overflow: hidden;
    }
    .timeline-segment {
      position: absolute;
      top: 0;
      bottom: 0;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
    }

    .yuvia-panel {
      background: #EEF3F1;
      border-radius: 16px;
      padding: 16px;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .yuvia-panel-title {
      font-weight: 600;
      font-size: 15px;
    }
    .yuvia-bubble {
      padding: 12px;
      border-radius: 12px;
      background: #FFFFFF;
      font-size: 14px;
    }
    .yuvia-footer {
      margin-top: auto;
      font-size: 12px;
      color: #6B7280;
    }

    .btn-outline {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #E2E8F0;
      background: #FFFFFF;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-outline-primary {
      border: none;
      background: #11A26A;
      color: #FFFFFF;
      margin-left: 10px;
    }

    .compare-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #FFFFFF;
      border-top: 1px solid #E2E8F0;
      box-shadow: 0 -10px 30px rgba(15,23,42,0.12);
      padding: 16px;
      z-index: 40;
      display: none;
    }
    .compare-drawer.active { display: block; }
    .compare-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .compare-list {
      display: flex;
      gap: 16px;
      overflow-x: auto;
    }
    .compare-card {
      min-width: 220px;
      border-radius: 14px;
      border: 1px solid #E2E8F0;
      padding: 10px;
      font-size: 13px;
    }

    .trip-bar {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 70px;
      max-width: 1280px;
      margin: 0 auto;
      padding: 12px;
      border-radius: 999px;
      background: #FFFFFF;
      box-shadow: 0 12px 40px rgba(15,23,42,0.18);
      border: 1px solid #E2E8F0;
      display: none;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      gap: 12px;
      z-index: 35;
    }
    .trip-bar.active { display: flex; }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal {
      background: #FFFFFF;
      border-radius: 20px;
      max-width: 640px;
      width: 100%;
      max-height: 85vh;
      overflow: auto;
      padding: 20px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .segment-card {
      border-radius: 14px;
      border: 1px solid #E2E8F0;
      padding: 12px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
<div class="page">
  <header class="top-nav">
    <div class="top-nav-inner">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="logo-circle"></div>
        <div>
          <div style="font-weight:600;font-size:18px;">Yuvia</div>
          <div style="font-size:12px;color:#6B7280;">умный тревел-консьерж</div>
        </div>
      </div>
    </div>
  </header>

  <main class="content-wrap">
    <section class="card">
      <div class="intro-title">Подобрать перелёт с Yuvia</div>
      <div class="intro-sub">
        Не только цена, но и спокойствие: я подсвечу ночные вылеты,
        сомнительные стыковки и помогу выбрать маршрут под твой стиль.
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="search">Подобрать рейсы</button>
        <button class="tab-btn" data-tab="direction">Подобрать направление</button>
        <button class="tab-btn" data-tab="ticket">Проверить мой билет</button>
      </div>

      <!-- ТАБ 1: ПОИСК РЕЙСОВ -->
      <div class="tab-content active" id="tab-search">
        <form id="search-form">
          <div class="form-row">
            <div class="field">
              <label class="field-label">Откуда</label>
              <input class="field-input" id="from-input" value="Москва" placeholder="Город вылета">
            </div>
            <div class="field">
              <label class="field-label">Куда</label>
              <input class="field-input" id="to-input" value="Казань" placeholder="Город назначения">
            </div>
            <div class="field" style="max-width:180px;">
              <label class="field-label">Дата вылета</label>
              <input class="field-input" type="date" id="date-input">
            </div>
            <div class="field" style="max-width:140px;">
              <label class="field-label">Пассажиры</label>
              <input class="field-input" type="number" min="1" max="9" id="passengers-input" value="1">
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
            <label style="font-size:13px;color:#6B7280;">
              <input type="checkbox" id="flexible-input" checked style="margin-right:6px;">
              Можно сдвинуть даты на ±3 дня, если так будет удобнее/дешевле
            </label>
          </div>

          <div class="section-title">Стиль поездки</div>
          <div class="chip-row">
            <button type="button" class="chip chip-toggle" data-priority="price">Сэкономить</button>
            <button type="button" class="chip chip-toggle active" data-priority="balance">Баланс</button>
            <button type="button" class="chip chip-toggle" data-priority="comfort">Комфорт и спокойствие</button>
          </div>

          <div class="section-title">Твои ощущения и триггеры</div>
          <div class="chip-row">
            <label class="chip">
              <input type="checkbox" id="pref-night" checked>
              Избегать ночных перелётов
            </label>
            <label class="chip">
              <input type="checkbox" id="pref-short" checked>
              Не люблю короткие стыковки
            </label>
            <label class="chip">
              <input type="checkbox" id="pref-afraid">
              Боюсь пересадок
            </label>
            <label class="chip">
              <input type="checkbox" id="pref-overnight" checked>
              Не хочу ночевать в аэропорту
            </label>
          </div>

          <div class="form-footer">
            <div class="form-hint">
              Yuvia запомнит твой стиль и в следующий раз подстроится автоматически ✈️
            </div>
            <button type="submit" class="btn-primary" id="search-btn">
              Подобрать маршруты
            </button>
          </div>
        </form>

        <div id="results-block" style="margin-top:20px;display:none;">
          <div class="layout-results">
            <div>
              <div class="results-header">
                <span id="results-count"></span>
                <span>Клик по карточке — подробности справа.</span>
              </div>
              <div id="routes-list"></div>
              <div id="routes-actions" style="display:none;">
                <button type="button" class="btn-outline" id="details-btn">
                  Открыть подробности выбранного маршрута
                </button>
                <button type="button" class="btn-outline btn-outline-primary" id="save-trip-btn">
                  Сохранить как маршрут поездки
                </button>
              </div>
            </div>
            <div>
              <div id="yuvia-panel" class="yuvia-panel">
                <!-- заполняется скриптом -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ТАБ 2: ПОДОБРАТЬ НАПРАВЛЕНИЕ -->
      <div class="tab-content" id="tab-direction">
        <p style="font-size:14px;margin-top:0;margin-bottom:12px;">
          Здесь позже можно будет включить настоящий подбор направлений «куда-нибудь».
          Сейчас это аккуратная заготовка, чтобы сохранить UX.
        </p>
        <div class="form-row">
          <div class="field">
            <label class="field-label">Откуда выезжаешь</label>
            <input class="field-input" placeholder="Москва">
          </div>
          <div class="field" style="max-width:180px;">
            <label class="field-label">Когда</label>
            <input class="field-input" type="date">
          </div>
          <div class="field" style="max-width:200px;">
            <label class="field-label">Бюджет на человека</label>
            <input class="field-input" type="number" placeholder="Например, 15000">
          </div>
        </div>
        <div style="margin-top:16px;">
          <button type="button" class="btn-primary">Подобрать идеи (скоро)</button>
        </div>
      </div>

      <!-- ТАБ 3: ПРОВЕРИТЬ БИЛЕТ -->
      <div class="tab-content" id="tab-ticket">
        <p style="font-size:14px;margin-top:0;margin-bottom:12px;">
          Здесь потом будет ввод кода брони и анализ уже купленных билетов:
          стыковки, риски, советы. Сейчас это аккуратная заглушка.
        </p>
        <div class="form-row">
          <div class="field" style="max-width:220px;">
            <label class="field-label">Код брони / номер билета</label>
            <input class="field-input" placeholder="Например, AB12CD">
          </div>
          <div class="field" style="max-width:220px;">
            <label class="field-label">Авиакомпания</label>
            <input class="field-input" placeholder="Например, Aeroflot">
          </div>
        </div>
        <div style="margin-top:16px;">
          <button type="button" class="btn-primary">Проверить маршрут (скоро)</button>
        </div>
        <p style="font-size:13px;color:#6B7280;margin-top:12px;">
          Даже с уже купленными билетами Yuvia сможет посчитать стресс,
          подсветить риски пересадок и собрать маршрут по городу под твои часы.
        </p>
      </div>
    </section>
  </main>

  <!-- нижняя плашка с сохранённым маршрутом -->
  <div class="trip-bar" id="trip-bar">
    <div>
      <div style="font-weight:500;" id="trip-title"></div>
      <div style="color:#6B7280;" id="trip-sub"></div>
    </div>
    <div style="text-align:right;">
      <div id="trip-price"></div>
      <div style="font-size:12px;color:#6B7280;">
        позже сюда можно добавить кнопку «маршрут по городу»
      </div>
    </div>
  </div>

  <!-- сравнение -->
  <div class="compare-drawer" id="compare-drawer">
    <div class="compare-header">
      <div id="compare-title">Сравнение маршрутов</div>
      <button type="button" style="border:none;background:transparent;cursor:pointer;font-size:12px;color:#6B7280;" id="compare-close-btn">
        Скрыть
      </button>
    </div>
    <div class="compare-list" id="compare-list"></div>
  </div>

  <!-- модальное окно деталей -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div style="font-weight:600;font-size:16px;">Детали маршрута</div>
          <div style="font-size:13px;color:#6B7280;" id="modal-subtitle"></div>
        </div>
        <button type="button" class="btn-outline" id="modal-close-btn">Закрыть</button>
      </div>
      <div id="modal-segments"></div>
      <div style="margin-top:8px;font-size:13px;color:#6B7280;">
        В будущем здесь появится подробный чек-лист «День вылета» и советы,
        что делать в каждой точке маршрута: от входа в аэропорт до выхода в
        город по прилёту.
      </div>
    </div>
  </div>
</div>

<script>
  // ===== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДАТ/СТРЕССА =====
  function addMinutes(date, minutes) {
    return new Date(date.getTime() + minutes * 60000);
  }
  function minutesBetween(a, b) {
    return Math.round((b.getTime() - a.getTime()) / 60000);
  }
  function isNight(date) {
    const h = date.getHours();
    return h < 6 || h >= 23;
  }

  function computeStressForSegments(segments, prefs) {
    let score = 0;
    let tags = [];
    let hasNight = false;
    let hasOvernight = false;

    const first = new Date(segments[0].departTime);
    const last = new Date(segments[segments.length - 1].arriveTime);

    const totalDuration = minutesBetween(first, last);
    const connections = segments.length - 1;

    segments.forEach(function (s) {
      const d = new Date(s.departTime);
      const a = new Date(s.arriveTime);
      if (isNight(d) || isNight(a)) {
        hasNight = true;
        score += prefs.avoidNightFlights ? 2 : 1;
      }
    });

    for (var i = 0; i < segments.length - 1; i++) {
      var a = new Date(segments[i].arriveTime);
      var d = new Date(segments[i + 1].departTime);
      var conn = minutesBetween(a, d);
      if (conn < 50) {
        score += prefs.avoidShortConnections ? 3 : 2;
        tags.push('Короткая стыковка');
      } else if (conn < 90) {
        score += 1;
      } else if (conn > 240) {
        score += 1;
        tags.push('Долгая стыковка');
      }
      if (conn > 480 && isNight(a) && !isNight(d)) {
        hasOvernight = true;
        score += prefs.avoidAirportOvernights ? 3 : 2;
        tags.push('Ночёвка в аэропорту');
      }
    }

    if (prefs.avoidEarlyDepartures && first.getHours() < 8) {
      score += 2;
      tags.push('Ранний вылет');
    }
    if (prefs.avoidLateArrivals && last.getHours() > 23) {
      score += 2;
      tags.push('Позднее прибытие');
    }

    if (connections >= 2) {
      score += prefs.afraidOfConnections ? 3 : 2;
      tags.push(connections + ' пересадки');
    } else if (connections === 1) {
      score += prefs.afraidOfConnections ? 2 : 1;
      tags.push('1 пересадка');
    } else {
      tags.push('Без пересадок');
    }

    if (totalDuration > 12 * 60) {
      score += 2;
      tags.push('Долгая дорога');
    }

    var normalized = Math.min(10, Math.round(score));
    return {
      stressScore: normalized,
      hasNightSegments: hasNight,
      hasAirportOvernight: hasOvernight,
      totalDurationMinutes: totalDuration,
      totalConnections: connections,
      tags: Array.from(new Set(tags))
    };
  }

  function getStressLabel(score) {
    if (score <= 3) return { label: 'Минимальный стресс', tone: 'low' };
    if (score <= 6) return { label: 'Умеренный стресс', tone: 'medium' };
    return { label: 'Высокий стресс', tone: 'high' };
  }

  // ===== ГЕНЕРАЦИЯ МОКОВЫХ МАРШРУТОВ =====
  function createSegment(from, to, fromCode, toCode, depart, durationMin, airline, flightNumber, baggageIncluded, handLuggageOnly) {
    return {
      id: fromCode + '-' + toCode + '-' + flightNumber + '-' + depart.toISOString(),
      from: from,
      to: to,
      fromCode: fromCode,
      toCode: toCode,
      departTime: depart.toISOString(),
      arriveTime: addMinutes(depart, durationMin).toISOString(),
      airline: airline,
      flightNumber: flightNumber,
      baggageIncluded: baggageIncluded,
      handLuggageOnly: handLuggageOnly
    };
  }

  function searchFlightsMock(params) {
    var baseDate = new Date(params.departDate);
    baseDate.setHours(9, 0, 0, 0);

    var segmentsVariants = [];

    // 1. Прямой дневной
    segmentsVariants.push([
      createSegment(params.from, params.to, 'FROM', 'TO', new Date(baseDate), 90, 'Yuvia Air', 'YA101', true, false)
    ]);

    // 2. Утренний с пересадкой
    var morning = new Date(baseDate);
    morning.setHours(7);
    var seg2a = createSegment(params.from, 'Город пересадки', 'FROM', 'HUB', morning, 60, 'SkyHub', 'SH220', false, true);
    var seg2bDepart = addMinutes(new Date(seg2a.arriveTime), 55);
    var seg2b = createSegment('Город пересадки', params.to, 'HUB', 'TO', seg2bDepart, 70, 'SkyHub', 'SH221', false, true);
    segmentsVariants.push([seg2a, seg2b]);

    // 3. Ночной прямой
    var night = new Date(baseDate);
    night.setHours(23);
    segmentsVariants.push([
      createSegment(params.from, params.to, 'FROM', 'TO', night, 100, 'NightLines', 'NL777', true, false)
    ]);

    // 4. Длинный с ночёвкой
    var eve = new Date(baseDate);
    eve.setHours(20);
    var seg4a = createSegment(params.from, 'Поздний хаб', 'FROM', 'H1', eve, 150, 'LongTrip', 'LT330', true, false);
    var seg4bDepart = addMinutes(new Date(seg4a.arriveTime), 9 * 60);
    var seg4b = createSegment('Поздний хаб', params.to, 'H1', 'TO', seg4bDepart, 90, 'LongTrip', 'LT331', true, false);
    segmentsVariants.push([seg4a, seg4b]);

    var currency = 'RUB';
    var basePrice = 11467;

    var routes = segmentsVariants.map(function (segments, idx) {
      var stressInfo = computeStressForSegments(segments, params.preferences);
      var multipliers = [1, 0.9, 0.8, 1.15];
      var priceMultiplier = multipliers[idx] || 1;
      var price = Math.round(basePrice * priceMultiplier);
      var titles = [
        'Спокойный дневной без пересадок',
        'Быстро, но со стыковкой',
        'Ночной перелёт',
        'Длинный маршрут с ночёвкой'
      ];
      return {
        id: 'route-' + idx,
        title: titles[idx] || ('Маршрут ' + (idx + 1)),
        price: price,
        currency: currency,
        segments: segments,
        stressScore: stressInfo.stressScore,
        hasNightSegments: stressInfo.hasNightSegments,
        hasAirportOvernight: stressInfo.hasAirportOvernight,
        totalDurationMinutes: stressInfo.totalDurationMinutes,
        totalConnections: stressInfo.totalConnections,
        tags: stressInfo.tags
      };
    });

    var priority = params.preferences.priority;
    routes.sort(function (a, b) {
      if (priority === 'price') {
        return a.price - b.price;
      } else if (priority === 'comfort') {
        return a.stressScore - b.stressScore;
      } else {
        return (a.price + a.stressScore * 500) - (b.price + b.stressScore * 500);
      }
    });

    return routes;
  }

  // ===== ГЛОБАЛЬНОЕ СОСТОЯНИЕ =====
  var state = {
    routes: [],
    selectedRouteId: null,
    compareIds: [],
    searchParams: null,
    savedTrip: null,
    preferences: {
      priority: 'balance',
      avoidNightFlights: true,
      avoidShortConnections: true,
      avoidEarlyDepartures: false,
      avoidLateArrivals: false,
      afraidOfConnections: false,
      avoidAirportOvernights: true
    }
  };

  // ===== ПЕРЕКЛЮЧЕНИЕ ТАБОВ =====
  document.querySelectorAll('.tab-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var tab = btn.getAttribute('data-tab');
      document.querySelectorAll('.tab-btn').forEach(function (b) {
        b.classList.toggle('active', b === btn);
      });
      document.querySelectorAll('.tab-content').forEach(function (c) {
        c.classList.toggle('active', c.id === 'tab-' + tab);
      });
    });
  });

  // Установка сегодняшней даты
  (function setToday() {
    var input = document.getElementById('date-input');
    var today = new Date();
    var iso = today.toISOString().slice(0, 10);
    input.value = iso;
  })();

  // Приоритет
  document.querySelectorAll('.chip-toggle').forEach(function (chip) {
    chip.addEventListener('click', function () {
      var pr = chip.getAttribute('data-priority');
      state.preferences.priority = pr;
      document.querySelectorAll('.chip-toggle').forEach(function (c) {
        c.classList.toggle('active', c === chip);
      });
    });
  });

  // ===== ОБРАБОТЧИК ПОДБОРА МАРШРУТОВ =====
  var searchForm = document.getElementById('search-form');
  var searchBtn = document.getElementById('search-btn');
  var resultsBlock = document.getElementById('results-block');
  var routesListEl = document.getElementById('routes-list');
  var resultsCountEl = document.getElementById('results-count');
  var routesActionsEl = document.getElementById('routes-actions');
  var yuviaPanelEl = document.getElementById('yuvia-panel');

  searchForm.addEventListener('submit', function (e) {
    e.preventDefault();
    searchBtn.disabled = true;
    searchBtn.textContent = 'Подбираю варианты…';

    var params = {
      from: document.getElementById('from-input').value || 'Город вылета',
      to: document.getElementById('to-input').value || 'Город назначения',
      departDate: document.getElementById('date-input').value,
      flexibleDates: document.getElementById('flexible-input').checked,
      passengers: Number(document.getElementById('passengers-input').value) || 1,
      preferences: {
        priority: state.preferences.priority,
        avoidNightFlights: document.getElementById('pref-night').checked,
        avoidShortConnections: document.getElementById('pref-short').checked,
        avoidEarlyDepartures: false,
        avoidLateArrivals: false,
        afraidOfConnections: document.getElementById('pref-afraid').checked,
        avoidAirportOvernights: document.getElementById('pref-overnight').checked
      }
    };

    state.searchParams = params;
    state.compareIds = [];
    state.selectedRouteId = null;

    // имитируем "сетевой" запрос
    setTimeout(function () {
      state.routes = searchFlightsMock(params);
      if (state.routes.length > 0) {
        state.selectedRouteId = state.routes[0].id;
      }
      renderResults();
      searchBtn.disabled = false;
      searchBtn.textContent = 'Подобрать маршруты';
    }, 500);
  });

  function renderResults() {
    if (!state.routes.length) {
      resultsBlock.style.display = 'none';
      return;
    }
    resultsBlock.style.display = 'block';
    resultsCountEl.textContent = 'Нашёл ' + state.routes.length + ' варианта под твой запрос.';
    routesListEl.innerHTML = '';
    state.routes.forEach(function (route) {
      var card = document.createElement('div');
      card.className = 'route-card' + (route.id === state.selectedRouteId ? ' selected' : '');
      card.dataset.routeId = route.id;

      var header = document.createElement('div');
      header.className = 'route-card-header';

      var left = document.createElement('div');
      var title = document.createElement('div');
      title.className = 'route-title';
      title.textContent = route.title;
      left.appendChild(title);
      left.appendChild(createTimeline(route));

      var right = document.createElement('div');
      right.className = 'route-price-block';
      var price = document.createElement('div');
      price.className = 'route-price';
      price.textContent = route.price.toLocaleString('ru-RU') + ' ' + route.currency;
      right.appendChild(price);

      var compareBtn = document.createElement('button');
      compareBtn.type = 'button';
      compareBtn.className = 'btn-ghost' + (state.compareIds.indexOf(route.id) !== -1 ? ' active' : '');
      compareBtn.textContent = state.compareIds.indexOf(route.id) !== -1 ? 'В сравнении' : 'Сравнить';
      compareBtn.addEventListener('click', function (ev) {
        ev.stopPropagation();
        toggleCompare(route.id);
      });
      right.appendChild(compareBtn);

      header.appendChild(left);
      header.appendChild(right);
      card.appendChild(header);

      var badges = document.createElement('div');
      badges.style.display = 'flex';
      badges.style.gap = '8px';
      badges.style.flexWrap = 'wrap';
      badges.style.alignItems = 'center';
      badges.style.marginTop = '4px';

      var stress = getStressLabel(route.stressScore);
      var badgeBg = stress.tone === 'low' ? '#DCFCE7' : (stress.tone === 'medium' ? '#FEF3C7' : '#FEE2E2');
      var badgeColor = stress.tone === 'low' ? '#166534' : (stress.tone === 'medium' ? '#92400E' : '#B91C1C');

      var stressEl = document.createElement('span');
      stressEl.className = 'pill';
      stressEl.style.background = badgeBg;
      stressEl.style.color = badgeColor;
      stressEl.textContent = 'Стресс ' + route.stressScore + '/10 • ' + stress.label;
      badges.appendChild(stressEl);

      route.tags.slice(0, 4).forEach(function (tag) {
        var t = document.createElement('span');
        t.className = 'pill';
        t.style.border = '1px solid #E2E8F0';
        t.style.color = '#6B7280';
        t.textContent = tag;
        badges.appendChild(t);
      });

      card.appendChild(badges);

      card.addEventListener('click', function () {
        state.selectedRouteId = route.id;
        renderResults();
      });

      routesListEl.appendChild(card);
    });

    routesActionsEl.style.display = state.routes.length ? 'block' : 'none';
    renderYuviaPanel();
    renderCompareDrawer();
  }

  function createTimeline(route) {
    var wrap = document.createElement('div');
    var first = new Date(route.segments[0].departTime);
    var last = new Date(route.segments[route.segments.length - 1].arriveTime);
    var totalMinutes = minutesBetween(first, last);

    var meta = document.createElement('div');
    meta.className = 'timeline-meta';
    meta.textContent =
      route.segments[0].fromCode + ' ' + formatTime(route.segments[0].departTime) +
      ' — ' +
      route.segments[route.segments.length - 1].toCode + ' ' + formatTime(route.segments[route.segments.length - 1].arriveTime) +
      ' • ' + Math.round(totalMinutes / 60) + ' ч';
    wrap.appendChild(meta);

    var bar = document.createElement('div');
    bar.className = 'timeline-bar';

    route.segments.forEach(function (s, idx) {
      var start = new Date(s.departTime);
      var end = new Date(s.arriveTime);
      var segMinutes = (end.getTime() - start.getTime()) / 60000;
      var width = (segMinutes / totalMinutes) * 100;

      var prevEnd = idx === 0 ? first : new Date(route.segments[idx - 1].arriveTime);
      var left = (minutesBetween(first, prevEnd) / totalMinutes) * 100;

      var segEl = document.createElement('div');
      segEl.className = 'timeline-segment';
      segEl.style.left = left + '%';
      segEl.style.width = width + '%';
      segEl.style.background = idx % 2 === 0 ? '#11A26A' : '#F97316';
      bar.appendChild(segEl);
    });

    wrap.appendChild(bar);
    return wrap;
  }

  function formatTime(iso) {
    var d = new Date(iso);
    return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
  }

  // ===== ПАНЕЛЬ Yuvia =====
  function renderYuviaPanel() {
    var route = state.routes.find(function (r) { return r.id === state.selectedRouteId; });
    yuviaPanelEl.innerHTML = '';

    var title = document.createElement('div');
    title.className = 'yuvia-panel-title';
    title.textContent = 'Yuvia рядом';
    yuviaPanelEl.appendChild(title);

    if (!route) {
      var p = document.createElement('p');
      p.style.fontSize = '14px';
      p.style.margin = '0';
      p.textContent = 'Заполни бриф слева — я подберу маршруты под твой стиль, а затем честно расскажу, чего ждать от каждого варианта. Без маркетинговой мишуры.';
      yuviaPanelEl.appendChild(p);

      var footer = document.createElement('div');
      footer.className = 'yuvia-footer';
      footer.textContent = 'В будущем здесь появится «режим дня вылета» с чек-листами и напоминаниями, а также советы, что делать, если рейс задержат.';
      yuviaPanelEl.appendChild(footer);
      return;
    }

    var bubble = document.createElement('div');
    bubble.className = 'yuvia-bubble';

    var stress = getStressLabel(route.stressScore);
    var durationHours = Math.round(route.totalDurationMinutes / 60);
    var connectionsText = route.totalConnections === 0
      ? 'без пересадок'
      : (route.totalConnections === 1 ? 'с одной пересадкой' : ('с ' + route.totalConnections + ' пересадками'));

    var intro;
    if (stress.tone === 'low') {
      intro = 'Это спокойный маршрут, без лишних приключений.';
    } else if (stress.tone === 'medium') {
      intro = 'Этот вариант балансирует между ценой и комфортом.';
    } else {
      intro = 'Этот вариант нервный, но иногда его выбирают ради цены или жёстких сроков.';
    }

    bubble.innerHTML =
      '<div style="margin-bottom:6px;">' + intro + '</div>' +
      '<div style="margin-bottom:6px;">В пути примерно <b>' + durationHours + ' ч</b>, ' + connectionsText +
      '. Стресс <b>' + route.stressScore + '/10</b> — ' + stress.label.toLowerCase() + '.</div>';

    if (route.hasAirportOvernight) {
      var warn = document.createElement('div');
      warn.style.color = '#92400E';
      warn.textContent = 'Ночёвка в аэропорту — это испытание даже для опытных путешественников. Если важно выспаться и чувствовать себя спокойно, я бы посмотрел другие варианты.';
      bubble.appendChild(warn);
    } else if (route.hasNightSegments) {
      var note = document.createElement('div');
      note.textContent = 'Есть ночной перелёт. Для кого-то это удобно, если удаётся поспать в самолёте, но если ты не любишь ночные рейсы — лучше рассмотреть дневные.';
      bubble.appendChild(note);
    }

    yuviaPanelEl.appendChild(bubble);

    if (state.searchParams) {
      var ctx = document.createElement('div');
      ctx.style.fontSize = '13px';
      ctx.innerHTML =
        '<div style="margin-bottom:4px;">Маршруты под твой запрос: <b>' +
        state.searchParams.from + ' → ' + state.searchParams.to +
        '</b>, дата вылета <b>' + state.searchParams.departDate + '</b>.</div>' +
        '<div style="color:#6B7280;">В настройках стиля ты сейчас акцентируешься на ' +
        (state.searchParams.preferences.priority === 'price'
          ? 'экономии'
          : state.searchParams.preferences.priority === 'comfort'
          ? 'комфорте и спокойствии'
          : 'балансе цены и удобства') +
        '. Это влияет на сортировку вариантов.</div>';
      yuviaPanelEl.appendChild(ctx);
    }

    var footer = document.createElement('div');
    footer.className = 'yuvia-footer';
    footer.textContent = 'В будущем здесь появится «режим дня вылета» и подсказки по каждому шагу в аэропорту.';
    yuviaPanelEl.appendChild(footer);
  }

  // ===== СРАВНЕНИЕ =====
  var compareDrawerEl = document.getElementById('compare-drawer');
  var compareListEl = document.getElementById('compare-list');
  var compareTitleEl = document.getElementById('compare-title');
  var compareCloseBtn = document.getElementById('compare-close-btn');

  compareCloseBtn.addEventListener('click', function () {
    state.compareIds = [];
    renderResults();
  });

  function toggleCompare(id) {
    var idx = state.compareIds.indexOf(id);
    if (idx === -1) {
      state.compareIds.push(id);
    } else {
      state.compareIds.splice(idx, 1);
    }
    renderResults();
  }

  function renderCompareDrawer() {
    if (!state.compareIds.length) {
      compareDrawerEl.classList.remove('active');
      return;
    }
    compareDrawerEl.classList.add('active');
    var routes = state.routes.filter(function (r) { return state.compareIds.indexOf(r.id) !== -1; });
    compareTitleEl.textContent = 'Сравнение маршрутов (' + routes.length + ')';
    compareListEl.innerHTML = '';
    routes.forEach(function (r) {
      var card = document.createElement('div');
      card.className = 'compare-card';
      card.innerHTML =
        '<div style="font-weight:500;margin-bottom:4px;">' + r.title + '</div>' +
        '<div style="font-size:12px;color:#6B7280;">' +
        (r.totalConnections === 0 ? 'Без пересадок' : (r.totalConnections + ' пересад.')) +
        ' • ' + Math.round(r.totalDurationMinutes / 60) + ' ч в пути</div>' +
        '<div style="margin-top:6px;"><b>' + r.price.toLocaleString('ru-RU') + '</b> ' + r.currency + '</div>' +
        '<div style="margin-top:4px;font-size:12px;">Стресс: <b>' + r.stressScore + '/10</b></div>';
      compareListEl.appendChild(card);
    });
  }

  // ===== СОХРАНЁННЫЙ TRIP =====
  var tripBarEl = document.getElementById('trip-bar');
  var tripTitleEl = document.getElementById('trip-title');
  var tripSubEl = document.getElementById('trip-sub');
  var tripPriceEl = document.getElementById('trip-price');

  var TRIP_KEY = 'yuvia_last_trip_singlefile_v1';

  function loadTrip() {
    try {
      var raw = localStorage.getItem(TRIP_KEY);
      if (!raw) return;
      state.savedTrip = JSON.parse(raw);
      renderTripBar();
    } catch (e) {}
  }

  function saveTrip(trip) {
    state.savedTrip = trip;
    try {
      localStorage.setItem(TRIP_KEY, JSON.stringify(trip));
    } catch (e) {}
    renderTripBar();
  }

  function renderTripBar() {
    if (!state.savedTrip) {
      tripBarEl.classList.remove('active');
      return;
    }
    var t = state.savedTrip;
    var route = t.route;
    tripBarEl.classList.add('active');
    tripTitleEl.textContent = 'Сохранённый маршрут поездки • ' + t.searchParams.from + ' → ' + t.searchParams.to;
    tripSubEl.textContent = route.title + ' • ' + Math.round(route.totalDurationMinutes / 60) + ' ч в пути • стресс ' + route.stressScore + '/10';
    tripPriceEl.textContent = route.price.toLocaleString('ru-RU') + ' ' + route.currency;
  }

  loadTrip();

  // кнопки «детали» и «сохранить»
  document.getElementById('details-btn').addEventListener('click', function () {
    var route = state.routes.find(function (r) { return r.id === state.selectedRouteId; });
    if (!route) return;
    openModal(route);
  });

  document.getElementById('save-trip-btn').addEventListener('click', function () {
    if (!state.searchParams) return;
    var route = state.routes.find(function (r) { return r.id === state.selectedRouteId; });
    if (!route) return;
    var trip = {
      id: 'trip-' + Date.now(),
      createdAt: new Date().toISOString(),
      searchParams: state.searchParams,
      route: route
    };
    saveTrip(trip);
  });

  // ===== МОДАЛЬНЫЕ ДЕТАЛИ =====
  var modalBackdropEl = document.getElementById('modal-backdrop');
  var modalSubtitleEl = document.getElementById('modal-subtitle');
  var modalSegmentsEl = document.getElementById('modal-segments');
  var modalCloseBtn = document.getElementById('modal-close-btn');

  modalCloseBtn.addEventListener('click', closeModal);
  modalBackdropEl.addEventListener('click', function (e) {
    if (e.target === modalBackdropEl) closeModal();
  });

  function openModal(route) {
    modalSubtitleEl.textContent = route.title;
    modalSegmentsEl.innerHTML = '';
    route.segments.forEach(function (s, idx) {
      var card = document.createElement('div');
      card.className = 'segment-card';
      card.innerHTML =
        '<div style="display:flex;justify-content:space-between;font-size:14px;font-weight:500;margin-bottom:4px;">' +
        '<span>' + s.fromCode + ' → ' + s.toCode + '</span>' +
        '<span>' + formatDate(s.departTime) + ' • ' + formatTime(s.departTime) + ' — ' + formatTime(s.arriveTime) + '</span>' +
        '</div>' +
        '<div style="font-size:13px;">' + s.airline + ' • рейс ' + s.flightNumber + '</div>' +
        '<div style="font-size:12px;color:#6B7280;margin-top:4px;">' +
        (s.baggageIncluded ? 'Багаж включён' : (s.handLuggageOnly ? 'Только ручная кладь' : 'Уточните условия багажа')) +
        ' • В аэропорт рекомендую выезжать минимум за 2–2,5 часа до вылета.' +
        (idx === 0 ? ' Онлайн-регистрация обычно открывается за 24 часа — можно будет выбрать места.' : '') +
        '</div>';
      modalSegmentsEl.appendChild(card);
    });
    modalBackdropEl.classList.add('active');
  }

  function closeModal() {
    modalBackdropEl.classList.remove('active');
  }

  function formatDate(iso) {
    var d = new Date(iso);
    return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
  }
</script>
</body>
</html>
