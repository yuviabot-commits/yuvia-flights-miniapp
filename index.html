<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yuvia Flights Mini App</title>
  <link rel="preconnect" href="https://autocomplete.travelpayouts.com">
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --accent:#0369a1; --accent-fg:#fff; --chip:#f1f5f9;
      --disabled:#f8fafc;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:24px;}
    h1{font-size:32px;margin:8px 0 16px}
    .badge{display:inline-block;padding:6px 10px;border-radius:10px;background:#e8f5e9;color:#166534;font-weight:600}
    .card{border:1px solid var(--line);border-radius:12px;padding:20px;margin:18px 0}
    .grid{display:grid;gap:14px}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} .grid-4{grid-template-columns:repeat(4,1fr)} }
    label{font-size:14px;color:var(--muted);margin-bottom:6px;display:block}
    input,select,button{font-size:16px}
    input[type="text"], input[type="date"], select{
      width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:10px;outline:none;background:#fff;
    }
    input[disabled]{background:var(--disabled);cursor:not-allowed}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{padding:14px 18px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-fg);border-color:var(--accent)}
    .btn.ghost{background:#fff}
    .hint{color:var(--muted);font-size:14px;margin-top:8px}
    .chip{display:inline-block;background:var(--chip);padding:6px 10px;border-radius:999px;margin-right:8px;margin-top:8px;font-size:14px}
    .error{color:#b91c1c;font-size:14px;margin-top:6px}
    .divider{height:1px;background:var(--line);margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Yuvia Flights Mini App</h1>
    <span class="badge">Шаг 1: репозиторий готов ✅</span>

    <div class="card">
      <div class="hint">Шаг 2: заполните параметры — откроем поиск на Aviasales в новой вкладке.</div>
      <div class="grid grid-2" style="margin-top:10px">
        <div>
          <label>Город вылета</label>
          <input id="origin_city" type="text" placeholder="Москва" value="Москва" autocomplete="off">
        </div>
        <div>
          <label>Город назначения</label>
          <input id="dest_city" type="text" placeholder="Казань" value="Казань" autocomplete="off">
        </div>
        <div>
          <label>Дата вылета</label>
          <input id="dep_date" type="date">
        </div>
        <div>
          <label>Дата возвращения (опционально)</label>
          <input id="ret_date" type="date">
        </div>
        <div>
          <label>Валюта</label>
          <select id="currency">
            <option value="rub" selected>RUB ₽</option>
            <option value="usd">USD $</option>
            <option value="eur">EUR €</option>
          </select>
        </div>
        <div>
          <label>Пассажиры</label>
          <select id="adults">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div>
          <label>Только в одну сторону</label>
          <select id="one_way">
            <option value="no" selected>Нет</option>
            <option value="yes">Да</option>
          </select>
        </div>
        <div>
          <label>Гибкие даты</label>
          <select id="flex_mode">
            <option value="none" selected>Без гибких дат</option>
            <option value="weekend_next">Ближайшие выходные (СБ–ВС)</option>
          </select>
          <div id="flex_hint" class="hint"></div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button id="searchBtn" class="btn primary">Искать билеты</button>
        <button id="swapBtn" class="btn">Поменять местами</button>
        <button id="copyBtn" class="btn">Скопировать ссылку</button>
      </div>
      <div id="error" class="error" style="display:none"></div>

      <div class="divider"></div>
      <div id="recentWrap">
        <div class="hint">Недавние запросы (до 5):</div>
        <div id="recent" class="row"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== Настройки партнёрки ======
    const MARKER = 672309; // твой Partner ID
    const UTM = 'yuvia_miniapp';

    // ====== Даты ======
    const pad2 = n => (n<10?'0':'') + n;
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const toISO = d => d ? `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}` : '';
    const toDDMM = d => d ? `${pad2(d.getDate())}${pad2(d.getMonth()+1)}` : '';

    // Следующие ПОЛНЫЕ выходные: СБ–ВС после указанной даты
    function weekendNextSatSun(date){
      const d = new Date(date);
      const day = d.getDay();              // 0=вс,1=пн,...,6=сб
      let deltaToSat;
      if (day === 6) deltaToSat = 7;       // сегодня суббота -> следующая суббота
      else if (day === 0) deltaToSat = 6;  // сегодня воскресенье -> следующая суббота
      else deltaToSat = 6 - day;           // будни -> ближайшая будущая суббота
      const sat = addDays(d, deltaToSat);
      const sun = addDays(sat, 1);
      return { depart: sat, ret: sun };
    }

    // ====== DOM ======
    const originInput = document.getElementById('origin_city');
    const destInput   = document.getElementById('dest_city');
    const depInput    = document.getElementById('dep_date');
    const retInput    = document.getElementById('ret_date');
    const oneWaySel   = document.getElementById('one_way');
    const flexSelect  = document.getElementById('flex_mode');
    const flexHint    = document.getElementById('flex_hint');
    const errBox      = document.getElementById('error');

    // Минимальная дата = сегодня
    const todayISO = toISO(new Date());
    depInput.min = todayISO;
    retInput.min = todayISO;

    function showError(msg){ errBox.textContent = msg; errBox.style.display='block'; }
    function hideError(){ errBox.style.display='none'; errBox.textContent=''; }

    // ====== Гибкие даты ======
    function applyFlex(){
      const mode = flexSelect.value;
      flexHint.textContent = '';
      if (mode === 'weekend_next'){
        const w = weekendNextSatSun(new Date());
        depInput.value = toISO(w.depart);
        depInput.min = todayISO;
        if (oneWaySel.value === 'yes') {
          // one-way: только суббота
          retInput.value = '';
          retInput.disabled = true;
          flexHint.textContent = `Ближайшая суббота: ${pad2(w.depart.getDate())}.${pad2(w.depart.getMonth()+1)}`;
        } else {
          retInput.disabled = false;
          retInput.value = toISO(w.ret);
          retInput.min = depInput.value || todayISO;
          flexHint.textContent = `Ближайшие выходные: ${pad2(w.depart.getDate())}.${pad2(w.depart.getMonth()+1)} — ${pad2(w.ret.getDate())}.${pad2(w.ret.getMonth()+1)}`;
        }
      }
    }
    flexSelect.addEventListener('change', applyFlex);

    // ====== Переключение one-way ======
    function applyOneWayState(){
      if (oneWaySel.value === 'yes'){
        // просто отключаем возвращение, НИЧЕГО не стираем в городах
        retInput.disabled = true;
      } else {
        retInput.disabled = false;
        // если даты возврата нет, поставим +3 дня от вылета
        if (!retInput.value && depInput.value){
          const d = addDays(new Date(depInput.value), 3);
          retInput.value = toISO(d);
        }
      }
    }
    oneWaySel.addEventListener('change', ()=>{
      applyOneWayState();
      // при смене one-way, если включён режим выходных — заново применим логику
      if (flexSelect.value === 'weekend_next') applyFlex();
    });

    // При изменении даты вылета подтянем min для возврата
    depInput.addEventListener('change', ()=>{
      retInput.min = depInput.value || todayISO;
      if (oneWaySel.value === 'no' && retInput.value && retInput.value < depInput.value){
        retInput.value = depInput.value; // мягкая коррекция
      }
    });

    // ====== IATA ======
    async function cityToIata(city){
      const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(city)}&locale=ru&types[]=city`;
      const res = await fetch(url);
      const data = await res.json();
      const item = (data||[]).find(x => x.type === 'city' && x.code);
      return item ? item.code : null;
    }

    // ====== Диплинк Aviasales ======
    function aviasalesLink({originIata, destIata, dep, ret, oneWay, adults, currency}){
      const slug = originIata + toDDMM(dep) + destIata + (oneWay ? '' : toDDMM(ret));
      const params = new URLSearchParams({
        marker: MARKER,
        with_request: 'true',
        adults: String(adults || 1),
        currency: (currency || 'rub').toLowerCase(),
        utm_source: UTM
      });
      return `https://www.aviasales.ru/search/${slug}?${params.toString()}`;
    }

    // ====== Недавние запросы ======
    const RECENT_KEY = 'yuvia_recent';
    function saveRecent(item){
      try{
        const list = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
        list.unshift(item);
        const uniques = [];
        const seen = new Set();
        for(const x of list){
          const key = JSON.stringify([x.oCity,x.dCity,x.dep,x.ret,x.oneWay,x.adults,x.currency]);
          if (!seen.has(key)){ seen.add(key); uniques.push(x); }
          if (uniques.length>=5) break;
        }
        localStorage.setItem(RECENT_KEY, JSON.stringify(uniques));
        renderRecent();
      }catch(e){}
    }
    function renderRecent(){
      const box = document.getElementById('recent');
      box.innerHTML = '';
      try{
        const list = JSON.parse(localStorage.getItem(RECENT_KEY)||'[]');
        for(const x of list){
          const b = document.createElement('button');
          b.className='chip';
          const dd = x.dep ? x.dep.split('-').reverse().join('.') : '';
          const rr = x.ret ? x.ret.split('-').reverse().join('.') : '';
          b.textContent = `${x.oCity} → ${x.dCity} • ${dd}${x.oneWay==='yes'?'':' — '+rr}`;
          b.addEventListener('click', ()=>{
            originInput.value = x.oCity;
            destInput.value = x.dCity;
            depInput.value = x.dep || '';
            retInput.value = x.ret || '';
            oneWaySel.value = x.oneWay || 'no';
            document.getElementById('adults').value = x.adults || '1';
            document.getElementById('currency').value = x.currency || 'rub';
            applyOneWayState();
          });
          box.appendChild(b);
        }
      }catch(e){}
    }

    // ====== Кнопки ======
    document.getElementById('swapBtn').addEventListener('click', ()=>{
      [originInput.value, destInput.value] = [destInput.value, originInput.value];
    });

    async function buildLinkFromForm(){
      hideError();
      const oCity = originInput.value.trim();
      const dCity = destInput.value.trim();
      const oneWay = oneWaySel.value;
      const adults = document.getElementById('adults').value;
      const currency = document.getElementById('currency').value;

      if (!oCity || !dCity){ showError('Введите города вылета и назначения.'); return null; }

      // даты
      const dep = depInput.value ? new Date(depInput.value) : null;
      const ret = retInput.value ? new Date(retInput.value) : null;

      if (!dep){ showError('Укажите дату вылета.'); return null; }
      if (oneWay === 'no' && !ret){ showError('Укажите дату возвращения или включите режим "в одну сторону".'); return null; }
      if (oneWay === 'no' && ret < dep){ showError('Дата возвращения должна быть не раньше даты вылета.'); return null; }

      // IATA
      const [originIata, destIata] = await Promise.all([cityToIata(oCity), cityToIata(dCity)]);
      if (!originIata || !destIata){ showError('Не удалось распознать города. Попробуйте указать точнее.'); return null; }

      const url = aviasalesLink({
        originIata, destIata,
        dep, ret: ret || dep,
        oneWay: oneWay === 'yes',
        adults, currency
      });

      saveRecent({
        oCity, dCity, dep: toISO(dep), ret: toISO(ret),
        oneWay, adults, currency
      });

      return url;
    }

    document.getElementById('searchBtn').addEventListener('click', async ()=>{
      const url = await buildLinkFromForm();
      if (url) window.open(url, '_blank');
    });

    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const url = await buildLinkFromForm();
      if (!url) return;
      try{
        await navigator.clipboard.writeText(url);
        alert('Ссылка скопирована!');
      }catch(e){
        prompt('Скопируйте ссылку вручную:', url);
      }
    });

    // ====== Инициализация ======
    function initDefaultDates(){
      // стартуем с «Ближайшие выходные»
      flexSelect.value = 'weekend_next';
      applyFlex();
      applyOneWayState();
      // синхронизируем min возврата
      retInput.min = depInput.value || todayISO;
    }

    initDefaultDates();
    renderRecent();
  </script>
</body>
</html>
