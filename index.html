<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Yuvia · Поиск авиабилетов</title>
    <!-- Иконка вкладки -->
    <link rel="icon" type="image/png" href="favicon.png" sizes="256x256" />
    <link rel="shortcut icon" type="image/png" href="favicon.png" />
    <style>
      :root {
        --bg: #ffffff;
        --surface: #ffffff;
        --ink: #053227;
        --muted: #6b7280;
        --accent: #075e54;
        --accent-soft: #e3f3ee;
        --accent-soft-2: #fff7e3;
        --berry: #b1365b;
        --sun: #f6c453;
        --danger: #dc2626;
        --ok: #16a34a;
        --line: #e2e8f0;
        --shadow-soft: 0 18px 45px rgba(7, 94, 84, 0.1);
        --radius-lg: 18px;
        --radius-pill: 999px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font:
          15px/1.5 system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          Inter,
          Arial,
          sans-serif;
        color: var(--ink);
        background: var(--bg);
      }
      .wrap {
        max-width: 1140px;
        margin: 0 auto;
        padding: 18px 16px 32px;
      }
      .screen-back {
        display: flex;
        align-items: center;
        margin: 8px 0 16px;
      }
      .suggest-wrapper {
        position: relative;
      }
      .suggest-panel {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 4px);
        z-index: 10;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: #ffffff;
        box-shadow: var(--shadow-soft);
        max-height: 240px;
        overflow-y: auto;
      }
      .suggest-panel.hidden {
        display: none;
      }
      .suggest-item {
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        cursor: pointer;
      }
      .suggest-item:last-child {
        border-bottom: none;
      }
      .suggest-item strong {
        font-size: 14px;
      }
      .suggest-item span {
        font-size: 12px;
        color: var(--muted);
      }
      .suggest-empty {
        padding: 10px 14px;
        font-size: 13px;
        color: var(--muted);
      }
      .card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: var(--shadow-soft);
        padding: 14px 18px;
      }
      #searchForm {
        background: #f3faf8;
        border-color: rgba(7, 94, 84, 0.18);
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      input,
      select,
      button {
        font: inherit;
        border-radius: 12px;
        border: 1px solid var(--line);
        padding: 10px 12px;
        background: #ffffff;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: rgba(34, 197, 133, 0.9);
        box-shadow: 0 0 0 1px rgba(34, 197, 133, 0.4);
      }
      button {
        cursor: pointer;
        border-radius: var(--radius-pill);
        border: 1px solid transparent;
        padding: 10px 18px;
        background: var(--accent);
        color: #f9fafb;
        font-weight: 500;
        white-space: nowrap;
      }
      .btn-primary {
        background: linear-gradient(135deg, #075e54, #0f766e);
        color: #f9fafb;
        box-shadow: 0 10px 25px rgba(7, 94, 84, 0.35);
      }
      .btn-primary:hover {
        background: linear-gradient(135deg, #064e3b, #0d6b60);
      }
      .btn-secondary {
        background: var(--accent-soft);
        color: var(--accent);
        border-color: rgba(45, 212, 191, 0.6);
      }
      .btn-ghost {
        background: transparent;
        color: var(--accent);
        border-color: rgba(148, 163, 184, 0.6);
      }
      .btn-sm {
        padding: 6px 10px;
        font-size: 13px;
        border-radius: 999px;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
        margin-top: 3px;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .section-title {
        margin: 18px 0 10px;
        font-weight: 600;
        font-size: 16px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border-radius: var(--radius-pill);
        padding: 7px 11px;
        background: rgba(177, 54, 91, 0.08);
        color: #7a1238;
        border: 1px solid rgba(177, 54, 91, 0.35);
        font-size: 13px;
        cursor: pointer;
      }
      .chip#summaryChip {
        background: var(--accent-soft);
        color: var(--accent);
        border-color: rgba(45, 212, 191, 0.45);
        cursor: default;
      }
      .divider {
        height: 1px;
        margin: 14px 0 10px;
        background: linear-gradient(
          90deg,
          rgba(148, 163, 184, 0.3),
          rgba(148, 163, 184, 0)
        );
      }
      .two-col {
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr);
        gap: 16px;
        margin-top: 12px;
      }
      .filters-block .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: var(--radius-pill);
        border: 1px solid var(--line);
        font-size: 13px;
        background: #f9fafb;
      }
      .filters-block .pill input {
        width: auto;
        padding: 0;
        border: none;
        box-shadow: none;
      }
      .toolbar {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--surface);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: var(--radius-pill);
        padding: 8px 11px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .toolbar select {
        border-radius: 999px;
        padding: 7px 14px;
      }
      .topblock {
        margin-top: 12px;
        margin-bottom: 12px;
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(18px);
      }
      .topblock-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 10px;
      }
      .topblock-title {
        font-size: 16px;
        font-weight: 600;
      }
      .topblock-subtitle {
        font-size: 13px;
        color: var(--muted);
      }
      .topblock-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }
      .topcard {
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 10px 12px;
        background: linear-gradient(135deg, rgba(7, 94, 84, 0.02), rgba(7, 94, 84, 0.12));
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .topcard-main {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
      }
      .topcard-route {
        font-size: 14px;
        font-weight: 600;
      }
      .topcard-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .topcard-price {
        font-weight: 600;
        font-size: 15px;
      }
      .topcard-meta {
        font-size: 12px;
        color: var(--muted);
      }
      .topcard-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
      }
      .topcard button.btn-sm {
        font-size: 12px;
      }
      .matrix-calendar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 8px;
        margin-top: 4px;
      }
      .matrix-day {
        border-radius: 14px;
        padding: 8px 10px;
        background: rgba(15, 23, 42, 0.02);
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 12px;
        cursor: pointer;
        transition:
          transform 0.12s ease,
          box-shadow 0.12s ease,
          border-color 0.12s ease,
          background 0.12s ease;
      }
      .matrix-day:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
        border-color: rgba(7, 94, 84, 0.5);
      }
      .matrix-day__date {
        font-weight: 500;
        margin-bottom: 2px;
      }
      .matrix-day__price {
        font-size: 13px;
      }
      .matrix-day.cheapest {
        background: linear-gradient(135deg, rgba(7, 94, 84, 0.06), rgba(7, 94, 84, 0.18));
        border-color: rgba(7, 94, 84, 0.75);
      }
      .matrix-day.selected {
        outline: 2px solid rgba(56, 189, 248, 0.9);
      }
      .result {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 16px 18px;
        margin-bottom: 12px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 14px 40px rgba(15, 23, 42, 0.08);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }
      .result:hover {
        transform: translateY(-2px);
        box-shadow: 0 24px 55px rgba(15, 23, 42, 0.14);
      }
      .result.result-highlight {
        box-shadow:
          0 0 0 2px rgba(56, 189, 248, 0.85),
          0 24px 55px rgba(15, 23, 42, 0.25);
      }
      .result-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .result-route {
        font-size: 18px;
        font-weight: 600;
      }
      .result-dates {
        font-size: 13px;
        color: var(--muted);
      }
      .result-price-block {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .result-price-block .price {
        font-size: 20px;
        font-weight: 700;
      }
      .airline-logo-wrap {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .airline-logo {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--accent);
      }
      .result-segments {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 6px;
      }
      .segment {
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 10px 12px;
        background: rgba(15, 23, 42, 0.02);
      }
      .segment-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .segment-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr)) minmax(130px, 1fr);
        gap: 10px;
        align-items: center;
      }
      .segment-row > div {
        min-width: 0;
      }
      .segment-time {
        font-size: 20px;
        font-weight: 600;
      }
      .segment-city {
        font-size: 14px;
        font-weight: 500;
      }
      .segment-airport,
      .segment-date {
        font-size: 12px;
        color: var(--muted);
      }
      .segment-col-middle {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
      }
      .segment-middle-top {
        font-weight: 600;
        font-size: 13px;
        color: var(--ink);
      }
      .segment-middle-bottom {
        font-size: 12px;
        color: var(--muted);
      }
      .segment-line {
        height: 4px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(7, 94, 84, 0.2), rgba(7, 94, 84, 0.05));
        margin: 4px 0;
      }
      .result-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 9px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: #f9fafb;
        color: #111827;
      }
      .badge-rating {
        background: #ecfdf3;
        border-color: rgba(16, 185, 129, 0.6);
        color: #047857;
        font-weight: 600;
      }
      .badge-stress-low {
        background: #ecfdf3;
        border-color: rgba(16, 185, 129, 0.6);
        color: #047857;
      }
      .badge-stress-medium {
        background: #fff7ed;
        border-color: rgba(251, 191, 36, 0.7);
        color: #92400e;
      }
      .badge-stress-high {
        background: #fef2f2;
        border-color: rgba(248, 113, 113, 0.7);
        color: #b91c1c;
      }
      .badge-chip {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #4b5563;
      }
      .badge-yuvia {
        background: linear-gradient(135deg, rgba(7, 94, 84, 0.1), rgba(13, 148, 136, 0.25));
        border-color: rgba(13, 148, 136, 0.7);
        color: #064e3b;
        box-shadow: 0 6px 18px rgba(13, 148, 136, 0.35);
        font-weight: 600;
      }
      .result-footer {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: flex-start;
        border-top: 1px dashed #e5e7eb;
        padding-top: 8px;
        margin-top: 4px;
        font-size: 13px;
        color: var(--muted);
        flex-wrap: wrap;
      }
      .result-footer strong {
        color: var(--ink);
      }
      .result-footer-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }
      .bad {
        color: var(--danger);
      }
      .ok {
        color: var(--ok);
      }
      .skeleton {
        height: 62px;
        border-radius: 12px;
        background: linear-gradient(
          90deg,
          #f4f7fb 25%,
          #edf2f7 37%,
          #f4f7fb 63%
        );
        background-size: 200% 100%;
        animation: sh 1.1s ease-in-out infinite;
      }
      @keyframes sh {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      } /* Бренд в шапке */
      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 12px;
      }
      .brand-logo {
        width: 72px;
        height: auto;
      }
      .brand-name {
        font-size: 26px;
        font-weight: 650;
        letter-spacing: 0.03em;
      }
      .brand-tagline {
        font-size: 13px;
        color: var(--muted);
      }
      .brand-subline {
        font-size: 13px;
        color: var(--berry);
        text-transform: none;
        letter-spacing: 0.06em;
        margin-top: 4px;
        font-weight: 500;
      }
      .search-summary {
        margin: 0 0 16px;
        padding: 10px 14px;
        border-radius: 14px;
        background: linear-gradient(
          135deg,
          rgba(7, 94, 84, 0.08),
          rgba(13, 148, 136, 0.14)
        );
        color: #0f4f43;
        font-size: 14px;
        box-shadow: 0 10px 24px rgba(7, 94, 84, 0.08);
      }
      .advanced-header {
        margin: 4px 0 10px;
      }
      .advanced-title {
        font-size: 15px;
        font-weight: 600;
      }
      .advanced-subtitle {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }
      .advanced-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        margin: 8px 0 6px;
      }
      .chip-filter {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: var(--radius-pill);
        padding: 6px 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: #ffffff;
        font-size: 13px;
        cursor: pointer;
        transition:
          box-shadow 0.18s ease,
          border-color 0.18s ease,
          background 0.18s ease,
          color 0.18s ease;
      }
      .chip-filter:hover {
        border-color: rgba(7, 94, 84, 0.4);
        box-shadow: 0 8px 20px rgba(7, 94, 84, 0.12);
      }
      .chip-active {
        background: var(--accent-soft);
        border-color: rgba(45, 212, 191, 0.7);
        color: var(--accent);
        box-shadow: 0 10px 22px rgba(13, 148, 136, 0.18);
      }
      .advanced-airports-panel {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px dashed var(--line);
        background: #f9fafb;
      }
      .advanced-airports-panel select {
        width: 100%;
      }
      .advanced-footer {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .advanced-hint {
        font-size: 13px;
        color: var(--muted);
        margin-top: 6px;
      }
      .advanced.hidden {
        display: none;
      } /* ------- Форма поиска ------- */
      .search-grid input,
      .pax-trigger {
        height: 48px;
        padding-top: 9px;
        padding-bottom: 9px;
      }
      .search-grid {
        display: grid;
        grid-template-columns: 1.25fr 52px 1.25fr 0.9fr 0.9fr 1.05fr;
        grid-auto-rows: auto;
        column-gap: 14px;
        row-gap: 4px;
        align-items: start;
      }
      .search-grid .label {
        margin: 0;
        align-self: end;
      }
      .search-grid .hint {
        margin: 0;
        align-self: start;
        font-size: 12px;
      }
      .pax-hint-placeholder {
        min-height: 16px;
        font-size: 12px;
        align-self: start;
      }
      .swap-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateX(-10px);
      }
      .swap-cell--full {
      }
      .swap-btn {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        border: 1px solid rgba(7, 94, 84, 0.18);
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
        color: #075e54;
        box-shadow: 0 6px 18px rgba(7, 94, 84, 0.2);
        cursor: pointer;
        padding: 0;
      }
      .swap-btn:hover {
        background: #ecfdf5;
      }
      .search-actions-row {
        margin-top: 14px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .trip-preferences {
        margin-top: 16px;
        border: 1px solid rgba(7, 94, 84, 0.12);
        border-radius: 16px;
        padding: 16px;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      .trip-preferences .label {
        font-weight: 600;
        font-size: 14px;
        color: #064e3b;
        margin-bottom: 6px;
      }
      .trip-style,
      .trip-triggers {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .chips-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip-toggle {
        border-radius: var(--radius-pill);
        border: 1px solid rgba(7, 94, 84, 0.25);
        background: #ffffff;
        color: var(--ink);
        padding: 8px 14px;
        font-size: 14px;
        box-shadow: 0 6px 16px rgba(7, 94, 84, 0.08);
        transition:
          background 0.2s,
          color 0.2s,
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .chip-toggle:hover {
        border-color: rgba(7, 94, 84, 0.5);
      }
      .chip-toggle.active {
        background: var(--accent);
        color: #f9fafb;
        border-color: var(--accent);
        box-shadow: 0 10px 20px rgba(7, 94, 84, 0.25);
      }
      .chip-style {
        min-width: 0;
        white-space: normal;
        text-align: center;
      } /* Пассажиры */
      .pax-field {
        position: relative;
      }
      .pax-trigger {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--line);
        padding: 6px 34px 6px 12px;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        cursor: pointer;
        position: relative;
        color: var(--ink);
      }
      .pax-main {
        font-size: 13px;
        font-weight: 600;
      }
      .pax-sub {
        font-size: 10px;
        color: #9ca3af;
        margin-top: 1px;
      }
      .pax-chevron {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 13px;
        color: var(--muted);
      }
      .pax-panel {
        position: absolute;
        right: 0;
        margin-top: 6px;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
        padding: 14px 18px 12px;
        width: 280px;
        z-index: 50;
      }
      .pax-panel.hidden {
        display: none;
      }
      .pax-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .pax-label-wrap {
        max-width: 60%;
      }
      .pax-title {
        font-size: 14px;
        font-weight: 500;
      }
      .pax-note {
        font-size: 12px;
        color: var(--muted);
        margin-top: 2px;
      }
      .pax-counter {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pax-btn {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
        color: var(--accent);
        padding: 0;
      }
      .pax-count {
        width: 18px;
        text-align: center;
        font-weight: 500;
      }
      .pax-cabin {
        margin-top: 8px;
        border-radius: 999px;
        border: 1px solid var(--line);
        display: grid;
        grid-template-columns: 1fr 1fr;
        overflow: hidden;
      }
      .pax-cabin-btn {
        border: none;
        border-radius: 0;
        padding: 8px 4px;
        font-size: 13px;
        background: #f9fafb;
        color: var(--muted);
      }
      .pax-cabin-btn.active {
        background: var(--accent);
        color: #ffffff;
      } /* Избранные и сравнение */
      .favorites-block,
      .compare-block {
        margin-bottom: 10px;
        background: #f9fafb;
        border-style: dashed;
        border-color: #d1d5db;
      }
      .favorites-list,
      .compare-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 6px;
      }
      .mini-flight {
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        padding: 8px 10px;
        font-size: 13px;
        min-width: 180px;
        cursor: pointer;
      }
      .mini-flight:hover {
        border-color: var(--accent);
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
      }
      .mini-flight-title {
        font-weight: 600;
        margin-bottom: 2px;
      }
      .mini-flight-meta {
        font-size: 12px;
        color: var(--muted);
      }
      .hidden {
        display: none !important;
      } /* Модалка сравнения */
      .compare-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 998;
      }
      .compare-modal {
        background: #ffffff;
        border-radius: 18px;
        padding: 16px 20px;
        max-width: 760px;
        width: 100%;
        box-shadow: 0 28px 70px rgba(15, 23, 42, 0.55);
      }
      .compare-modal h3 {
        margin: 0 0 10px;
        font-size: 18px;
      }
      .compare-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      .compare-table th,
      .compare-table td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        white-space: nowrap;
      }
      .compare-table th {
        font-weight: 600;
        color: #4b5563;
      }
      .compare-close {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
      }
      @media (max-width: 900px) {
        .two-col {
          grid-template-columns: 1fr;
        }
        .search-grid {
          grid-template-columns: 1fr;
        }
        .swap-cell {
          justify-content: flex-start;
        }
        .search-actions-row {
          justify-content: flex-start;
          flex-wrap: wrap;
        }
        .pax-panel {
          right: auto;
          left: 0;
        }
        .result-main {
          grid-template-columns: 1fr;
          align-items: flex-start;
        }
        .result-main-right {
          align-items: flex-start;
          text-align: left;
        }
        .result-footer {
          flex-direction: column;
          align-items: flex-start;
        }
        .result-footer-actions {
          justify-content: flex-start;
        }
        .compare-modal {
          margin: 0 10px;
        }
        .compare-table {
          font-size: 12px;
        }
      } /* overlay загрузки */
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: #ffffff;
        backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .loading-overlay.hidden {
        display: none;
      }
      .loading-inner {
        text-align: center;
      }
      .loading-logo-wrap {
        position: relative;
        display: inline-block;
        max-width: 260px;
        width: 100%;
        margin: 0 auto;
        animation: logo-float 3s ease-in-out infinite;
      }
      .loading-logo-video {
        display: block;
        max-width: 260px;
        max-height: 40vh;
        width: 100%;
        height: auto;
        border-radius: 24px;
      }
      .loading-logo-wrap::before {
        content: "";
        position: absolute;
        left: 10%;
        right: 10%;
        bottom: -10px;
        height: 18px;
        border-radius: 999px;
        background: radial-gradient(
          ellipse at center,
          rgba(7, 94, 84, 0.45),
          transparent 60%
        );
        filter: blur(8px);
        opacity: 0.75;
        animation: glow-pulse 2.2s ease-in-out infinite;
      }
      @keyframes logo-float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }
      @keyframes glow-pulse {
        0%,
        100% {
          transform: scaleX(1);
          opacity: 0.6;
        }
        50% {
          transform: scaleX(1.12);
          opacity: 0.9;
        }
      }
      .loading-text {
        margin-top: 14px;
        font-size: 16px;
        color: var(--muted);
      }
      .version {
        position: fixed;
        bottom: 8px;
        right: 10px;
        font-size: 12px;
        color: #64748b;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 4px 7px;
        z-index: 990;
      }
      .yuvia-screen.hidden {
        display: none;
      }
      .yuvia-screen {
        position: relative;
      }
      .hub-grid,
      .hub-mood-grid {
        display: grid;
        gap: 1.5rem;
      }
      .hub-grid {
        margin-block: 1.5rem 2rem;
      }
      .hub-card,
      .hub-mood-card {
        background: rgba(255, 255, 255, 0.88);
        border-radius: 24px;
        padding: 1.5rem;
        box-shadow: 0 20px 45px rgba(5, 50, 39, 0.08);
        backdrop-filter: blur(10px);
        transition:
          transform 0.25s ease,
          box-shadow 0.25s ease;
        cursor: pointer;
      }
      .hub-card:hover,
      .hub-mood-card:hover {
        transform: scale(1.02);
        box-shadow: 0 25px 60px rgba(5, 50, 39, 0.15);
      }
      .hub-mood-card h4 {
        margin: 0;
      }
      .hub-intro {
        margin-block: 1.5rem 2rem;
      }
      .hub-mood {
        margin-top: 2rem;
      }
      .hub-mood-grid {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .hub-grid {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
      @media (min-width: 900px) {
        .hub-grid,
        .hub-mood-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
    </style>
    <!-- НОВЫЕ СТИЛИ карточки (перекрывают старые) -->
    <style>
      .result {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 14px 18px 12px;
        margin-bottom: 10px;
        border-radius: 18px;
        border: 1px solid var(--line);
        background: #ffffff;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
        transition:
          box-shadow 0.16s ease,
          transform 0.16s ease,
          border-color 0.16s ease;
      }
      .result:hover {
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
        transform: translateY(-1px);
        border-color: rgba(7, 94, 84, 0.22);
      }
      .result.highlighted {
        box-shadow:
          0 0 0 2px rgba(56, 189, 248, 0.85),
          0 20px 45px rgba(15, 23, 42, 0.25);
        transform: translateY(-1px);
      }
      .result-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: flex-start;
      }
      .result-route {
        font-size: 16px;
        font-weight: 600;
      }
      .result-dates {
        margin-top: 2px;
        font-size: 13px;
        color: var(--muted);
      }
      .result-price-block {
        min-width: 170px;
        text-align: right;
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end;
      }
      .airline-logo-wrap {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .airline-logo {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: var(--accent);
      }
      .airline-logo img {
        width: 70%;
        height: 70%;
        object-fit: contain;
        display: block;
      }
      .result-segments {
        border-radius: 14px;
        background: #f9fafb;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .segment-label {
        font-size: 12px;
        font-weight: 600;
        color: #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 2px;
      }
      .segment-row {
        display: grid;
        grid-template-columns: 1.05fr minmax(0, 1.1fr) 1.05fr;
        column-gap: 10px;
        align-items: center;
      }
      .segment-time {
        font-size: 20px;
        font-weight: 600;
      }
      .segment-city {
        font-size: 13px;
        margin-top: 1px;
      }
      .segment-airport {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
      }
      .segment-date {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }
      .segment-col-middle {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
      }
      .segment-middle-top {
        font-weight: 500;
      }
      .segment-line {
        height: 4px;
        border-radius: 999px;
        margin: 4px 0;
        background: linear-gradient(
          90deg,
          rgba(7, 94, 84, 0.25),
          rgba(7, 94, 84, 0.06)
        );
        position: relative;
        overflow: hidden;
      }
      .segment-line::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, #0d9488, #16a34a);
        opacity: 0.25;
      }
      .segment-middle-bottom {
        font-size: 12px;
        color: var(--muted);
      }
      .segment-divider {
        height: 1px;
        margin: 6px 0 4px;
        background: linear-gradient(
          90deg,
          rgba(148, 163, 184, 0.6),
          rgba(148, 163, 184, 0)
        );
      }
      .result-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        margin-top: 2px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 9px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: #f9fafb;
        color: #111827;
      }
      .badge-soft {
        background: var(--accent-soft);
        border-color: rgba(45, 212, 191, 0.6);
        color: var(--accent);
      }
      .badge-rating {
        background: #ecfdf3;
        border-color: rgba(16, 185, 129, 0.6);
        color: #047857;
        font-weight: 600;
      }
      .badge-stress-low {
        background: #ecfdf3;
        border-color: rgba(16, 185, 129, 0.6);
        color: #047857;
      }
      .badge-stress-medium {
        background: var(--accent-soft-2);
        border-color: rgba(250, 204, 21, 0.6);
        color: #92400e;
      }
      .badge-stress-high {
        background: #fef2f2;
        border-color: rgba(248, 113, 113, 0.7);
        color: #b91c1c;
      }
      .badge-chip {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #4b5563;
      }
      .badge-yuvia {
        background: linear-gradient(
          135deg,
          rgba(7, 94, 84, 0.08),
          rgba(13, 148, 136, 0.22)
        );
        border-color: rgba(13, 148, 136, 0.65);
        color: #064e3b;
        font-weight: 600;
        box-shadow: 0 4px 14px rgba(13, 148, 136, 0.35);
      }
      .result-footer {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
        border-top: 1px dashed #e5e7eb;
        padding-top: 8px;
        margin-top: 4px;
        font-size: 13px;
        color: var(--muted);
        flex-wrap: wrap;
      }
      .result-footer-baggage {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .result-footer-baggage strong {
        color: var(--ink);
      }
      .result-footer-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: flex-end;
      }
      @media (max-width: 900px) {
        .result-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .result-price-block {
          align-items: flex-start;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <section id="flights-hub" class="yuvia-screen">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="card hub-intro">
        <p>
          Здесь разбираем перелёты по-человечески: подбираем рейсы, оцениваем
          комфорт и подсказываем, как пройдёт день в дороге.
        </p>
      </div>
      <div class="hub-grid">
        <article
          class="hub-card"
          data-screen="flights-search"
          role="button"
          tabindex="0"
        >
          <h2>Маршрут уже выбран</h2>
          <p>Знаю, откуда и куда лечу — подбери удобные рейсы.</p>
        </article>
        <article
          class="hub-card"
          data-screen="flights-ideas"
          role="button"
          tabindex="0"
        >
          <h2>Хочу идею для направления</h2>
          <p>Назову город вылета и даты, а ты предложишь, куда рвануть.</p>
        </article>
        <article
          class="hub-card"
          data-screen="flights-dates"
          role="button"
          tabindex="0"
        >
          <h2>Колеблюсь с датами</h2>
          <p>Город известен — помоги выбрать выгодные и удобные числа.</p>
        </article>
        <article
          class="hub-card"
          data-screen="route-helper"
          role="button"
          tabindex="0"
        >
          <h2>Билеты на руках, нужен проводник</h2>
          <p>Разложи дорогу в аэропорт и до отеля по шагам.</p>
        </article>
      </div>
      <div class="hub-mood">
        <h3>Настроение для побега</h3>
        <div class="hub-mood-grid">
          <article
            class="hub-mood-card"
            data-screen="collection-weekend"
            role="button"
            tabindex="0"
          >
            <h4>Сбежать на выходные из [твоего города]</h4>
          </article>
          <article
            class="hub-mood-card"
            data-screen="collection-sea"
            role="button"
            tabindex="0"
          >
            <h4>Море и солёный воздух</h4>
          </article>
          <article
            class="hub-mood-card"
            data-screen="collection-mountains"
            role="button"
            tabindex="0"
          >
            <h4>Горы и тропы</h4>
          </article>
          <article
            class="hub-mood-card"
            data-screen="collection-northern-lights"
            role="button"
            tabindex="0"
          >
            <h4>Охота на северное сияние</h4>
          </article>
          <article
            class="hub-mood-card"
            data-screen="collection-baikal"
            role="button"
            tabindex="0"
          >
            <h4>Байкал: вода и лёд</h4>
          </article>
        </div>
      </div>
    </section>
    <section id="flights-search" class="yuvia-screen hidden">
      <div class="wrap">
        <!-- Бренд -->
        <header class="brand">
          <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
          <div class="brand-text">
            <div class="brand-name">Yuvia</div>
            <div class="brand-tagline">персональный тревел-консьерж</div>
            <div class="brand-subline">поиск авиабилетов</div>
          </div>
        </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
        <div id="searchSummary" class="search-summary hidden"></div>
        <!-- Форма поиска (твой исходный код) -->
        <div class="card" id="searchForm">
          <div class="search-grid">
            <div class="label">Откуда</div>
            <div></div>
            <div class="label">Куда</div>
            <div class="label">Дата вылета</div>
            <div class="label">Дата возвращения</div>
            <div class="label">Пассажиры</div>
            <div class="suggest-wrapper">
              <input id="origin" placeholder="Москва" autocomplete="off" />
            </div>
            <div class="swap-cell swap-cell--full">
              <button
                type="button"
                class="swap-btn"
                id="swapInline"
                aria-label="Поменять местами города"
              >
                ⇆
              </button>
            </div>
            <div class="suggest-wrapper">
              <input id="destination" placeholder="Казань" autocomplete="off" />
            </div>
            <div><input id="depart" type="date" /></div>
            <div><input id="ret" type="date" /></div>
            <div class="pax-field">
              <button type="button" class="pax-trigger" id="paxTrigger">
                <div class="pax-main" id="paxMainText">1 пассажир</div>
                <div class="pax-sub" id="paxSubText">эконом</div>
                <span class="pax-chevron">▾</span>
              </button>
              <select id="adults" style="display: none">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
              </select>
              <div class="pax-panel hidden" id="paxPanel">
                <div class="pax-row">
                  <div class="pax-label-wrap">
                    <div class="pax-title">Взрослые</div>
                    <div class="pax-note">от 12 лет</div>
                  </div>
                  <div class="pax-counter">
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="adults"
                      data-delta="-1"
                    >
                      −
                    </button>
                    <div class="pax-count" data-kind="adults">1</div>
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="adults"
                      data-delta="1"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div class="pax-row">
                  <div class="pax-label-wrap">
                    <div class="pax-title">Дети</div>
                    <div class="pax-note">от 2 до 12 лет</div>
                  </div>
                  <div class="pax-counter">
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="children"
                      data-delta="-1"
                    >
                      −
                    </button>
                    <div class="pax-count" data-kind="children">0</div>
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="children"
                      data-delta="1"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div class="pax-row">
                  <div class="pax-label-wrap">
                    <div class="pax-title">Младенцы</div>
                    <div class="pax-note">до 2 лет (без места)</div>
                  </div>
                  <div class="pax-counter">
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="infants"
                      data-delta="-1"
                    >
                      −
                    </button>
                    <div class="pax-count" data-kind="infants">0</div>
                    <button
                      class="pax-btn"
                      type="button"
                      data-kind="infants"
                      data-delta="1"
                    >
                      +
                    </button>
                  </div>
                </div>
                <div class="pax-cabin">
                  <button
                    type="button"
                    class="pax-cabin-btn active"
                    data-cabin="eco"
                  >
                    Эконом
                  </button>
                  <button
                    type="button"
                    class="pax-cabin-btn"
                    data-cabin="business"
                  >
                    Бизнес
                  </button>
                </div>
              </div>
            </div>
            <div class="hint" id="originIataHint"></div>
            <div></div>
            <div class="hint" id="destIataHint"></div>
            <div class="hint" id="departHint"></div>
            <div class="hint" id="retHint"></div>
            <div class="pax-hint-placeholder"></div>
          </div>
          <div class="trip-preferences">
            <div class="trip-style">
              <div class="label">Стиль поездки</div>
              <div class="chips-row" id="tripStyleChips">
                <button
                  type="button"
                  class="chip-toggle chip-style active"
                  data-style="calm"
                >
                  Тише едешь
                </button>
                <button
                  type="button"
                  class="chip-toggle chip-style"
                  data-style="balanced"
                >
                  Баланс цены и комфорта
                </button>
                <button
                  type="button"
                  class="chip-toggle chip-style"
                  data-style="cheap"
                >
                  Экономлю по максимуму
                </button>
              </div>
            </div>
            <div class="trip-triggers">
              <div class="label">Твои триггеры</div>
              <div class="chips-row" id="tripTriggerChips">
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="no_night_dep"
                >
                  Не хочу ночных вылетов
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="direct_only"
                >
                  Только прямые рейсы
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="no_short_connections"
                >
                  Без коротких стыковок
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="no_overnight"
                >
                  Не ночевать в аэропорту
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="with_baggage"
                >
                  Лечу с багажом
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="hand_luggage_only"
                >
                  Только ручная кладь
                </button>
                <button
                  type="button"
                  class="chip-toggle"
                  data-trigger="no_early_dep"
                >
                  Не люблю ранние вылеты
                </button>
              </div>
            </div>
          </div>
          <div class="search-actions-row">
            <button class="btn-primary" id="doSearch">Искать</button>
            <button class="btn-ghost" id="toggleAdvanced">
              Расширенный поиск
            </button>
          </div>
          <div id="advancedBlock" class="advanced hidden">
            <div class="divider"></div>
            <div class="advanced-header">
              <div class="advanced-title">Дополнительные настройки</div>
              <div class="advanced-subtitle">
                Все по желанию — чипы работают как быстрые фильтры маршрута
              </div>
            </div>
            <div class="advanced-chips" id="advancedChips">
              <button type="button" class="chip chip-filter" id="chipTripMode">
                Режим: сбалансированный
              </button>
              <button type="button" class="chip chip-filter" id="chipRoute">
                Маршрут: туда-обратно
              </button>
              <button type="button" class="chip chip-filter" id="chipFlex">
                Даты: точные
              </button>
              <button type="button" class="chip chip-filter" id="chipStops">
                Пересадки: не важно
              </button>
              <button type="button" class="chip chip-filter" id="chipDuration">
                В пути: без ограничений
              </button>
              <button type="button" class="chip chip-filter" id="chipAirports">
                Аэропорты: любые
              </button>
              <button type="button" class="chip chip-filter" id="chipBaggage">
                Багаж: не важно
              </button>
            </div>
            <div class="hint" id="weekendHint"></div>
            <div
              class="advanced-airports-panel hidden"
              id="advancedAirportsPanel"
            >
              <div class="label">Аэропорты</div>
              <div class="hint">
                Список появится после первого поиска — можно выбрать 1–2
                любимых.
              </div>
              <select id="advAirportFilter" multiple size="5"></select>
            </div>
            <div class="advanced-hint" id="yuviaRouteHint"></div>
            <div class="advanced-footer">
              <button class="btn-ghost" id="copyLink">
                Скопировать ссылку
              </button>
              <button class="btn-ghost" id="reset">Сбросить форму</button>
            </div>
            <select id="oneway" style="display: none">
              <option value="no">Туда-обратно</option>
              <option value="yes">Только в одну сторону</option>
            </select>
            <select id="flexMode" style="display: none">
              <option value="none">Отключено</option>
              <option value="weekend">Ближайшие выходные</option>
              <option value="plus3">± 3 дня</option>
              <option value="plus7">± 7 дней</option>
            </select>
          </div>
          <div class="hidden" aria-hidden="true">
            <select id="currency">
              <option value="RUB">RUB ₽</option>
              <option value="USD">USD $</option>
              <option value="EUR">EUR €</option>
            </select>
            <select id="cabin">
              <option value="eco">Эконом</option>
              <option value="business">Бизнес</option>
            </select>
          </div>
          <div class="hidden" aria-hidden="true">
            <select id="currency">
              <option value="RUB">RUB ₽</option>
              <option value="USD">USD $</option>
              <option value="EUR">EUR €</option>
            </select>
            <select id="cabin">
              <option value="eco">Эконом</option>
              <option value="business">Бизнес</option>
            </select>
          </div>
        </div>
        <!-- Недавние запросы -->
        <div class="section-title">Недавние запросы</div>
        <div class="chips" id="recentChips"></div>
        <!-- Фильтры + результаты -->
        <div class="two-col">
          <!-- Фильтры -->
          <div class="card filters-block">
            <div class="section-title" style="margin-top: 0">Фильтры</div>
            <div class="label">Пересадки</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px">
              <label class="pill"
                ><input type="radio" name="stops" value="any" checked />
                любые</label
              >
              <label class="pill"
                ><input type="radio" name="stops" value="0" /> только
                прямые</label
              >
              <label class="pill"
                ><input type="radio" name="stops" value="1" /> не более 1</label
              >
            </div>
            <div class="label" style="margin-top: 10px">Время вылета</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px">
              <label class="pill"
                ><input type="checkbox" class="depwin" value="night" /> ночь
                (00–06)</label
              >
              <label class="pill"
                ><input type="checkbox" class="depwin" value="morning" /> утро
                (06–12)</label
              >
              <label class="pill"
                ><input type="checkbox" class="depwin" value="day" /> день
                (12–18)</label
              >
              <label class="pill"
                ><input type="checkbox" class="depwin" value="evening" /> вечер
                (18–24)</label
              >
            </div>
            <div class="label" style="margin-top: 10px">Время прилёта</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px">
              <label class="pill"
                ><input type="checkbox" class="arrwin" value="night" />
                ночь</label
              >
              <label class="pill"
                ><input type="checkbox" class="arrwin" value="morning" />
                утро</label
              >
              <label class="pill"
                ><input type="checkbox" class="arrwin" value="day" />
                день</label
              >
              <label class="pill"
                ><input type="checkbox" class="arrwin" value="evening" />
                вечер</label
              >
            </div>
            <div class="label" style="margin-top: 10px">
              Длительность (часы, максимум)
            </div>
            <input
              type="number"
              id="durMax"
              min="0"
              step="1"
              placeholder="например, 5"
              style="width: 100%"
            />
            <div class="label" style="margin-top: 10px">Цена</div>
            <div class="row" style="gap: 6px; align-items: center">
              <input
                type="number"
                id="priceMin"
                placeholder="мин"
                style="flex: 1; min-width: 0"
              />
              <span>—</span>
              <input
                type="number"
                id="priceMax"
                placeholder="макс"
                style="flex: 1; min-width: 0"
              />
            </div>
            <div class="label" style="margin-top: 10px">Авиакомпании</div>
            <select
              id="airlineFilter"
              multiple
              size="6"
              style="width: 100%"
            ></select>
            <div class="label" style="margin-top: 10px">Аэропорты</div>
            <select
              id="airportFilter"
              multiple
              size="6"
              style="width: 100%"
            ></select>
            <button
              class="btn-ghost"
              id="clearFilters"
              style="margin-top: 12px; width: 100%"
            >
              Сбросить фильтры
            </button>
          </div>
          <!-- Результаты -->
          <div>
            <div id="yuviaTopBlock" class="card topblock hidden">
              <div class="topblock-header">
                <div class="topblock-title">Выбор Yuvia</div>
                <div class="topblock-subtitle" id="yuviaTopSubtitle">
                  Здесь будут 2–3 самых разумных варианта по твоим настройкам.
                </div>
              </div>
              <div class="topblock-list" id="yuviaTopList"></div>
            </div>
            <!-- Избранные рейсы -->
            <div id="favoritesBlock" class="card favorites-block hidden"></div>
            <!-- Сравнение рейсов -->
            <div id="compareBlock" class="card compare-block hidden"></div>
            <div class="toolbar">
              <div class="label" style="margin: 0">Сортировка</div>
              <select id="sortBy">
                <option value="yuvia_score">Сначала рекомендации Yuvia</option>
                <option value="price_asc">Сначала дешёвые</option>
                <option value="price_desc">Сначала дорогие</option>
                <option value="duration_asc">Короткий путь</option>
                <option value="depart_asc">Ранний вылет</option>
              </select>
              <div class="chip" id="summaryChip" title="Краткая сводка по цене">
                —
              </div>
            </div>
            <div class="section-title" style="margin-top: 4px">Результаты</div>
            <div id="results" class="grid"></div>
            <div class="section-title">Соседние даты</div>
            <div id="matrix"></div>
          </div>
        </div>
      </div>
      <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-inner">
          <div class="loading-logo-wrap">
            <video
              class="loading-logo-video"
              autoplay
              muted
              loop
              playsinline
              preload="auto"
            >
              <source src="Yuvia_Anim.webm" type="video/webm" />
            </video>
          </div>
          <div class="loading-text">Ищем лучшие варианты...</div>
        </div>
      </div>
      <div class="version">версия 17.3</div>
      
    </section>
    <section id="collection-weekend" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Сбежать на выходные</h2>
        <p>
          Выбираем быстрые маршруты, чтобы выехать после работы и вернуться без
          стресса.
        </p>
        <p>Рассчитаем бюджет и расскажем, что успеть за 48 часов.</p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="collection-sea" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Море и солёный воздух</h2>
        <p>
          Подборка перелётов туда, где можно ловить бриз и греться на солнце.
        </p>
        <p>Добавим советы по пляжам и сезонным лайфхакам.</p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="collection-mountains" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Горы и тропы</h2>
        <p>
          Расскажем, куда лететь за высотой, и подскажем, как подготовиться к
          маршрутам.
        </p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="collection-northern-lights" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Охота на северное сияние</h2>
        <p>Соберём направления и даты с высокой вероятностью шоу на небе.</p>
        <p>Подскажем, где греться и что взять с собой.</p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="collection-baikal" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Байкал: вода и лёд</h2>
        <p>
          Подберём билеты к самому глубокому озеру страны и составим маршрут по
          берегам.
        </p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="flights-ideas" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Нужна идея направления</h2>
        <p>
          Расскажите город вылета и даты — предложим подборку направлений с
          разными настроениями.
        </p>
        <p>Каждый вариант объясним и покажем примерный бюджет.</p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="flights-dates" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Играем с датами</h2>
        <p>Покажем, как меняется цена и комфорт перелёта на соседние дни.</p>
        <p>Выберем оптимальные даты и соберём напоминания.</p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    <section id="route-helper" class="yuvia-screen hidden">
      <header class="brand">
        <img src="Logo-Full.png" alt="Yuvia" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-name">Yuvia</div>
          <div class="brand-tagline">персональный тревел-консьерж</div>
          <div class="brand-subline">поиск авиабилетов</div>
        </div>
      </header>
      <div class="screen-back">
        <button type="button" class="btn-ghost btn-sm" data-screen="flights-hub">
          ← К сценариям
        </button>
      </div>
      <div class="card hub-stub">
        <h2>Проводник в поездке</h2>
        <p>
          Получите пошаговый план: как добраться в аэропорт, что ждать в пути и
          как доехать до отеля.
        </p>
        <button
          type="button"
          class="btn go-search"
          data-screen="flights-search"
        >
          Перейти к подбору билетов
        </button>
      </div>
    </section>
    
  
    <script>
      (() => {
        const $ = (selector, root = document) => root.querySelector(selector);
        const $$ = (selector, root = document) => Array.from(root.querySelectorAll(selector));
        const todayLocal = new Date();
        todayLocal.setHours(0, 0, 0, 0);
        const API_BASE = "https://yuvia-flights-api.yuviabot.workers.dev";
        const API_SEARCH_PATH = "/api/search";
        const API_MATRIX_PATH = "/api/matrix";

        let originIATA = "";
        let destIATA = "";
        let allResults = [];
        let filteredResults = [];
        let matrixData = [];
        let currentTopFlights = [];
        let lastCurrency = "RUB";

        const paxState = {
          adults: 1,
          children: 0,
          infants: 0,
          cabin: "eco",
        };

        const tripState = {
          style: "calm",
          triggers: {
            no_night_dep: false,
            direct_only: false,
            no_short_connections: false,
            no_overnight: false,
            with_baggage: false,
            hand_luggage_only: false,
            no_early_dep: false,
          },
        };

        const suggestCache = new Map();
        const recentKey = "yuviaRecentSearches";

        const originInput = $("#origin");
        const destinationInput = $("#destination");
        const departInput = $("#depart");
        const returnInput = $("#ret");
        const originHint = $("#originIataHint");
        const destHint = $("#destIataHint");
        const departHint = $("#departHint");
        const returnHint = $("#retHint");
        const searchSummary = $("#searchSummary");
        const matrixBlock = $("#matrix");
        const resultsBlock = $("#results");
        const summaryChip = $("#summaryChip");
        const loadingOverlay = $("#loadingOverlay");
        const priceMinInput = $("#priceMin");
        const priceMaxInput = $("#priceMax");
        const airlineFilter = $("#airlineFilter");
        const airportFilter = $("#airportFilter");
        const advAirportFilter = $("#advAirportFilter");
        const toggleAdvancedBtn = $("#toggleAdvanced");
        const advancedBlock = $("#advancedBlock");
        const swapBtn = $("#swapInline");
        const paxTrigger = $("#paxTrigger");
        const paxPanel = $("#paxPanel");
        const recentChips = $("#recentChips");
        const yuviaTopBlock = $("#yuviaTopBlock");
        const yuviaTopList = $("#yuviaTopList");
        const yuviaTopSubtitle = $("#yuviaTopSubtitle");

        function formatCurrency(value, currency = "RUB") {
          const safeCurrency = (currency || "RUB").toUpperCase();
          const formatter = new Intl.NumberFormat("ru-RU", {
            style: "currency",
            currency: safeCurrency,
            maximumFractionDigits: 0,
          });
          return formatter.format(value);
        }

        function toISO(date) {
          if (!date) return "";
          const year = date.getFullYear();
          const month = `${date.getMonth() + 1}`.padStart(2, "0");
          const day = `${date.getDate()}`.padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        function ddmmyyyy(date) {
          if (!date) return "";
          const day = `${date.getDate()}`.padStart(2, "0");
          const month = `${date.getMonth() + 1}`.padStart(2, "0");
          return `${day}.${month}.${date.getFullYear()}`;
        }

        function formatTime(date) {
          if (!date) return "";
          const hours = `${date.getHours()}`.padStart(2, "0");
          const minutes = `${date.getMinutes()}`.padStart(2, "0");
          return `${hours}:${minutes}`;
        }

        function formatDuration(minutes) {
          if (!minutes) return "—";
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          const parts = [];
          if (hours) parts.push(`${hours} ч`);
          if (mins) parts.push(`${mins} мин`);
          return parts.join(" ");
        }

        function safeDate(value) {
          if (!value) return null;
          const date = value instanceof Date ? value : new Date(value);
          return Number.isNaN(date.getTime()) ? null : date;
        }

        function makeApiURL(path) {
          if (path instanceof URL) return path.toString();
          if (/^https?:/i.test(path)) return path;
          return new URL(path, API_BASE).toString();
        }

        async function callJSON(path) {
          const url = makeApiURL(path);
          console.log("[Yuvia] callJSON →", url);
          const r = await fetch(url);
          if (!r.ok) {
            const text = await r.text().catch(() => "");
            console.error("[Yuvia] API error", r.status, r.statusText, text);
            throw new Error("HTTP " + r.status);
          }
          const json = await r.json();
          console.log("[Yuvia] API response OK", json);
          return json;
        }

        function buildSearchQuery(params) {
          const paramsObj = new URLSearchParams();
          const oneway = params.oneway === true || params.oneway === "yes";
          // FIX Yuvia search: API expects oneway=yes/no; numeric flags were returning empty results.
          paramsObj.set("origin", params.origin);
          paramsObj.set("destination", params.destination);
          paramsObj.set("currency", params.currency || "RUB");
          paramsObj.set("oneway", oneway ? "yes" : "no");
          const departValue = params.departDate || params.depart || params.d1;
          const departISO = typeof departValue === "string" ? departValue : toISO(departValue);
          paramsObj.set("depart", departISO);
          const returnValue = params.returnDate || params.ret || params.d2;
          const returnISO =
            !oneway && returnValue ? (typeof returnValue === "string" ? returnValue : toISO(returnValue)) : "";
          paramsObj.set("ret", returnISO);
          paramsObj.set("adults", String(params.adults || 1));
          if (params.children !== undefined) paramsObj.set("children", String(params.children || 0));
          if (params.infants !== undefined) paramsObj.set("infants", String(params.infants || 0));
          if (params.cabin) paramsObj.set("cabin", params.cabin);
          return paramsObj;
        }

        function formatDeeplinkDate(value) {
          if (!value) return "";
          const date = typeof value === "string" ? parseDateValue(value) : safeDate(value);
          if (!date) return "";
          const day = `${date.getDate()}`.padStart(2, "0");
          const month = `${date.getMonth() + 1}`.padStart(2, "0");
          return `${day}${month}`;
        }

        function buildDeeplink({ origin, destination, departDate, returnDate, oneway, adults, currency }) {
          if (!origin || !destination || !departDate) return "";
          const departSlug = formatDeeplinkDate(departDate);
          const returnSlug = !oneway && returnDate ? formatDeeplinkDate(returnDate) : "";
          const slug = oneway
            ? `${origin.toUpperCase()}${departSlug}${destination.toUpperCase()}1`
            : `${origin.toUpperCase()}${departSlug}${destination.toUpperCase()}${returnSlug || departSlug}1`;
          const url = new URL(`https://www.aviasales.ru/search/${slug}`);
          url.searchParams.set("marker", "672309");
          url.searchParams.set("with_request", "true");
          url.searchParams.set("adults", String(Math.max(1, adults || 1)));
          url.searchParams.set("currency", (currency || "rub").toLowerCase());
          url.searchParams.set("utm_source", "yuvia");
          return url.toString();
        }

        function parseDateValue(value) {
          if (!value) return null;
          const [year, month, day] = value.split("-").map(Number);
          if (!year || !month || !day) return null;
          const date = new Date(year, month - 1, day);
          return Number.isNaN(date.getTime()) ? null : date;
        }

        function clampToFuture(date) {
          if (!date) return null;
          return date < todayLocal ? new Date(todayLocal) : date;
        }

        function updateSearchSummary() {
          const origin = originInput.value.trim();
          const dest = destinationInput.value.trim();
          const departDate = parseDateValue(departInput.value);
          const returnDate = parseDateValue(returnInput.value);
          const passengers = paxState.adults + paxState.children + paxState.infants;

          if (!origin && !dest) {
            searchSummary?.classList.add("hidden");
            return;
          }

          const parts = [];
          if (origin && dest) {
            parts.push(`${origin} → ${dest}`);
          }
          if (departDate) {
            const dateText = ddmmyyyy(departDate);
            if (returnDate) {
              parts.push(`${dateText} · ${ddmmyyyy(returnDate)}`);
            } else {
              parts.push(dateText);
            }
          }
          parts.push(`${passengers} пассаж.`);
          parts.push(paxState.cabin === "eco" ? "эконом" : "бизнес");

          if (searchSummary) {
            searchSummary.textContent = parts.join(" · ");
            searchSummary.classList.remove("hidden");
          }
        }

        function initMinDateHints() {
          const tomorrow = new Date(todayLocal);
          tomorrow.setDate(todayLocal.getDate() + 1);
          if (departInput) {
            departInput.min = toISO(todayLocal);
            if (!departInput.value) {
              departInput.value = toISO(todayLocal);
            }
          }
          if (returnInput) {
            returnInput.min = toISO(todayLocal);
            if (!returnInput.value) {
              returnInput.value = toISO(tomorrow);
            }
          }
          normalizeDepartDate();
          normalizeReturnDate();
        }

        function normalizeDepartDate() {
          if (!departInput) return null;
          let departDate = parseDateValue(departInput.value);
          if (!departDate) {
            departHint.textContent = "Укажи дату вылета";
            return null;
          }
          departDate = clampToFuture(departDate);
          departInput.value = toISO(departDate);
          departHint.textContent = `Вылет: ${ddmmyyyy(departDate)}`;
          departHint.classList.remove("hidden");
          return departDate;
        }

        function normalizeReturnDate() {
          if (!returnInput) return null;
          const departDate = parseDateValue(departInput.value) || todayLocal;
          let returnDate = parseDateValue(returnInput.value);
          if (!returnDate) {
            returnHint.textContent = "Дата возвращения не выбрана";
            return null;
          }
          if (returnDate < departDate) {
            returnDate = new Date(departDate);
          }
          returnInput.value = toISO(returnDate);
          returnHint.textContent = `Возврат: ${ddmmyyyy(returnDate)}`;
          return returnDate;
        }

        function updatePaxSummary() {
          const total = paxState.adults + paxState.children + paxState.infants;
          const text = total === 1 ? "1 пассажир" : `${total} пассажиров`;
          const cabinText = paxState.cabin === "eco" ? "эконом" : "бизнес";
          $("#paxMainText").textContent = text;
          $("#paxSubText").textContent = cabinText;
          const adultsSelect = $("#adults");
          if (adultsSelect) {
            adultsSelect.value = String(paxState.adults);
          }
          $$(".pax-count").forEach((node) => {
            const kind = node.getAttribute("data-kind");
            if (kind && paxState[kind] !== undefined) {
              node.textContent = paxState[kind];
            }
          });
          $$(".pax-cabin-btn").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.cabin === paxState.cabin);
          });
          updateSearchSummary();
          if (allResults.length) {
            applyFiltersAndSort();
          }
        }

        function initPaxFromAdultsSelect() {
          const adultsSelect = $("#adults");
          if (adultsSelect) {
            const value = Number(adultsSelect.value) || 1;
            paxState.adults = Math.max(1, value);
          }
          updatePaxSummary();
        }

        function togglePaxPanel(force) {
          if (!paxPanel) return;
          const shouldOpen = typeof force === "boolean" ? force : paxPanel.classList.contains("hidden");
          paxPanel.classList.toggle("hidden", !shouldOpen);
        }

        function handlePaxButtons() {
          $$(".pax-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              const kind = btn.dataset.kind;
              const delta = Number(btn.dataset.delta || 0);
              if (!kind || Number.isNaN(delta)) return;
              if (kind === "adults") {
                paxState.adults = Math.max(1, paxState.adults + delta);
              } else if (kind === "children") {
                paxState.children = Math.max(0, paxState.children + delta);
              } else if (kind === "infants") {
                const maxInfants = paxState.adults;
                paxState.infants = Math.max(0, Math.min(maxInfants, paxState.infants + delta));
              }
              updatePaxSummary();
            });
          });
          $$(".pax-cabin-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              if (!btn.dataset.cabin) return;
              paxState.cabin = btn.dataset.cabin;
              updatePaxSummary();
            });
          });
          paxTrigger?.addEventListener("click", (event) => {
            event.preventDefault();
            togglePaxPanel();
          });
          document.addEventListener("click", (event) => {
            if (!paxPanel || !paxTrigger) return;
            if (paxTrigger.contains(event.target)) {
              return;
            }
            if (!paxPanel.contains(event.target)) {
              togglePaxPanel(false);
            }
          });
        }

        function formatSuggestItem(item) {
          const city = item.name || item.city_name || item.city || item.code;
          const country = item.country_name || item.country || "";
          return { city, code: item.code, country };
        }

        async function suggestCity(query) {
          const term = query.trim();
          if (!term) return [];
          if (suggestCache.has(term)) return suggestCache.get(term);
          const url = new URL("https://autocomplete.travelpayouts.com/places2");
          url.searchParams.set("term", term);
          url.searchParams.set("locale", "ru");
          const response = await fetch(url.toString());
          if (!response.ok) throw new Error("suggest failed");
          const json = await response.json();
          const mapped = json.map(formatSuggestItem).filter((item) => Boolean(item.code));
          suggestCache.set(term, mapped);
          return mapped;
        }

        function attachSuggest(input, onPick) {
          if (!input) return;
          const wrapper = input.parentElement;
          if (!wrapper) return;
          wrapper.classList.add("suggest-wrapper");
          const panel = document.createElement("div");
          panel.className = "suggest-panel hidden";
          wrapper.appendChild(panel);

          let debounceTimer;
          let currentTerm = "";

          async function runSuggest() {
            const term = input.value.trim();
            currentTerm = term;
            if (!term || term.length < 2) {
              panel.classList.add("hidden");
              panel.innerHTML = "";
              return;
            }
            try {
              const list = await suggestCity(term);
              if (currentTerm !== term) return;
              panel.innerHTML = "";
              if (!list.length) {
                const empty = document.createElement("div");
                empty.className = "suggest-empty";
                empty.textContent = "Ничего не найдено";
                panel.appendChild(empty);
              } else {
                list.slice(0, 8).forEach((item) => {
                  const row = document.createElement("div");
                  row.className = "suggest-item";
                  row.innerHTML = `<strong>${item.city}</strong><span>${item.code} · ${item.country}</span>`;
                  row.addEventListener("click", () => {
                    panel.classList.add("hidden");
                    input.value = item.city;
                    onPick(item);
                    updateSearchSummary();
                  });
                  panel.appendChild(row);
                });
              }
              panel.classList.remove("hidden");
            } catch (error) {
              console.error(error);
            }
          }

          input.addEventListener("input", () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(runSuggest, 200);
          });

          input.addEventListener("focus", runSuggest);

          document.addEventListener("click", (event) => {
            if (panel.contains(event.target) || input.contains(event.target)) return;
            panel.classList.add("hidden");
          });
        }

        function getCurrencyValue() {
          const select = document.getElementById("currency");
          return select?.value || "RUB";
        }

        function ensureIataFromPick(item, hintNode, setValue) {
          if (!item) return;
          setValue(item.code || "");
          if (hintNode) {
            hintNode.textContent = `${item.city} · ${item.code}`;
          }
        }

        function handleSuggestPick(target) {
          return (item) => {
            if (target === "origin") {
              originIATA = item.code;
              ensureIataFromPick(item, originHint, (value) => {
                originIATA = value;
              });
            } else {
              destIATA = item.code;
              ensureIataFromPick(item, destHint, (value) => {
                destIATA = value;
              });
            }
          };
        }

        function setLoading(active) {
          if (!loadingOverlay) return;
          loadingOverlay.classList.toggle("hidden", !active);
        }

        function updateFilterOptions() {
          const airlines = [...new Set(allResults.map((flight) => flight.airlineName))].sort();
          if (airlineFilter) {
            airlineFilter.innerHTML = "";
            airlines.forEach((name) => {
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              airlineFilter.appendChild(option);
            });
          }

          const airports = [...new Set(allResults.flatMap((flight) => [flight.originAirport, flight.destAirport]))].filter(Boolean);
          [airportFilter, advAirportFilter]
            .filter(Boolean)
            .forEach((select) => {
              select.innerHTML = "";
            });
          airports.forEach((code) => {
            [airportFilter, advAirportFilter]
              .filter(Boolean)
              .forEach((select) => {
                const option = document.createElement("option");
                option.value = code;
                option.textContent = code;
                select.appendChild(option);
              });
          });
        }

        function getSelectedValues(select) {
          return Array.from(select?.selectedOptions || []).map((option) => option.value);
        }

        function withinListAfterFilters(list) {
          const min = Number(priceMinInput.value) || null;
          const max = Number(priceMaxInput.value) || null;
          const airlineValues = getSelectedValues(airlineFilter);
          const airportValues = getSelectedValues(airportFilter);

          return list.filter((flight) => {
            if (min && flight.price < min) return false;
            if (max && flight.price > max) return false;
            if (airlineValues.length && !airlineValues.includes(flight.airlineName)) return false;
            if (
              airportValues.length &&
              !airportValues.includes(flight.originAirport) &&
              !airportValues.includes(flight.destAirport)
            ) {
              return false;
            }
            return true;
          });
        }

        function isNightDeparture(flight) {
  if (flight.departHour == null || typeof flight.departHour !== "number") {
    // если не знаем время вылета — не считаем его ночным
    return false;
  }
  return flight.departHour >= 22 || flight.departHour < 6;
}

function isEarlyDeparture(flight) {
  if (flight.departHour == null || typeof flight.departHour !== "number") {
    // если не знаем время вылета — не считаем его слишком ранним
    return false;
  }
  return flight.departHour < 8;
}


        function applyTripTriggers(list) {
          let result = list;
          if (tripState.triggers.no_night_dep) {
            result = result.filter((flight) => !isNightDeparture(flight));
          }
          if (tripState.triggers.direct_only) {
            result = result.filter((flight) => flight.transfers === 0);
          }
          if (tripState.triggers.no_early_dep) {
            result = result.filter((flight) => !isEarlyDeparture(flight));
          }
          const hasBaggageInfo = result.some((flight) => flight.hasCheckedBaggage);
          const hasHandOnly = result.some((flight) => !flight.hasCheckedBaggage);
          if (tripState.triggers.with_baggage && hasBaggageInfo) {
            result = result.filter((flight) => flight.hasCheckedBaggage);
          }
          if (tripState.triggers.hand_luggage_only && hasHandOnly) {
            result = result.filter((flight) => !flight.hasCheckedBaggage);
          }
          return result;
        }

        function applyTripStyle(list) {
  if (!list.length) return [];

  const baseList = list.slice();

  const avgDuration =
    baseList.reduce(
      (sum, flight) =>
        sum + (typeof flight.durationMinutes === "number" ? flight.durationMinutes : 0),
      0
    ) / baseList.length || 0;

  const avgPrice =
    baseList.reduce(
      (sum, flight) => sum + (typeof flight.price === "number" ? flight.price : 0),
      0
    ) / baseList.length || 0;

  let filtered = baseList.slice();

  if (tripState.style === "calm") {
    // Тише едешь: короче среднего, не более 1 пересадки, без ночных вылетов
    filtered = filtered.filter((flight) => {
      const hasDuration =
        typeof flight.durationMinutes === "number" && flight.durationMinutes > 0;
      const durationOK = !hasDuration || flight.durationMinutes <= avgDuration;
      const transfersOK =
        typeof flight.transfers === "number" ? flight.transfers <= 1 : true;
      const nightOK = !isNightDeparture(flight);
      return durationOK && transfersOK && nightOK;
    });

    filtered.sort(
      (a, b) => (b.rating || 0) - (a.rating || 0)
    );
  } else if (tripState.style === "balanced") {
    // Баланс: цена не сильно выше средней, максимум 1 пересадка, без ночи
    filtered = filtered.filter((flight) => {
      const priceOK =
        !avgPrice ||
        typeof flight.price !== "number" ||
        flight.price <= avgPrice * 1.2;
      const transfersOK =
        typeof flight.transfers === "number" ? flight.transfers <= 1 : true;
      const nightOK = !isNightDeparture(flight);
      return priceOK && transfersOK && nightOK;
    });

    filtered.sort(
      (a, b) =>
        (b.rating || 0) - (a.rating || 0) ||
        (a.price || 0) - (b.price || 0)
    );
  } else if (tripState.style === "cheap") {
    // Экономлю: просто самые дешёвые, без доп. ограничений
    filtered.sort(
      (a, b) => (a.price || 0) - (b.price || 0)
    );
  }

  // Если после всех условий ничего не осталось — не гасим выдачу,
  // а просто возвращаем базовый список с подходящей сортировкой
  if (!filtered.length) {
    if (tripState.style === "calm" || tripState.style === "balanced") {
      return baseList.slice().sort(
        (a, b) =>
          (b.rating || 0) - (a.rating || 0) ||
          (a.price || 0) - (b.price || 0)
      );
    }
    if (tripState.style === "cheap") {
      return baseList.slice().sort(
        (a, b) => (a.price || 0) - (b.price || 0)
      );
    }
  }

  return filtered;
}


        function sortBySelection(list) {
          const sortValue = $("#sortBy")?.value || "yuvia_score";
          const sorted = list.slice();
          if (sortValue === "price_asc") {
            sorted.sort((a, b) => a.price - b.price);
          } else if (sortValue === "price_desc") {
            sorted.sort((a, b) => b.price - a.price);
          } else if (sortValue === "duration_asc") {
            sorted.sort((a, b) => a.durationMinutes - b.durationMinutes);
          } else if (sortValue === "depart_asc") {
            sorted.sort((a, b) => a.departAt - b.departAt);
          } else {
            sorted.sort((a, b) => b.yuviaScore - a.yuviaScore);
          }
          return sorted;
        }

        function updateSummaryChip(list) {
          if (!summaryChip) return;
          if (!list.length) {
            summaryChip.textContent = "—";
            return;
          }
          const min = Math.min(...list.map((flight) => flight.price));
          const avg = list.reduce((sum, flight) => sum + flight.price, 0) / list.length;
          summaryChip.textContent = `от ${formatCurrency(min, lastCurrency)} · ср. ${formatCurrency(avg, lastCurrency)}`;
        }

        function formatTransfers(transfers) {
          if (!transfers) return "прямой рейс";
          if (transfers === 1) return "1 пересадка";
          if (transfers >= 2 && transfers <= 4) return `${transfers} пересадки`;
          return `${transfers} пересадок`;
        }

        function renderSegmentBlock(group, label) {
          if (!group || !group.start || !group.end) return "";
          const start = group.start;
          const end = group.end;
          const transfersText = formatTransfers(group.transfers);
          return `
            <div class="segment">
              <div class="segment-label">${label}</div>
              <div class="segment-row">
                <div>
                  <div class="segment-time">${formatTime(start.departAt)}</div>
                  <div class="segment-city">${start.originCity || start.originAirport || ""}</div>
                  <div class="segment-airport">${start.originAirport || ""}</div>
                  <div class="segment-date">${start.departAt ? ddmmyyyy(start.departAt) : ""}</div>
                </div>
                <div class="segment-col-middle">
                  <div class="segment-middle-top">${formatDuration(group.durationMinutes)}</div>
                  <div class="segment-line"></div>
                  <div class="segment-middle-bottom">${transfersText}</div>
                </div>
                <div>
                  <div class="segment-time">${formatTime(end.arriveAt)}</div>
                  <div class="segment-city">${end.destCity || end.destAirport || ""}</div>
                  <div class="segment-airport">${end.destAirport || ""}</div>
                  <div class="segment-date">${end.arriveAt ? ddmmyyyy(end.arriveAt) : ""}</div>
                </div>
              </div>
            </div>
          `;
        }

        function renderResults(list) {
          if (!resultsBlock) return;
          resultsBlock.innerHTML = "";
          if (!list.length) {
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.textContent = "Нет рейсов по текущим фильтрам.";
            resultsBlock.appendChild(empty);
            updateSummaryChip(list);
            return;
          }
          list.forEach((flight) => {
            const card = document.createElement("article");
            card.className = "result";
            card.dataset.id = flight.id;
            const segments = [];
            if (flight.outbound) {
              segments.push(renderSegmentBlock(flight.outbound, "Туда"));
            }
            if (flight.return) {
              segments.push(renderSegmentBlock(flight.return, "Обратно"));
            }
            if (!segments.length && flight.departAt && flight.arriveAt) {
              segments.push(
                renderSegmentBlock(
                  {
                    start: {
                      departAt: flight.departAt,
                      originCity: flight.originCity,
                      originAirport: flight.originAirport,
                    },
                    end: {
                      arriveAt: flight.arriveAt,
                      destCity: flight.destCity,
                      destAirport: flight.destAirport,
                    },
                    durationMinutes: flight.durationMinutes,
                    transfers: flight.transfers,
                  },
                  "Маршрут"
                )
              );
            }
            const ratingText = typeof flight.rating === "number" ? flight.rating.toFixed(1) : flight.rating || "—";
            const stressClass =
              flight.stressLevel === "low"
                ? "badge-stress-low"
                : flight.stressLevel === "high"
                ? "badge-stress-high"
                : "badge-stress-medium";
            const deeplinkButton = flight.deeplink
              ? `<a href="${flight.deeplink}" target="_blank" rel="noopener"><button class="btn-primary btn-sm">На Aviasales</button></a>`
              : `<button class="btn-primary btn-sm" disabled>Нет ссылки</button>`;
            const outboundDuration = flight.outbound?.durationMinutes
              ? `<span class="badge badge-chip">туда: ${formatDuration(flight.outbound.durationMinutes)}</span>`
              : "";
            const returnDuration = flight.return?.durationMinutes
              ? `<span class="badge badge-chip">обратно: ${formatDuration(flight.return.durationMinutes)}</span>`
              : "";
            card.innerHTML = `
              <div class="result-header">
                <div>
                  <div class="result-route">${flight.originCity} ⇄ ${flight.destCity}</div>
                  <div class="result-dates">${flight.depDateStr || ""} · вылет в ${flight.departTimeStr || "—"}</div>
                </div>
                <div class="result-price-block">
                  <div class="price">${formatCurrency(flight.price, flight.currency || lastCurrency)}</div>
                  <div class="airline-logo-wrap">
                    <div class="airline-logo">${flight.airlineCode || ""}</div>
                    <span>${flight.airlineName || "Авиакомпания"}</span>
                  </div>
                  ${deeplinkButton}
                </div>
              </div>
              <div class="result-segments">
                ${segments.join("")}
              </div>
              <div class="result-chips">
                <span class="badge badge-rating">Оценка маршрута ${ratingText}</span>
                <span class="badge ${stressClass}">${getStressText(flight.stressLevel)}</span>
                <span class="badge badge-chip">${formatTransfers(flight.transfers)}</span>
                ${outboundDuration}
                ${returnDuration}
                ${flight.isTop ? '<span class="badge badge-yuvia">Рекомендация Yuvia</span>' : ""}
              </div>
              <div class="result-footer">
                <div class="result-footer-baggage">
                  <div><strong>Багаж:</strong> ${flight.baggageText || "Неизвестно"}</div>
                  <div><strong>Ручная кладь:</strong> ${flight.handBaggageText || "Неизвестно"}</div>
                </div>
                <div class="result-footer-actions">
                  <button type="button" class="btn-ghost btn-sm btn-fav" data-id="${flight.id}">☆ В избранное</button>
                  <button type="button" class="btn-ghost btn-sm btn-compare" data-id="${flight.id}">⇄ Добавить в сравнение</button>
                  <button type="button" class="btn-ghost btn-sm btn-insight" data-id="${flight.id}">Разобрать рейс</button>
                </div>
              </div>
            `;
            resultsBlock.appendChild(card);
          });
          updateSummaryChip(list);
        }

        function updateAdvancedHints(query) {
          const weekendHint = $("#weekendHint");
          if (weekendHint) {
            const weekend = weekendAround();
            weekendHint.textContent = `Ближайшие выходные: ${ddmmyyyy(weekend.sat)} — ${ddmmyyyy(weekend.sun)}`;
          }
          const routeHint = $("#yuviaRouteHint");
          if (routeHint) {
            routeHint.textContent = `${query.originCity} → ${query.destCity} · стиль: ${tripState.style}`;
          }
        }

        function weekendAround(base = new Date()) {
          const dt = new Date(base.getFullYear(), base.getMonth(), base.getDate());
          const day = dt.getDay();
          const sat = new Date(dt);
          sat.setDate(dt.getDate() + ((6 - day + 7) % 7));
          const sun = new Date(sat);
          sun.setDate(sat.getDate() + 1);
          return { sat, sun };
        }

        function saveRecent(state) {
          const list = JSON.parse(localStorage.getItem(recentKey) || "[]");
          list.unshift(state);
          const unique = [];
          const seen = new Set();
          list.forEach((item) => {
            const key = `${item.origin}|${item.destination}|${item.depart}`;
            if (seen.has(key)) return;
            seen.add(key);
            unique.push(item);
          });
          localStorage.setItem(recentKey, JSON.stringify(unique.slice(0, 6)));
          renderRecent();
        }

        function renderRecent() {
          if (!recentChips) return;
          recentChips.innerHTML = "";
          const list = JSON.parse(localStorage.getItem(recentKey) || "[]");
          list.forEach((item) => {
            const chip = document.createElement("button");
            chip.type = "button";
            chip.className = "chip";
            chip.textContent = `${item.origin} → ${item.destination}`;
            chip.addEventListener("click", () => {
              originInput.value = item.origin;
              destinationInput.value = item.destination;
              departInput.value = item.depart;
              returnInput.value = item.returnDate;
              originIATA = item.originIata;
              destIATA = item.destIata;
              updateSearchSummary();
              normalizeDepartDate();
              normalizeReturnDate();
            });
            recentChips.appendChild(chip);
          });
        }

        function clearFilters() {
          priceMinInput.value = "";
          priceMaxInput.value = "";
          airlineFilter.selectedIndex = -1;
          airportFilter.selectedIndex = -1;
          advAirportFilter.selectedIndex = -1;
          applyFiltersAndSort();
        }

        function applyFiltersAndSort() {
          if (!allResults.length) {
            resultsBlock.innerHTML = "";
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.textContent = "Пока нет результатов — начни новый поиск.";
            resultsBlock.appendChild(empty);
            summaryChip.textContent = "—";
            if (yuviaTopBlock) {
              yuviaTopBlock.classList.add("hidden");
            }
            return;
          }
          let list = withinListAfterFilters(allResults);
          list = applyTripTriggers(list);
          list = applyTripStyle(list);
          filteredResults = sortBySelection(list);
          const topFlights = getYuviaTop3(filteredResults);
          markTopFlights(filteredResults, topFlights);
          renderResults(filteredResults);
          renderYuviaTop(filteredResults, topFlights);
        }

        function mapSegment(segment, fallback = {}) {
          if (!segment) return null;
          const departAt = safeDate(
            segment.departAt ||
              segment.depart_at ||
              segment.departure ||
              segment.departure_at ||
              segment.date_from ||
              segment.depart_date ||
              segment.time_from ||
              segment.begin_time
          );
          const arriveAt = safeDate(
            segment.arriveAt ||
              segment.arrive_at ||
              segment.arrival ||
              segment.arrival_at ||
              segment.date_to ||
              segment.arrival_date ||
              segment.time_to ||
              segment.end_time
          );
          const originCity =
            segment.originCity ||
            segment.origin_city ||
            segment.cityFrom ||
            segment.city_from ||
            segment.from_city ||
            segment.origin?.city ||
            fallback.originCity;
          const destCity =
            segment.destCity ||
            segment.dest_city ||
            segment.cityTo ||
            segment.city_to ||
            segment.to_city ||
            segment.destination?.city ||
            fallback.destCity;
          const originAirport =
            segment.originAirport ||
            segment.origin_airport ||
            segment.flyFrom ||
            segment.from ||
            segment.origin ||
            fallback.originAirport;
          const destAirport =
            segment.destAirport ||
            segment.dest_airport ||
            segment.flyTo ||
            segment.to ||
            segment.destination ||
            fallback.destAirport;
          const airlineCode =
            segment.airlineCode || segment.airline || segment.carrier || segment.marketing_carrier || fallback.airlineCode;
          const airlineName =
            segment.airlineName ||
            segment.airline_name ||
            segment.carrier_name ||
            segment.marketing_carrier_name ||
            fallback.airlineName ||
            airlineCode;
          const durationMinutes =
            segment.durationMinutes ||
            segment.duration ||
            segment.duration_min ||
            (departAt && arriveAt ? Math.max(0, Math.round((arriveAt - departAt) / 60000)) : null);
          return {
            departAt,
            arriveAt,
            originCity: originCity || fallback.originCity || "",
            destCity: destCity || fallback.destCity || "",
            originAirport: originAirport || fallback.originAirport || "",
            destAirport: destAirport || fallback.destAirport || "",
            airlineName: airlineName || fallback.airlineName || "",
            airlineCode: airlineCode || fallback.airlineCode || "",
            durationMinutes,
          };
        }

        function splitSegments(raw, fallback = {}) {
          const outboundSegments = [];
          const returnSegments = [];
          function addSegment(segment, type = "outbound") {
            const mapped = mapSegment(segment, fallback);
            if (!mapped) return;
            if (type === "return") {
              returnSegments.push(mapped);
            } else {
              outboundSegments.push(mapped);
            }
          }
          const groups = [
            { list: raw.outboundSegments || raw.outbound_segments || raw.go_segments, type: "outbound" },
            { list: raw.returnSegments || raw.inbound_segments || raw.back_segments || raw.return_segments, type: "return" },
          ];
          groups.forEach(({ list, type }) => {
            if (Array.isArray(list)) {
              list.forEach((segment) => addSegment(segment, type));
            }
          });
          if (!outboundSegments.length && !returnSegments.length) {
            const generic = Array.isArray(raw.segments) ? raw.segments : Array.isArray(raw.route) ? raw.route : [];
            generic.forEach((segment) => {
              const isReturn = Boolean(
                segment?.isReturn ||
                  segment?.is_return ||
                  segment?.direction === "return" ||
                  segment?.leg === "return" ||
                  segment?.segment_type === "back" ||
                  segment?.trip === "back" ||
                  segment?.return === true
              );
              addSegment(segment, isReturn ? "return" : "outbound");
            });
          }
          if (
            !outboundSegments.length &&
            (fallback.departAt || raw.departAt || raw.depart_at || raw.departure_at || raw.depart_date)
          ) {
            addSegment(
              {
                departAt: fallback.departAt || raw.departAt,
                arriveAt: fallback.arriveAt || raw.arriveAt,
                originCity: fallback.originCity || raw.originCity,
                destCity: fallback.destCity || raw.destCity,
                originAirport: fallback.originAirport || raw.originAirport || raw.origin,
                destAirport: fallback.destAirport || raw.destAirport || raw.destination,
                airline: fallback.airlineCode || raw.airline,
                airline_name: fallback.airlineName || raw.airlineName,
                durationMinutes: raw.durationMinutes,
              },
              "outbound"
            );
          }
          if (!returnSegments.length && (fallback.returnDepartAt || raw.returnDepartAt || raw.return_at || raw.return_date)) {
            addSegment(
              {
                departAt: fallback.returnDepartAt || raw.returnDepartAt,
                arriveAt: fallback.returnArriveAt || raw.returnArriveAt,
                originCity: fallback.destCity || raw.destCity,
                destCity: fallback.originCity || raw.originCity,
                originAirport: fallback.destAirport || raw.destAirport,
                destAirport: fallback.originAirport || raw.originAirport,
                airline: fallback.airlineCode || raw.airline,
                airline_name: fallback.airlineName || raw.airlineName,
                durationMinutes: raw.returnDurationMinutes,
              },
              "return"
            );
          }
          return { outboundSegments, returnSegments };
        }

        function summarizeSegments(segmentList) {
          if (!segmentList.length) return null;
          const start = segmentList[0];
          const end = segmentList[segmentList.length - 1];
          const durationMinutes = segmentList.reduce((sum, segment) => {
            if (segment.durationMinutes) return sum + segment.durationMinutes;
            if (segment.departAt && segment.arriveAt) {
              return sum + Math.max(0, Math.round((segment.arriveAt - segment.departAt) / 60000));
            }
            return sum;
          }, 0);
          return {
            start,
            end,
            durationMinutes,
            transfers: Math.max(0, segmentList.length - 1),
          };
        }

        function normalizeFlight(raw, context = {}) {
          if (!raw) return null;
         // Выделяем вылет туда, прилёт туда и отдельные даты для обратного рейса.
// ВАЖНО: не использовать return_at / return_date в arriveAt, это отдельный рейс.
const departAt = safeDate(
  raw.departAt ||
  raw.depart_at ||
  raw.departure_at ||
  raw.departure ||
  raw.start_time ||
  raw.depart_date ||
  raw.date_from
);

const arriveAt = safeDate(
  raw.arriveAt ||
  raw.arrive_at ||
  raw.arrival_at ||
  raw.arrival ||
  raw.end_time ||
  raw.arrival_date ||
  raw.date_to
);

const returnDepartAt = safeDate(
  raw.returnDepartAt ||
  raw.return_departure ||
  raw.return_at ||
  raw.return_date ||
  raw.inbound?.depart_at ||
  raw.inbound?.departure_at
);

const returnArriveAt = safeDate(
  raw.returnArriveAt ||
  raw.return_arrival ||
  raw.inbound?.arrive_at ||
  raw.inbound?.arrival_at
);

          const fallback = {
            originCity: raw.originCity || raw.origin_city || context.originCity,
            destCity: raw.destCity || raw.dest_city || context.destCity,
            originAirport: raw.originAirport || raw.origin_airport || raw.origin || context.origin,
            destAirport: raw.destAirport || raw.dest_airport || raw.destination || context.destination,
            airlineName: raw.airlineName || raw.airline || raw.carrier_name,
            airlineCode: raw.airlineCode || raw.airline || raw.carrier,
            departAt,
            arriveAt,
            returnDepartAt,
            returnArriveAt,
          };
          // Сырые длительности из API (Travelpayouts / Aviasales-обёртка)
const outboundDurationRaw =
  raw.duration_to ??
  raw.durationTo ??
  raw.forward_duration ??
  raw.duration ??
  raw.durationMinutes ??
  raw.duration_min ??
  0;

const returnDurationRaw =
  raw.duration_back ??
  raw.durationBack ??
  raw.return_duration ??
  raw.returnDuration ??
  0;

          const { outboundSegments, returnSegments } = splitSegments(raw, fallback);
          const outboundSummary = summarizeSegments(outboundSegments);
          const returnSummary = summarizeSegments(returnSegments);
          const primarySegment = outboundSummary?.start || outboundSegments[0] || fallback;
          const priceValue =
            raw.price?.value ??
            raw.price?.amount ??
            raw.price?.total ??
            raw.price ??
            raw.cost ??
            raw.total_price ??
            0;
          const price = Number(priceValue) || 0;
          const currency = raw.currency || raw.price?.currency || context.currency || lastCurrency;
          const hasCheckedBaggage = Boolean(raw.hasCheckedBaggage || raw.has_baggage || raw.baggage?.checked);
          const baggageText = raw.baggageText || raw.baggage?.checked || (hasCheckedBaggage ? "Включён" : "Не включён");
          const handBaggageText = raw.handBaggageText || raw.baggage?.hand || "По тарифу";
          const durationMinutes =
            (outboundSummary?.durationMinutes || raw.durationMinutes || raw.duration_min || 0) +
            (returnSummary?.durationMinutes || 0);
          const transfers = outboundSummary?.transfers ?? raw.transfers ?? raw.stops ?? 0;
          const departPoint = outboundSummary?.start?.departAt || departAt;
          const arrivePoint = outboundSummary?.end?.arriveAt || arriveAt;
          const departTimeStr = formatTime(departPoint);
          const arriveTimeStr = formatTime(arrivePoint);
          const depDateStr = ddmmyyyy(departPoint);
          const durationHours = Number(((outboundSummary?.durationMinutes || raw.durationMinutes || 0) / 60).toFixed(1));
          const ratingBase = raw.rating ?? 7.2;
          const rating = Number((ratingBase + (hasCheckedBaggage ? 0.4 : 0) - transfers * 0.35).toFixed(1));
          const stressLevel = rating >= 8.3 ? "low" : rating >= 6.5 ? "medium" : "high";
          const yuviaScore = Math.round(rating * 20 + (hasCheckedBaggage ? 20 : 0) - transfers * 12);
          const departHour = departPoint instanceof Date ? departPoint.getHours() : null;
          return {
            id:
              String(
                raw.id ||
                  raw.flight_id ||
                  raw.search_id ||
                  raw.token ||
                  context.fallbackId ||
                  `${context.origin || ""}-${context.destination || ""}-${Math.random().toString(16).slice(2)}`
              ),
            originCity: outboundSummary?.start?.originCity || fallback.originCity || context.originCity || "",
            destCity: outboundSummary?.end?.destCity || fallback.destCity || context.destCity || "",
            originAirport: outboundSummary?.start?.originAirport || fallback.originAirport || context.origin || "",
            destAirport: outboundSummary?.end?.destAirport || fallback.destAirport || context.destination || "",
            departAt: outboundSummary?.start?.departAt || departAt,
            arriveAt: outboundSummary?.end?.arriveAt || arriveAt,
            returnDepartAt: returnSummary?.start?.departAt || returnDepartAt,
            returnArriveAt: returnSummary?.end?.arriveAt || returnArriveAt,
            departTimeStr,
            arriveTimeStr,
            depDateStr,
            durationMinutes,
            durationHours,
            duration_to_hours: durationHours,
            transfers,
            price,
            currency,
            airlineName: primarySegment.airlineName || "",
            airlineCode: primarySegment.airlineCode || "",
            hasCheckedBaggage,
            baggageText,
            handBaggageText,
            rating,
            stressLevel,
            yuviaScore,
            airline: primarySegment.airlineCode || "",
            segments: outboundSegments,
            outbound: outboundSummary,
            return: returnSummary,
            departHour,
            deeplink: buildDeeplink({
              origin: context.origin || fallback.originAirport,
              destination: context.destination || fallback.destAirport,
              departDate: outboundSummary?.start?.departAt || departAt,
              returnDate: context.oneway ? null : context.returnDate || returnSummary?.start?.departAt,
              oneway: context.oneway,
              adults: context.passengers || context.adults || 1,
              currency,
            }),
          };
        }

        function normalizeMatrixResponse(payload) {
          if (!payload) return [];
          let source = [];
          if (Array.isArray(payload)) {
            source = payload;
          } else if (Array.isArray(payload.matrix)) {
            source = payload.matrix;
          } else if (Array.isArray(payload.data)) {
            source = payload.data;
          } else if (payload.entries && typeof payload.entries === "object") {
            source = Object.entries(payload.entries).map(([date, value]) => ({ ...value, date }));
          }
          return source
            .map((item) => {
              const iso = item.date_iso || item.date || item.depart_date;
              const isoDate = iso ? iso.split("T")[0] : "";
              const displayDate = item.date_str || (isoDate ? isoDate.split("-").reverse().join(".") : "");
              const price = Number(item.price || item.value || item.amount || item.min_price || 0);
              if (!isoDate || !price) return null;
              return {
                date: isoDate,
                date_iso: isoDate,
                date_str: displayDate,
                date_str_ru: item.date_str_ru || displayDate,
                price,
                currency: item.currency || lastCurrency,
              };
            })
            .filter(Boolean);
        }

        function renderPriceMatrix(data, selectedISODate) {
          if (!matrixBlock) return;
          matrixBlock.innerHTML = "";
          matrixBlock.className = "matrix-calendar";
          if (!data || !data.length) {
            const empty = document.createElement("div");
            empty.className = "hint";
            empty.textContent = "Пока нет данных по соседним датам.";
            matrixBlock.appendChild(empty);
            return;
          }
          const prices = data.map((entry) => entry.price).filter((price) => typeof price === "number" && price > 0);
          const minPrice = prices.length ? Math.min(...prices) : null;
          data.forEach((item) => {
            const cell = document.createElement("div");
            cell.className = "matrix-day";
            if (minPrice !== null && item.price === minPrice) {
              cell.classList.add("cheapest");
            }
            if (item.date === selectedISODate) {
              cell.classList.add("selected");
            }
            const dateDiv = document.createElement("div");
            dateDiv.className = "matrix-day__date";
            dateDiv.textContent = item.date_str_ru || item.date_str || item.date;
            const priceDiv = document.createElement("div");
            priceDiv.className = "matrix-day__price";
            priceDiv.textContent = `от ${formatCurrency(item.price, item.currency || lastCurrency)}`;
            cell.appendChild(dateDiv);
            cell.appendChild(priceDiv);
            cell.addEventListener("click", () => {
              if (item.date) {
                departInput.value = item.date;
                normalizeDepartDate();
                if (typeof doSearch === "function") {
                  doSearch();
                }
              }
            });
            matrixBlock.appendChild(cell);
          });
        }

        function getMedianPrice(list) {
          if (!list.length) return 0;
          const prices = list
            .map((flight) => flight.price)
            .filter((price) => typeof price === "number" && price > 0)
            .sort((a, b) => a - b);
          if (!prices.length) return 0;
          const mid = Math.floor(prices.length / 2);
          return prices.length % 2 ? prices[mid] : (prices[mid - 1] + prices[mid]) / 2;
        }

        function getYuviaTop3(list) {
          if (!list.length) return [];
          const working = list.filter((flight) => typeof flight.price === "number" && flight.price > 0);
          if (!working.length) return [];
          const cheapest = [...working].sort((a, b) => a.price - b.price)[0];
          const fastest = [...working].sort(
            (a, b) => (a.outbound?.durationMinutes || a.durationMinutes || Infinity) - (b.outbound?.durationMinutes || b.durationMinutes || Infinity)
          )[0];
          const medianPrice = getMedianPrice(working);
          const balanced = [...working]
            .sort((a, b) => (b.rating || 0) - (a.rating || 0) || a.price - b.price)
            .find((flight) => !medianPrice || flight.price <= medianPrice * 1.25);
          const priority = {
            "Золотая середина": 3,
            "Самый дешёвый": 2,
            "Самый быстрый": 1,
          };
          const topMap = new Map();
          function addCandidate(flight, label) {
            if (!flight) return;
            const existing = topMap.get(flight.id);
            if (existing && priority[label] <= priority[existing.topLabel]) return;
            topMap.set(flight.id, { ...flight, topLabel: label });
          }
          addCandidate(balanced, "Золотая середина");
          addCandidate(cheapest, "Самый дешёвый");
          addCandidate(fastest, "Самый быстрый");
          return Array.from(topMap.values()).slice(0, 3);
        }

        function markTopFlights(list, top) {
          const ids = new Set(top.map((flight) => flight.id));
          list.forEach((flight) => {
            flight.isTop = ids.has(flight.id);
            const match = top.find((item) => item.id === flight.id);
            flight.topLabel = match?.topLabel || "";
          });
        }

        function getStressText(level) {
          if (level === "low") return "стресс: низкий";
          if (level === "medium") return "стресс: средний";
          if (level === "high") return "стресс: высокий";
          return "стресс: неизвестно";
        }

        function highlightResultCard(flightId) {
          if (!flightId) return;
          const selector = `.result[data-id="${CSS?.escape ? CSS.escape(flightId) : flightId}"]`;
          const node = document.querySelector(selector);
          if (!node) return;
          node.scrollIntoView({ behavior: "smooth", block: "start" });
          node.classList.add("result-highlight");
          setTimeout(() => node.classList.remove("result-highlight"), 1800);
        }

        function renderYuviaTop(list, presetTop) {
          if (!yuviaTopBlock || !yuviaTopList || !yuviaTopSubtitle) return;
          if (!list.length) {
            yuviaTopBlock.classList.add("hidden");
            yuviaTopList.innerHTML = "";
            currentTopFlights = [];
            return;
          }
          const top = presetTop?.length ? presetTop : getYuviaTop3(list);
          currentTopFlights = top;
          if (!top.length) {
            yuviaTopBlock.classList.add("hidden");
            yuviaTopList.innerHTML = "";
            return;
          }
          yuviaTopBlock.classList.remove("hidden");
          const subtitle = `Подобрали ${top.length} ${top.length === 1 ? "вариант" : "варианта"} для ${originInput.value.trim()} → ${destinationInput.value.trim()}`;
          yuviaTopSubtitle.textContent = subtitle;
          yuviaTopList.innerHTML = "";
          top.forEach((flight) => {
            const card = document.createElement("div");
            card.className = "topcard";
            card.innerHTML = `
              <div class="topcard-label">${flight.topLabel || "Рекомендация"}</div>
              <div class="topcard-main">
                <div class="topcard-route">${flight.originCity} → ${flight.destCity}</div>
                <div class="topcard-price">${formatCurrency(flight.price, flight.currency || lastCurrency)}</div>
              </div>
              <div class="topcard-meta">${flight.departTimeStr || ""} · ${formatDuration(flight.outbound?.durationMinutes || flight.durationMinutes)}</div>
              <div class="topcard-meta">${getStressText(flight.stressLevel)}</div>
              <div class="topcard-actions">
                <button type="button" class="btn-secondary btn-sm" data-action="open">Открыть в выдаче</button>
                <button type="button" class="btn-primary btn-sm" data-action="deeplink">На Aviasales</button>
              </div>
            `;
            const openBtn = card.querySelector('[data-action="open"]');
            openBtn?.addEventListener("click", () => highlightResultCard(flight.id));
            const deeplinkBtn = card.querySelector('[data-action="deeplink"]');
            if (flight.deeplink) {
              deeplinkBtn?.addEventListener("click", () => {
                window.open(flight.deeplink, "_blank", "noopener");
              });
            } else if (deeplinkBtn) {
              deeplinkBtn.disabled = true;
            }
            yuviaTopList.appendChild(card);
          });
        }


        async function doSearch(event) {
          event?.preventDefault();
          const originCity = originInput.value.trim();
          const destCity = destinationInput.value.trim();
          if (!originCity || !destCity) {
            alert("Укажи города вылета и прилёта");
            return;
          }
          const departDate = normalizeDepartDate();
          if (!departDate) {
            alert("Укажи дату вылета");
            return;
          }
          const returnDate = normalizeReturnDate();
          const passengers = paxState.adults + paxState.children + paxState.infants;
          const oneway = !returnDate;
          setLoading(true);
          try {
            if (!originIATA) {
              const cities = await suggestCity(originCity);
              originIATA = cities[0]?.code || "";
              originHint.textContent = `${originCity} · ${originIATA}`;
            }
            if (!destIATA) {
              const cities = await suggestCity(destCity);
              destIATA = cities[0]?.code || "";
              destHint.textContent = `${destCity} · ${destIATA}`;
            }
            if (!originIATA || !destIATA) {
              throw new Error("iata missing");
            }
            lastCurrency = getCurrencyValue();
            const searchParams = buildSearchQuery({
              origin: originIATA,
              destination: destIATA,
              currency: lastCurrency,
              departDate,
              returnDate,
              oneway,
              adults: paxState.adults,
              children: paxState.children,
              infants: paxState.infants,
              cabin: paxState.cabin,
            });
            const searchURL = API_SEARCH_PATH + "?" + searchParams.toString();

            let searchPayload;
            try {
              searchPayload = await callJSON(searchURL);
            } catch (e) {
              console.error("[Yuvia] doSearch error", e);
              alert("Не получилось получить рейсы. Попробуй снова.");
              setLoading(false);
              return;
            }

            let matrixPayload = null;
            try {
              const matrixParams = new URLSearchParams({
                origin: originIATA,
                destination: destIATA,
                currency: lastCurrency,
                center: toISO(departDate),
              });
              const matrixURL = API_MATRIX_PATH + "?" + matrixParams.toString();
              matrixPayload = await callJSON(matrixURL);
            } catch (error) {
              console.error("matrix error", error);
            }

            const context = {
  origin: originIATA,
  destination: destIATA,
  originCity,
  destCity,
  departDate,
  returnDate,
  currency: lastCurrency,
  passengers,
  oneway,
};

// ВАЖНО: используем ту же схему, что работала раньше — json.data это массив рейсов
const flightsRaw = Array.isArray(searchPayload && searchPayload.data)
  ? searchPayload.data
  : [];

// Если хочешь один-единственный лог, чтобы увидеть, что API вообще что-то прислал:
console.log("[Yuvia] flightsRaw length =", flightsRaw.length);

allResults = flightsRaw
  .map((item, index) =>
    normalizeFlight(item, {
      ...context,
      fallbackId: `${originIATA}-${destIATA}-${index}`,
    })
  )
  .filter((flight) => flight && flight.price > 0);

            updateFilterOptions();
            matrixData = normalizeMatrixResponse(matrixPayload);
            renderPriceMatrix(matrixData, toISO(departDate));
            applyFiltersAndSort();
            updateSearchSummary();
            updateAdvancedHints({ originCity, destCity });
            saveRecent({
              origin: originCity,
              destination: destCity,
              depart: toISO(departDate),
              returnDate: returnDate ? toISO(returnDate) : "",
              originIata: originIATA,
              destIata: destIATA,
            });
          } catch (error) {
            console.error("search error", error);
            alert("Не получилось получить рейсы. Попробуй снова.");
            matrixData = [];
            renderPriceMatrix(matrixData, toISO(departDate));
          } finally {
            setLoading(false);
          }
        }

        function copyDeepLink() {
          const url = new URL(window.location.href);
          url.searchParams.set("origin", originInput.value.trim());
          url.searchParams.set("destination", destinationInput.value.trim());
          url.searchParams.set("depart", departInput.value);
          url.searchParams.set("return", returnInput.value);
          const text = url.toString();
          if (navigator.clipboard?.writeText) {
            navigator.clipboard.writeText(text).then(() => {
              alert("Ссылка скопирована");
            });
          } else {
            window.prompt("Скопируйте ссылку", text);
          }
        }

        function initTripPreferenceChips() {
          $$(".chip-style").forEach((chip) => {
            chip.addEventListener("click", () => {
              tripState.style = chip.dataset.style || "calm";
              $$(".chip-style").forEach((el) => el.classList.remove("active"));
              chip.classList.add("active");
              if (allResults.length) {
                applyFiltersAndSort();
              }
            });
          });
          $$("#tripTriggerChips .chip-toggle").forEach((chip) => {
            chip.addEventListener("click", () => {
              const key = chip.dataset.trigger;
              if (!key) return;
              chip.classList.toggle("active");
              tripState.triggers[key] = chip.classList.contains("active");
              if (allResults.length) {
                applyFiltersAndSort();
              }
            });
          });
        }

        function attachFiltersHandlers() {
          [priceMinInput, priceMaxInput].forEach((input) => {
            input?.addEventListener("input", () => {
              applyFiltersAndSort();
            });
          });
          [airlineFilter, airportFilter, advAirportFilter].forEach((select) => {
            select?.addEventListener("change", () => {
              applyFiltersAndSort();
            });
          });
          $("#clearFilters")?.addEventListener("click", (event) => {
            event.preventDefault();
            clearFilters();
          });
          $("#sortBy")?.addEventListener("change", () => applyFiltersAndSort());
        }

        function attachGeneralHandlers() {
          toggleAdvancedBtn?.addEventListener("click", (event) => {
            event.preventDefault();
            advancedBlock?.classList.toggle("hidden");
          });
          $("#reset")?.addEventListener("click", (event) => {
            event.preventDefault();
            originInput.value = "";
            destinationInput.value = "";
            originIATA = "";
            destIATA = "";
            departInput.value = toISO(todayLocal);
            returnInput.value = toISO(new Date(todayLocal.getTime() + 86400000));
            priceMinInput.value = "";
            priceMaxInput.value = "";
            updateSearchSummary();
            normalizeDepartDate();
            normalizeReturnDate();
          });
          $("#copyLink")?.addEventListener("click", (event) => {
            event.preventDefault();
            copyDeepLink();
          });
          swapBtn?.addEventListener("click", (event) => {
            event.preventDefault();
            const tmp = originInput.value;
            originInput.value = destinationInput.value;
            destinationInput.value = tmp;
            [originIATA, destIATA] = [destIATA, originIATA];
            const hintTmp = originHint.textContent;
            originHint.textContent = destHint.textContent;
            destHint.textContent = hintTmp;
            updateSearchSummary();
          });
          originInput?.addEventListener("input", () => {
            originIATA = "";
            updateSearchSummary();
          });
          destinationInput?.addEventListener("input", () => {
            destIATA = "";
            updateSearchSummary();
          });
          departInput?.addEventListener("change", () => {
            normalizeDepartDate();
            normalizeReturnDate();
            updateSearchSummary();
          });
          returnInput?.addEventListener("change", () => {
            normalizeReturnDate();
            updateSearchSummary();
          });
          $("#doSearch")?.addEventListener("click", doSearch);
        }

        function initSuggests() {
          attachSuggest(originInput, handleSuggestPick("origin"));
          attachSuggest(destinationInput, handleSuggestPick("destination"));
        }

        function initNavigation() {
          function showScreen(id) {
            document.querySelectorAll(".yuvia-screen").forEach((section) => {
              section.classList.toggle("hidden", section.id !== id);
            });
          }
          window.showScreen = showScreen;
          document.querySelectorAll("[data-screen]").forEach((node) => {
            node.addEventListener("click", (event) => {
              const target = node.getAttribute("data-screen");
              if (!target) return;
              event.preventDefault();
              showScreen(target);
            });
          });
          showScreen("flights-hub");
        }

        function init() {
          initNavigation();
          initMinDateHints();
          initPaxFromAdultsSelect();
          handlePaxButtons();
          initSuggests();
          initTripPreferenceChips();
          attachFiltersHandlers();
          attachGeneralHandlers();
          renderRecent();
          updateSearchSummary();
        }

        init();
      })();
    </script>
</body>
</html>
