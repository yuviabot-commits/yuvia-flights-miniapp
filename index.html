<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yuvia Flights Mini App</title>
  <style>
    :root{
      /* Палитра под логотип */
      --bg:#f7faf8;                 /* мягкий благородный «почти белый» */
      --surface:#ffffff;
      --ink:#06352e;                /* тёмный зелёный, как контур птицы */
      --muted:#6b7280;
      --accent:#0f766e;             /* forest teal */
      --accent-soft:#e0f4ef;
      --accent-soft-2:#fdf5e6;
      --berry:#b8326a;              /* крыло-персик/berry акцент */
      --danger:#dc2626;
      --ok:#16a34a;
      --line:#e2e8f0;
      --shadow-soft:0 18px 45px rgba(15,118,110,0.09);
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      background:radial-gradient(circle at top left,#f0faf7 0,#f7faf8 40%,#f7faf8 100%);
    }

    .wrap{
      max-width:1120px;
      margin:0 auto;
      padding:20px 16px 40px;
    }

    /* Шапка с логотипом */
    .brand{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }
    .brand-logo{
      height:60px;
      width:auto;
      flex-shrink:0;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-name{
      font-size:24px;
      font-weight:650;
      letter-spacing:0.02em;
      text-transform:lowercase;
    }
    .brand-tagline{
      font-size:13px;
      color:var(--muted);
    }

    h1{display:none;} /* заголовок оставим только для SEO */

    .card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.2);
      box-shadow:var(--shadow-soft);
      padding:18px 18px 16px;
    }

    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}

    .row{display:flex; align-items:center; gap:10px}

    input, select, button{
      font:inherit;
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f9fafb;
      color:var(--ink);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(15,118,110,.25);
      background:#ffffff;
    }
    input:disabled{
      background:#f3f4f6;
      color:#9ca3af;
    }

    .label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
      margin-bottom:4px;
    }

    button{
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      padding:10px 18px;
      cursor:pointer;
      font-weight:500;
      white-space:nowrap;
      transition:background .15s ease, color .15s ease, border-color .15s ease, transform .1s ease;
    }
    button:active{transform:scale(.97)}

    .btn-primary{
      background:linear-gradient(135deg,#0f766e,#16a34a);
      color:#f9fafb;
      box-shadow:0 10px 25px rgba(15,118,110,0.25);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,#115e59,#15803d);
    }

    .btn-secondary{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:rgba(45,212,191,0.3);
    }
    .btn-secondary:hover{
      background:#c7f0e4;
    }

    .btn-ghost{
      background:transparent;
      color:var(--ink);
      border-color:var(--line);
    }
    .btn-ghost:hover{
      background:#f9fafb;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      border-radius:var(--radius-pill);
      padding:7px 11px;
      background:var(--accent-soft);
      color:var(--accent);
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(45,212,191,0.35);
      transition:background .15s ease, transform .1s ease, box-shadow .15s ease;
    }
    .chip:hover{
      background:#c7f0e4;
      box-shadow:0 4px 12px rgba(15,118,110,0.18);
      transform:translateY(-1px);
    }

    .section-title{
      margin:20px 0 10px;
      font-weight:600;
      font-size:15px;
    }

    .two-col{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:16px;
      margin-top:16px;
    }

    /* Фильтры слева */
    #filtersCard{
      align-self:flex-start;
      position:sticky;
      top:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:var(--radius-pill);
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:13px;
      cursor:pointer;
      transition:background .15s ease, border-color .15s ease, color .15s ease;
    }
    .pill input{
      width:auto;
      margin:0;
    }
    .pill input[type="radio"],
    .pill input[type="checkbox"]{
      accent-color:var(--accent);
    }
    .pill:hover{
      border-color:rgba(15,118,110,0.35);
      background:#ffffff;
    }

    .range{
      display:flex;
      align-items:center;
      gap:6px;
    }

    #airlineFilter,
    #airportFilter{
      border-radius:12px;
      border:1px solid var(--line);
      padding:6px 10px;
      background:#f9fafb;
      font-size:13px;
    }

    /* Панель сортировки */
    .toolbar{
      position:sticky;
      top:0;
      z-index:5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 14px;
      margin-bottom:4px;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(10px);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.25);
      box-shadow:0 14px 35px rgba(15,23,42,0.06);
    }
    .toolbar-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    #sortBy{
      width:auto;
      min-width:170px;
      background:#f9fafb;
    }
    #summaryChip{
      background:var(--accent-soft-2);
      border-color:#fed7aa;
      color:#9a3412;
    }

    /* Результаты */
    #results{
      display:grid;
      gap:10px;
    }
    .result{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      padding:14px 14px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#ffffff;
      box-shadow:0 10px 24px rgba(15,23,42,0.04);
    }
    .result-main-title{
      font-weight:600;
      margin-bottom:4px;
    }
    .result-meta{
      font-size:13px;
      color:var(--muted);
    }
    .result-times{
      font-size:13px;
      color:var(--ink);
    }
    .price{
      font-size:18px;
      font-weight:650;
    }

    .skeleton{
      border-radius:16px;
      height:68px;
      background:linear-gradient(90deg,#f3f4f6 0,#e5e7eb 40%,#f3f4f6 80%);
      background-size:200% 100%;
      animation:skeleton-shimmer 1.2s infinite ease-in-out;
    }
    @keyframes skeleton-shimmer{
      0%{background-position:-200% 0}
      100%{background-position:200% 0}
    }

    .bad{color:var(--danger);}
    .ok{color:var(--ok);}

    .version{
      position:fixed;
      right:10px;
      bottom:8px;
      font-size:11px;
      color:#64748b;
      background:rgba(248,250,252,0.96);
      border-radius:999px;
      border:1px solid #e2e8f0;
      padding:4px 9px;
      z-index:50;
      backdrop-filter:blur(8px);
    }

    @media (max-width:900px){
      .two-col{grid-template-columns:1fr}
      #filtersCard{position:static; order:2}
      #resultsBlock-right{order:1}
      .toolbar{
        flex-direction:column;
        align-items:flex-start;
      }
      .brand{
        flex-direction:column;
        align-items:flex-start;
      }
    }

    @media (max-width:640px){
      .actions button{flex:1}
      .brand{align-items:center;text-align:center}
      .brand-text{align-items:center}
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- Шапка с логотипом -->
  <header class="brand">
    <img src="Yuvia-logo.png" alt="Логотип Yuvia" class="brand-logo">
    <div class="brand-text">
      <div class="brand-name">yuvia</div>
      <div class="brand-tagline">умный поиск авиабилетов</div>
    </div>
  </header>

  <h1>Yuvia Flights Mini App</h1>

  <!-- Форма поиска -->
  <div class="card grid grid-2" id="searchForm">
    <div>
      <div class="label">Город вылета</div>
      <input id="origin" placeholder="Москва" autocomplete="off" />
      <div class="hint" id="originIataHint"></div>
    </div>
    <div>
      <div class="label">Город назначения</div>
      <input id="destination" placeholder="Казань" autocomplete="off" />
      <div class="hint" id="destIataHint"></div>
    </div>
    <div>
      <div class="label">Дата вылета (ДД.ММ.ГГГГ)</div>
      <input id="depart" placeholder="15.11.2025" inputmode="numeric" />
      <div class="hint" id="departHint"></div>
    </div>
    <div>
      <div class="label">Дата возвращения (опционально)</div>
      <input id="ret" placeholder="18.11.2025" inputmode="numeric" />
      <div class="hint" id="retHint"></div>
    </div>

    <div>
      <div class="label">Валюта</div>
      <select id="currency">
        <option value="RUB">RUB ₽</option>
        <option value="USD">USD $</option>
        <option value="EUR">EUR €</option>
      </select>
    </div>
    <div>
      <div class="label">Пассажиры</div>
      <select id="adults">
        <option>1</option><option>2</option><option>3</option>
        <option>4</option><option>5</option><option>6</option>
      </select>
    </div>

    <div>
      <div class="label">Только в одну сторону</div>
      <select id="oneway">
        <option value="no">Нет</option>
        <option value="yes">Да</option>
      </select>
    </div>
    <div>
      <div class="label">Гибкие даты</div>
      <select id="flexMode">
        <option value="none">Отключено</option>
        <option value="weekend">Ближайшие выходные</option>
        <option value="plus3">± 3 дня</option>
        <option value="plus7">± 7 дней</option>
      </select>
    </div>

    <div class="actions" style="grid-column:1/-1">
      <button class="btn-primary" id="doSearch">Искать билеты</button>
      <button class="btn-secondary" id="swap">Поменять местами</button>
      <button class="btn-ghost" id="copyLink">Скопировать ссылку</button>
      <button class="btn-ghost" id="reset">Сброс</button>
    </div>

    <div class="hint" id="weekendHint" style="grid-column:1/-1; display:none"></div>
  </div>

  <!-- Недавние запросы -->
  <div class="section-title">Недавние запросы</div>
  <div class="chips" id="recentChips"></div>

  <!-- Основной блок: фильтры + результаты -->
  <div class="two-col" id="resultsBlock">
    <!-- Фильтры слева -->
    <div class="card" id="filtersCard">
      <div class="section-title">Фильтры</div>

      <div class="label">Пересадки</div>
      <div class="chips" style="gap:6px; flex-wrap:wrap">
        <label class="pill"><input type="radio" name="stops" value="any" checked/> любые</label>
        <label class="pill"><input type="radio" name="stops" value="0" /> только прямые</label>
        <label class="pill"><input type="radio" name="stops" value="1" /> не более 1</label>
      </div>

      <div class="label" style="margin-top:12px">Время вылета</div>
      <div class="chips" style="gap:6px; flex-wrap:wrap">
        <label class="pill"><input type="checkbox" class="depwin" value="night"/> ночь (00–06)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="morning"/> утро (06–12)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="day"/> день (12–18)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="evening"/> вечер (18–24)</label>
      </div>

      <div class="label" style="margin-top:12px">Время прилёта</div>
      <div class="chips" style="gap:6px; flex-wrap:wrap">
        <label class="pill"><input type="checkbox" class="arrwin" value="night"/> ночь</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="morning"/> утро</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="day"/> день</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="evening"/> вечер</label>
      </div>

      <div class="label" style="margin-top:12px">Длительность (часы, максимум)</div>
      <div class="range">
        <input type="number" id="durMax" min="0" step="1" placeholder="например, 5" style="width:120px">
      </div>

      <div class="label" style="margin-top:12px">Цена</div>
      <div class="range">
        <input type="number" id="priceMin" placeholder="мин" style="width:110px">
        <span>—</span>
        <input type="number" id="priceMax" placeholder="макс" style="width:110px">
      </div>

      <div class="label" style="margin-top:12px">Авиакомпании</div>
      <select id="airlineFilter" multiple size="6" style="width:100%"></select>

      <div class="label" style="margin-top:12px">Аэропорты</div>
      <select id="airportFilter" multiple size="6" style="width:100%"></select>

      <div class="actions" style="margin-top:12px">
        <button class="btn-ghost" id="clearFilters">Сбросить фильтры</button>
      </div>
    </div>

    <!-- Правая колонка -->
    <div id="resultsBlock-right">
      <div class="toolbar" id="toolbar">
        <div class="toolbar-left">
          <div class="label">Сортировка</div>
          <select id="sortBy">
            <option value="price_asc">Сначала дешёвые</option>
            <option value="price_desc">Сначала дорогие</option>
            <option value="duration_asc">Короткий путь</option>
            <option value="depart_asc">Ранний вылет</option>
          </select>
        </div>
        <div class="chip" id="summaryChip" title="Краткая сводка по результатам">—</div>
      </div>

      <div class="section-title">Результаты</div>
      <div id="results"></div>

      <div class="section-title">Соседние даты</div>
      <div id="matrix" class="chips"></div>
    </div>
  </div>
</div>

<div class="version">версия 5</div>

<script>
/* ========= helpers ========= */
const $ = (sel)=>document.querySelector(sel);
const fmt2 = (n)=>String(n).padStart(2,'0');
const todayLocal = (()=>{ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),t.getDate()); })();

function parseDateSmart(s){
  if(!s) return null;
  s = s.trim();
  const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(iso){
    const d = new Date(+iso[1], +iso[2]-1, +iso[3]);
    return isNaN(d) ? null : d;
  }
  const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if(!m) return null;
  const d = new Date(+m[3], +m[2]-1, +m[1]);
  return isNaN(d) ? null : d;
}
function toISO(d){return d ? d.toISOString().slice(0,10) : "";}
function ddmmyyyy(d){return `${fmt2(d.getDate())}.${fmt2(d.getMonth()+1)}.${d.getFullYear()}`;}

function weekendAround(today=new Date()){
  const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const wd = t.getDay(); // 0=Вс ... 6=Сб
  let sat = new Date(t);
  sat.setDate(t.getDate() + ((6 - (wd||7)) % 7) || 7);
  if (wd === 6 || wd === 0) { sat.setDate(sat.getDate() + 7); }
  const sun = new Date(sat); sun.setDate(sat.getDate()+1);
  return {sat, sun};
}
function clampToFuture(d){
  if(!d) return null;
  return d < todayLocal ? todayLocal : d;
}
function timeWindowStrToRange(v){
  if(v==='night') return [0,6];
  if(v==='morning') return [6,12];
  if(v==='day') return [12,18];
  if(v==='evening') return [18,24];
  return null;
}

function saveRecent(item){
  const key='recent';
  const list = JSON.parse(localStorage.getItem(key)||'[]');
  const norm = JSON.stringify({...item, ts:undefined});
  const idx = list.findIndex(x=>JSON.stringify({...x,ts:undefined})===norm);
  if(idx!==-1) list.splice(idx,1);
  list.unshift({...item, ts:Date.now()});
  while(list.length>5) list.pop();
  localStorage.setItem(key, JSON.stringify(list));
  renderRecent();
}
function renderRecent(){
  const cont = $('#recentChips'); cont.innerHTML='';
  const list = JSON.parse(localStorage.getItem('recent')||'[]');
  list.forEach((r)=>{
    const chip = document.createElement('div'); chip.className='chip';
    chip.textContent = `${r.origin_city} → ${r.dest_city} ${r.depart||''}${r.oneway==='yes'?' (OW)':''}`;
    chip.onclick=()=>{applyState(r); doSearch();};
    cont.appendChild(chip);
  });
}
function applyState(st){
  $('#origin').value = st.origin_city || '';
  $('#destination').value = st.dest_city || '';
  $('#depart').value = st.depart || '';
  $('#ret').value = st.ret || '';
  $('#currency').value = st.currency || 'RUB';
  $('#adults').value = st.adults || '1';
  $('#oneway').value = st.oneway || 'no';
  $('#flexMode').value = st.flex || 'none';
  originIATA = st.origin_iata || '';
  destIATA = st.dest_iata || '';
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  toggleOneWay();
  updateWeekendHint();
}

function syncURLFromState(params){
  const qp = new URLSearchParams(window.location.search);
  Object.entries(params).forEach(([k,v])=>{
    if(v===undefined || v===null || v==='') qp.delete(k); else qp.set(k,String(v));
  });
  const url = `${location.pathname}?${qp.toString()}`;
  history.replaceState(null,'',url);
}
function restoreFromURL(){
  const p = new URLSearchParams(location.search);
  const get = (k, def='') => p.get(k) ?? def;
  const s = {
    origin_city: get('oc'),
    dest_city:   get('dc'),
    depart:      get('d'),
    ret:         get('r'),
    currency:    get('cur','RUB'),
    adults:      get('ad','1'),
    oneway:      get('ow','no'),
    flex:        get('fx','none'),
    origin_iata: get('oi') || '',
    dest_iata:   get('di') || ''
  };
  if(s.origin_city || s.dest_city) applyState(s);
}

/* ========= подсказки городов (IATA) ========= */
let originIATA = '', destIATA = '';

async function suggestCity(q){
  if(!q || q.length<2) return [];
  const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(q)}&locale=ru&types[]=city`;
  const r = await fetch(url); if(!r.ok) return [];
  return await r.json();
}

let suggestBox = null;
let suggestInput = null;

function ensureSuggestBox(){
  if (suggestBox) return suggestBox;
  suggestBox = document.createElement('div');
  Object.assign(suggestBox.style, {
    position:'absolute',
    background:'#ffffff',
    border:'1px solid #e2e8f0',
    borderRadius:'12px',
    zIndex:9999,
    minWidth:'220px',
    boxShadow:'0 18px 40px rgba(15,23,42,0.18)',
    maxHeight:'280px',
    overflowY:'auto'
  });
  suggestBox.hidden = true;
  document.body.appendChild(suggestBox);
  return suggestBox;
}
function closeSuggest(){
  if (suggestBox){
    suggestBox.hidden = true;
    suggestBox.innerHTML = '';
    suggestInput = null;
  }
}
function openSuggestFor(input, items, onPick){
  const box = ensureSuggestBox();
  box.innerHTML = '';
  items.slice(0,7).forEach(item=>{
    const row = document.createElement('div');
    row.textContent = `${item.name}, ${item.country_name} (${item.code})`;
    Object.assign(row.style, {
      padding:'8px 12px',
      cursor:'pointer',
      fontSize:'14px'
    });
    row.onmouseenter = ()=> row.style.background = '#f1f5f9';
    row.onmouseleave = ()=> row.style.background = '#ffffff';
    row.onmousedown = (e)=>{ e.preventDefault(); }; // чтобы blur не убегал
    row.onclick = ()=>{
      input.value = item.name;
      onPick(item);
      closeSuggest();
    };
    box.appendChild(row);
  });
  const r = input.getBoundingClientRect();
  box.style.left = (r.left + window.scrollX) + 'px';
  box.style.top  = (r.bottom + window.scrollY + 4) + 'px';
  box.style.width = r.width + 'px';
  suggestInput = input;
  box.hidden = false;
}

document.addEventListener('pointerdown', (e)=>{
  if (!suggestBox || suggestBox.hidden) return;
  if (e.target === suggestInput) return;
  if (!suggestBox.contains(e.target)) closeSuggest();
}, true);
window.addEventListener('scroll', closeSuggest, true);
window.addEventListener('resize', closeSuggest);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSuggest(); });

function attachSuggest(inputEl, onPick){
  inputEl.addEventListener('input', async ()=>{
    const q = inputEl.value.trim();
    if (q.length < 2){ closeSuggest(); return; }
    const list = await suggestCity(q);
    if (!list.length){ closeSuggest(); return; }
    openSuggestFor(inputEl, list, onPick);
  });

  inputEl.addEventListener('blur', ()=>{
    setTimeout(closeSuggest, 120);
  });

  inputEl.addEventListener('focus', ()=>{
    const q = inputEl.value.trim();
    if (q.length >= 2){
      suggestCity(q).then(list=>{
        if (list.length) openSuggestFor(inputEl, list, onPick);
      });
    }
  });
}

attachSuggest($('#origin'), (item)=>{ originIATA=item.code; $('#originIataHint').textContent='IATA: '+originIATA; });
attachSuggest($('#destination'), (item)=>{ destIATA=item.code; $('#destIataHint').textContent='IATA: '+destIATA; });

/* ========= переключатель one-way ========= */
function toggleOneWay(){
  const ow = $('#oneway').value==='yes';
  const ret = $('#ret');
  if(ow){ ret.value=''; ret.disabled=true; $('#retHint').textContent=''; }
  else { ret.disabled=false; }
}
$('#oneway').addEventListener('change', ()=>{ toggleOneWay(); syncURLFromState({ow:$('#oneway').value});});

/* ========= гибкие даты ========= */
function updateWeekendHint(){
  const fm = $('#flexMode').value;
  const h = $('#weekendHint');
  if(fm!=='weekend'){ h.style.display='none'; return; }
  const {sat,sun}=weekendAround(new Date());
  h.style.display='block';
  h.textContent = `Ближайшие выходные: ${ddmmyyyy(sat)} — ${ddmmyyyy(sun)}`;
}
$('#flexMode').addEventListener('change', ()=>{ updateWeekendHint(); syncURLFromState({fx:$('#flexMode').value}); });

/* ========= диплинк ========= */
const MARKER = 672309;
function buildDeeplink({ori, dst, d1, d2, currency, adults, oneway}){
  const DD1 = d1 ? (fmt2(d1.getDate()) + fmt2(d1.getMonth()+1)) : '';
  const DD2 = d2 ? (fmt2(d2.getDate()) + fmt2(d2.getMonth()+1)) : '';
  let slug = '';
  if(oneway==='yes'){
    slug = `/${ori}${DD1}${dst}1`;
  } else {
    slug = `/${ori}${DD1}${dst}${DD2}1`;
  }
  const params = new URLSearchParams({
    marker: MARKER,
    with_request: 'true',
    adults: String(adults||1),
    currency: (currency||'RUB').toLowerCase(),
    utm_source: 'yuvia_miniapp'
  });
  return `https://www.aviasales.ru/search${slug}?${params.toString()}`;
}

/* ========= API helpers ========= */
const API_BASE = 'https://yuvia-flights-api.yuviabot.workers.dev';
async function callJSON(path){
  const url = path.startsWith('http') ? path : API_BASE + path;
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/* ========= состояние ========= */
let allResults = [];
let baseCurrency = 'RUB';

function showLoading(){
  const r = $('#results'); r.innerHTML='';
  for(let i=0;i<4;i++){
    const s=document.createElement('div'); s.className='skeleton'; r.appendChild(s);
  }
}
function showMatrix(chips){
  const m = $('#matrix'); m.innerHTML='';
  chips.forEach(c=>{
    const el = document.createElement('div'); el.className='chip';
    el.textContent = `${c.dstr} · от ${c.price} ${c.currency}`;
    el.onclick = ()=>{ $('#depart').value=c.dstr; syncURLFromState({d:c.dstr}); doSearch(); };
    m.appendChild(el);
  });
}
function renderAirlinesFilter(){
  const sel = $('#airlineFilter');
  const set = new Set(allResults.map(x=>x.airline).filter(Boolean));
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>`<option value="${a}">${a}</option>`).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function renderAirportsFilter(){
  const sel = $('#airportFilter');
  const set = new Set();
  allResults.forEach(x=>{
    if(x.origin_airport) set.add(`FROM:${x.origin_airport}`);
    if(x.dest_airport) set.add(`TO:${x.dest_airport}`);
  });
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>`<option value="${a}">${a.replace(/^FROM:/,'Отправление: ').replace(/^TO:/,'Прибытие: ')}</option>`).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function summarize(){
  if(!allResults.length){ $('#summaryChip').textContent='—'; return; }
  const prices = allResults.map(x=>x.price).sort((a,b)=>a-b);
  const min = prices[0], p50 = prices[Math.floor(prices.length/2)], p90 = prices[Math.floor(prices.length*0.9)];
  $('#summaryChip').textContent = `от ${min.toLocaleString('ru-RU')} · медиана ${p50.toLocaleString('ru-RU')} · p90 ${p90.toLocaleString('ru-RU')} ${baseCurrency}`;
}

function withinWindow(timeStr, windowsSelected){
  if(!windowsSelected.length || !timeStr) return true;
  const m = timeStr.match(/^(\d{2}):(\d{2})/);
  if(!m) return true;
  const hh = +m[1] + (+m[2]/60);
  return windowsSelected.some(w=>{
    const [a,b]=timeWindowStrToRange(w); return (hh>=a && hh<b);
  });
}

function applyFiltersAndSort(){
  const r = $('#results'); r.innerHTML='';
  if(!allResults.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML = `<div class="bad">Ничего не нашли.</div>
      <div class="hint">Попробуй поменять даты, валюту или снять фильтры. Ниже — цены на соседние дни.</div>`;
    r.appendChild(empty);
    return;
  }

  const stops = (document.querySelector('input[name="stops"]:checked')||{}).value || 'any';
  const depWins = Array.from(document.querySelectorAll('.depwin:checked')).map(x=>x.value);
  const arrWins = Array.from(document.querySelectorAll('.arrwin:checked')).map(x=>x.value);
  const durMax = parseInt($('#durMax').value,10);
  const pmin = parseInt($('#priceMin').value,10);
  const pmax = parseInt($('#priceMax').value,10);
  const airlineSel = new Set(Array.from($('#airlineFilter').selectedOptions||[]).map(o=>o.value));
  const airportSel = new Set(Array.from($('#airportFilter').selectedOptions||[]).map(o=>o.value));

  let list = allResults.filter(x=>{
    if(stops==='0' && x.transfers>0) return false;
    if(stops==='1' && x.transfers>1) return false;
    if(Number.isFinite(durMax) && x.duration_hours>durMax) return false;
    if(Number.isFinite(pmin) && x.price<pmin) return false;
    if(Number.isFinite(pmax) && x.price>pmax) return false;
    if(airlineSel.size && !airlineSel.has(x.airline)) return false;
    if(airportSel.size){
      const from = `FROM:${x.origin_airport||''}`;
      const to   = `TO:${x.dest_airport||''}`;
      if(!airportSel.has(from) && !airportSel.has(to)) return false;
    }
    if(!withinWindow(x.depTime, depWins)) return false;
    if(!withinWindow(x.arrTime, arrWins)) return false;
    return true;
  });

  const s = $('#sortBy').value;
  list.sort((a,b)=>{
    if(s==='price_asc')  return a.price-b.price;
    if(s==='price_desc') return b.price-a.price;
    if(s==='duration_asc') return a.duration-b.duration;
    if(s==='depart_asc') return (a.depSort||0) - (b.depSort||0);
    return 0;
  });

  if(!list.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML = `<div class="bad">После применения фильтров ничего не осталось.</div>
      <div class="hint">Сними часть фильтров или расширь диапазоны.</div>`;
    r.appendChild(empty);
    return;
  }

  list.forEach(x=>{
    const el = document.createElement('div'); el.className='result';
    const left = document.createElement('div');
    left.innerHTML = `
      <div class="result-main-title">${x.origin} ${x.origin_airport?`(${x.origin_airport})`:''} → ${x.destination} ${x.dest_airport?`(${x.dest_airport})`:''}</div>
      <div class="result-meta">${x.depDateStr}${x.retDateStr?(' — '+x.retDateStr):''} · ${x.airline || 'авиакомпания неизвестна'} · пересадок: ${x.transfers} · длительность: ${x.durStr || (x.duration_hours?x.duration_hours+' ч':'—')}</div>
      <div class="result-times">${x.depTime?('вылет: '+x.depTime):''} ${x.arrTime?('· прилёт: '+x.arrTime):''}</div>
    `;
    const right = document.createElement('div'); right.style.textAlign='right';
    right.innerHTML = `
      <div class="price">${x.price.toLocaleString('ru-RU')} ${x.currency}</div>
      <div class="row" style="justify-content:flex-end; margin-top:6px">
        <a href="${x.deeplink}" target="_blank" rel="noopener"><button class="btn-primary">На Aviasales</button></a>
      </div>
    `;
    el.appendChild(left); el.appendChild(right);
    r.appendChild(el);
  });
}

;['change','input'].forEach(ev=>{
  $('#sortBy').addEventListener(ev, applyFiltersAndSort);
  $('#priceMin').addEventListener(ev, applyFiltersAndSort);
  $('#priceMax').addEventListener(ev, applyFiltersAndSort);
  $('#durMax').addEventListener(ev, applyFiltersAndSort);
  $('#airlineFilter').addEventListener(ev, applyFiltersAndSort);
  $('#airportFilter').addEventListener(ev, applyFiltersAndSort);
  document.querySelectorAll('input[name="stops"]').forEach(n=>n.addEventListener(ev, applyFiltersAndSort));
  document.querySelectorAll('.depwin').forEach(n=>n.addEventListener(ev, applyFiltersAndSort));
  document.querySelectorAll('.arrwin').forEach(n=>n.addEventListener(ev, applyFiltersAndSort));
});

/* ========= матрица и поиск ========= */
function showError(msg){
  $('#results').innerHTML = `<div class="card"><div class="bad">Ошибка: ${msg}</div><div class="hint">Попробуй повторить поиск позже.</div></div>`;
}
function normalizeFlight(x, {ori, dst, cur, d1, d2, oneway, adults}){
  const depDateStr = x.depart_date ? x.depart_date.split('T')[0].split('-').reverse().join('.') : '';
  const retDateStr = x.return_date ? x.return_date.split('T')[0].split('-').reverse().join('.') : '';
  const deeplink = buildDeeplink({ ori, dst, d1, d2:(oneway==='yes'?null:d2), currency: cur, adults, oneway });
  const depTime = x.depart_time || '';
  const arrTime = x.arrival_time || x.arr_time || '';
  const hh = depTime ? parseInt(depTime.slice(0,2),10) : null;
  return {
    origin: x.origin, destination: x.destination,
    origin_airport: x.origin_airport || x.origin_airport_code || '',
    dest_airport: x.destination_airport || x.destination_airport_code || '',
    price: Math.round(x.price), currency: x.currency || cur,
    airline: x.airline || x.airline_code || '',
    transfers: (typeof x.transfers==='number') ? x.transfers : (x.number_of_changes ?? 0),
    duration: x.duration || (x.duration_to ?? 0),
    duration_hours: x.duration_hours ?? Math.round(((x.duration||0)/60) || 0),
    durStr: x.duration_str || '',
    depTime, arrTime,
    depSort: (hh===null?0:hh*60 + (parseInt(depTime.slice(3,5),10)||0)),
    depDateStr, retDateStr,
    deeplink
  };
}
function showMatrixSafe(ori,dst,cur,d1,flex){
  const params = new URLSearchParams({ origin:ori, destination:dst, currency:cur, center: toISO(d1) });
  if(flex==='plus3') params.set('range','3');
  else if(flex==='plus7') params.set('range','7');
  else if(flex==='weekend') params.set('range','1');
  else params.set('range','0');
  return callJSON(`/api/matrix?${params.toString()}`)
    .then(m=>{
      const chips = (m.data||[]).slice(0,12).map(it=>({ dstr: it.date_str, price: it.price, currency: it.currency }));
      showMatrix(chips);
    })
    .catch(()=>{ /* молча */ });
}

async function doSearch(){
  const oriCity = $('#origin').value.trim();
  const dstCity = $('#destination').value.trim();
  if(!oriCity || !dstCity){ alert('Укажи города вылета и назначения'); return; }

  async function ensureIata(city){
    const s = await suggestCity(city); return s[0]?.code || '';
  }
  if(!originIATA) originIATA = await ensureIata(oriCity);
  if(!destIATA)   destIATA   = await ensureIata(dstCity);
  const ori = originIATA, dst = destIATA;
  if(!ori || !dst){ alert('Не удалось определить IATA код(ы)'); return; }

  const ow = $('#oneway').value;
  const cur = $('#currency').value; baseCurrency = cur;
  const adults = +$('#adults').value || 1;

  let d1 = clampToFuture(parseDateSmart($('#depart').value));
  let d2 = parseDateSmart($('#ret').value);
  const flex = $('#flexMode').value;

  if(flex==='weekend'){
    const {sat,sun}=weekendAround(new Date());
    d1=sat; if(ow!=='yes') d2=sun;
    $('#depart').value = ddmmyyyy(d1);
    if(ow!=='yes') $('#ret').value = ddmmyyyy(d2);
  }
  if(!d1){ $('#departHint').textContent='Укажи дату вылета формата ДД.ММ.ГГГГ'; alert('Укажи дату вылета'); return; }
  if(d1<todayLocal){ d1=todayLocal; $('#depart').value=ddmmyyyy(d1); }
  if(ow!=='yes' && d2 && d2<d1){ $('#retHint').textContent='Возврат не может быть раньше вылета'; alert('Дата возврата раньше вылета'); return; }
  if(ow==='yes'){ $('#retHint').textContent=''; }

  const state = {
    origin_city: oriCity, dest_city: dstCity,
    origin_iata: ori, dest_iata: dst,
    depart: $('#depart').value, ret: $('#ret').value,
    currency: cur, adults: String(adults), oneway: ow, flex
  };
  saveRecent(state);
  syncURLFromState({
    oc:oriCity, dc:dstCity, d:state.depart, r:state.ret, cur:cur, ad:adults, ow:ow, fx:flex, oi:ori, di:dst
  });

  showLoading();
  showMatrixSafe(ori,dst,cur,d1,flex);

  const q = new URLSearchParams({
    origin: ori, destination: dst, currency: cur,
    oneway: ow==='yes'?'1':'0',
    depart: toISO(d1), ret: (ow==='yes'||!d2)?'':toISO(d2),
    adults: String(adults)
  });

  let json;
  try{
    json = await callJSON(`/api/search?${q.toString()}`);
  }catch(e){
    showError(e.message||'network');
    return;
  }
  const listRaw = (json.data||[]).filter(x=>x.price>0 && x.origin===ori && x.destination===dst);
  allResults = listRaw.map(x=>normalizeFlight(x,{ori,dst,cur,d1,d2,oneway:ow,adults}));

  renderAirlinesFilter();
  renderAirportsFilter();
  summarize();
  applyFiltersAndSort();
}

/* ========= кнопки ========= */
$('#doSearch').addEventListener('click', doSearch);
$('#swap').addEventListener('click', ()=>{
  const a=$('#origin').value, b=$('#destination').value;
  $('#origin').value=b; $('#destination').value=a;
  const ia=originIATA; originIATA=destIATA; destIATA=ia;
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  syncURLFromState({oc:$('#origin').value.trim(), dc:$('#destination').value.trim(), oi:originIATA, di:destIATA});
});
$('#copyLink').addEventListener('click', ()=>{
  const ori=originIATA, dst=destIATA;
  const d1=parseDateSmart($('#depart').value), d2=parseDateSmart($('#ret').value);
  const link = buildDeeplink({
    ori, dst, d1, d2, currency: $('#currency').value, adults: +$('#adults').value||1, oneway: $('#oneway').value
  });
  navigator.clipboard.writeText(link).then(()=>alert('Ссылка скопирована'));
});
$('#reset').addEventListener('click', ()=>{
  $('#searchForm').querySelectorAll('input').forEach(i=>i.value='');
  $('#currency').value='RUB'; $('#adults').value='1'; $('#oneway').value='no'; $('#flexMode').value='none';
  originIATA=''; destIATA=''; $('#originIataHint').textContent=''; $('#destIataHint').textContent='';
  $('#results').innerHTML=''; $('#matrix').innerHTML=''; updateWeekendHint();
  syncURLFromState({oc:null,dc:null,d:null,r:null,cur:null,ad:null,ow:null,fx:null,oi:null,di:null});
});
$('#clearFilters').addEventListener('click', ()=>{
  document.querySelector('input[name="stops"][value="any"]').checked=true;
  document.querySelectorAll('.depwin,.arrwin').forEach(cb=>cb.checked=false);
  $('#durMax').value=''; $('#priceMin').value=''; $('#priceMax').value='';
  Array.from($('#airlineFilter').options).forEach(o=>o.selected=false);
  Array.from($('#airportFilter').options).forEach(o=>o.selected=false);
  applyFiltersAndSort();
});

/* ========= init ========= */
function initMinDateHints(){
  $('#departHint').textContent = `Не раньше ${ddmmyyyy(todayLocal)}`;
}
updateWeekendHint();
renderRecent();
toggleOneWay();
initMinDateHints();
restoreFromURL();
</script>
</body>
</html>

