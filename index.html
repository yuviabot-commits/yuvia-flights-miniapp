<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yuvia ¬∑ –ü–æ–∏—Å–∫ –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤</title>

  <!-- –ò–∫–æ–Ω–∫–∞ –≤–∫–ª–∞–¥–∫–∏ -->
  <link rel="icon" type="image/png" href="favicon.png" sizes="256x256">
  <link rel="shortcut icon" type="image/png" href="favicon.png">

  <style>
    :root{
      /* –ü–∞–ª–∏—Ç—Ä–∞ –ø–æ–¥ –ª–æ–≥–æ—Ç–∏–ø */
      --bg:#ffffff;
      --surface:#ffffff;
      --ink:#053227;
      --muted:#6b7280;

      --accent:#075e54;
      --accent-soft:#e3f3ee;
      --accent-soft-2:#fff7e3;
      --berry:#b1365b;
      --sun:#f6c453;

      --danger:#dc2626;
      --ok:#16a34a;
      --line:#e2e8f0;
      --shadow-soft:0 18px 45px rgba(7,94,84,0.10);
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    .wrap{
      max-width:1140px;
      margin:0 auto;
      padding:18px 16px 32px;
    }

    .card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.28);
      box-shadow:var(--shadow-soft);
      padding:14px 18px;
    }

    /* —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —á—É—Ç—å —Ç–µ–º–Ω–µ–µ */
    #searchForm{
      background:#f3faf8;
      border-color:rgba(7,94,84,0.18);
    }

    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .row{display:flex; gap:10px; align-items:center}

    input, select, button{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      padding:10px 12px;
      background:#ffffff;
    }

    input:focus, select:focus{
      outline:none;
      border-color:rgba(34,197,133,0.9);
      box-shadow:0 0 0 1px rgba(34,197,133,0.4);
    }

    button{
      cursor:pointer;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      padding:10px 18px;
      background:var(--accent);
      color:#f9fafb;
      font-weight:500;
      white-space:nowrap;
    }

    .btn-primary{
      background:linear-gradient(135deg,#075e54,#0f766e);
      color:#f9fafb;
      box-shadow:0 10px 25px rgba(7,94,84,0.35);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,#064e3b,#0d6b60);
    }
    .btn-secondary{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:rgba(45,212,191,0.6);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border-color:rgba(148,163,184,0.6);
    }

    .btn-sm{
      padding:6px 10px;
      font-size:13px;
      border-radius:999px;
    }

    .hint{font-size:12px;color:var(--muted);margin-top:3px}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}

    .section-title{
      margin:18px 0 10px;
      font-weight:600;
      font-size:16px;
    }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border-radius:var(--radius-pill);
      padding:7px 11px;
      background:rgba(177,54,91,0.08);
      color:#7a1238;
      border:1px solid rgba(177,54,91,0.35);
      font-size:13px;
      cursor:pointer;
    }
    .chip#summaryChip{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:rgba(45,212,191,0.45);
      cursor:default;
    }

    .divider{
      height:1px;
      margin:14px 0 10px;
      background:linear-gradient(90deg,rgba(148,163,184,0.3),rgba(148,163,184,0));
    }

    .two-col{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      gap:16px;
      margin-top:12px;
    }

    .filters-block .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:var(--radius-pill);
      border:1px solid var(--line);
      font-size:13px;
      background:#f9fafb;
    }

    .filters-block .pill input{
      width:auto;
      padding:0;
      border:none;
      box-shadow:none;
    }

    .toolbar{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--surface);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:var(--radius-pill);
      padding:8px 11px;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .toolbar select{
      border-radius:999px;
      padding:7px 14px;
    }

    /* -------- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: –Ω–æ–≤—ã–π –≤–∏–¥ -------- */
    .result{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:14px 16px;
      margin-bottom:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#ffffff;
      transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease;
    }
    .result:hover{
      box-shadow:0 18px 40px rgba(15,23,42,0.12);
      transform:translateY(-1px);
      border-color:rgba(7,94,84,0.25);
    }

    .result-main{
      display:grid;
      grid-template-columns:minmax(0,260px) minmax(0,1fr) auto;
      gap:12px;
      align-items:center;
    }

    .result-main-left-top{
      font-size:18px;
      font-weight:600;
      margin-bottom:2px;
    }
    .result-main-left-sub{
      font-size:13px;
      color:var(--muted);
    }
    .result-main-left-times{
      margin-top:4px;
      font-size:14px;
    }

    .result-main-right{
      text-align:right;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

    .price{
      font-weight:700;
      font-size:18px;
      white-space:nowrap;
    }

    .airline-logo-wrap{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }

    .airline-logo{
      width:34px;
      height:34px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:600;
      color:var(--accent);
    }
    .airline-logo img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }

    .result-main-right .btn-primary{
      margin-top:6px;
    }

    /* –õ–∏–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ + –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ç–∏—á–∫–∏ */
    .route-timeline{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .route-timeline-top{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--muted);
    }
    .route-line{
      position:relative;
      height:6px;
      border-radius:999px;
      background:linear-gradient(90deg,rgba(7,94,84,0.15),rgba(7,94,84,0.05));
      overflow:hidden;
    }
    .route-line-fill{
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,#0d9488,#16a34a);
      opacity:0.18;
    }
    .route-bird-plane{
      position:absolute;
      top:50%;
      left:0;
      transform:translate(-10%, -50%);
      width:22px;
      height:22px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid rgba(34,197,133,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      box-shadow:0 4px 12px rgba(7,94,84,0.35);
      animation:fly-route 6s ease-in-out infinite;
    }

    @keyframes fly-route{
      0%{
        transform:translate(-10%, -50%);
      }
      50%{
        transform:translate(110%, -60%);
      }
      100%{
        transform:translate(-10%, -50%);
      }
    }

    /* –±–µ–π–¥–∂–∏ */
    .result-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(148,163,184,0.6);
      background:#f9fafb;
      color:#111827;
    }

    .badge-soft{
      background:var(--accent-soft);
      border-color:rgba(45,212,191,0.6);
      color:var(--accent);
    }

    .badge-rating{
      background:#ecfdf3;
      border-color:rgba(16,185,129,0.6);
      color:#047857;
      font-weight:600;
    }

    .badge-stress-low{
      background:#ecfdf3;
      border-color:rgba(16,185,129,0.6);
      color:#047857;
    }
    .badge-stress-medium{
      background:var(--accent-soft-2);
      border-color:rgba(250,204,21,0.6);
      color:#92400e;
    }
    .badge-stress-high{
      background:#fef2f2;
      border-color:rgba(248,113,113,0.7);
      color:#b91c1c;
    }

    .badge-chip{
      background:#f3f4f6;
      border-color:#e5e7eb;
      color:#4b5563;
    }

    .badge-yuvia{
      background:var(--accent);
      border-color:var(--accent);
      color:#ecfeff;
      box-shadow:0 8px 22px rgba(7,94,84,0.45);
    }

    .result-footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      border-top:1px dashed #e5e7eb;
      padding-top:8px;
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .result-footer-actions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }

    .result-footer strong{
      color:var(--ink);
    }

    .bad{color:var(--danger)}
    .ok{color:var(--ok)}

    .skeleton{
      height:62px;
      border-radius:12px;
      background:linear-gradient(90deg,#f4f7fb 25%,#edf2f7 37%,#f4f7fb 63%);
      background-size:200% 100%;
      animation:sh 1.1s ease-in-out infinite;
    }
    @keyframes sh{
      0%{background-position:-200% 0}
      100%{background-position:200% 0}
    }

    /* –ë—Ä–µ–Ω–¥ –≤ —à–∞–ø–∫–µ */
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:12px;
    }
    .brand-logo{
      width:72px;
      height:auto;
    }
    .brand-name{
      font-size:26px;
      font-weight:650;
      letter-spacing:0.03em;
    }
    .brand-tagline{
      font-size:13px;
      color:var(--muted);
    }
    .brand-subline{
      font-size:13px;
      color:var(--berry);
      text-transform:none;
      letter-spacing:.06em;
      margin-top:4px;
      font-weight:500;
    }

    .advanced.hidden{display:none;}

    /* ------- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞: 4 –ª–∏–Ω–∏–∏ ------- */

    /* –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤ —à–∞–ø–∫–µ */
    .search-grid input,
    .pax-trigger{
      height:48px;
      padding-top:9px;
      padding-bottom:9px;
    }

    /* —Å–µ—Ç–∫–∞ –ø–æ–ª–µ–π –ø–æ–∏—Å–∫–∞ */
    .search-grid{
      display:grid;
      grid-template-columns:
        1.25fr   /* –û—Ç–∫—É–¥–∞ */
        52px     /* –°—Ç—Ä–µ–ª–∫–∞ */
        1.25fr   /* –ö—É–¥–∞ */
        0.9fr    /* –î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞ */
        0.9fr    /* –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è */
        1.05fr;  /* –ü–∞—Å—Å–∞–∂–∏—Ä—ã */
      grid-auto-rows:auto;
      column-gap:14px;
      row-gap:4px;
      align-items:start;
    }

    .search-grid .label{
      margin:0;
      align-self:end;
    }

    .search-grid .hint{
      margin:0;
      align-self:start;
      font-size:12px;
    }

    .pax-hint-placeholder{
      min-height:16px;
      font-size:12px;
      align-self:start;
    }

    /* –∫–ª–µ—Ç–∫–∞ —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π */
    .swap-cell{
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translateX(-10px);
    }
    .swap-cell--full{}

    .swap-btn{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(7,94,84,0.18);
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      line-height:1;
      color:#075e54;
      box-shadow:0 6px 18px rgba(7,94,84,0.20);
      cursor:pointer;
      padding:0;
    }
    .swap-btn:hover{
      background:#ecfdf5;
    }

    /* 4-—è —Å—Ç—Ä–æ–∫–∞ ‚Äì –∫–Ω–æ–ø–∫–∏ */
    .search-actions-row{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    /* –ü–∞—Å—Å–∞–∂–∏—Ä—ã */
    .pax-field{position:relative;}

    .pax-trigger{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      padding:6px 34px 6px 12px;
      background:#ffffff;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      justify-content:center;
      cursor:pointer;
      position:relative;
      color:var(--ink);
    }

    .pax-main{
      font-size:13px;
      font-weight:600;
    }
    .pax-sub{
      font-size:10px;
      color:#9ca3af;
      margin-top:1px;
    }

    .pax-chevron{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:13px;
      color:var(--muted);
    }

    .pax-panel{
      position:absolute;
      right:0;
      margin-top:6px;
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 18px 45px rgba(15,23,42,0.18);
      padding:14px 18px 12px;
      width:280px;
      z-index:50;
    }
    .pax-panel.hidden{
      display:none;
    }

    .pax-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .pax-label-wrap{
      max-width:60%;
    }
    .pax-title{
      font-size:14px;
      font-weight:500;
    }
    .pax-note{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .pax-counter{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pax-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#ffffff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:20px;
      line-height:1;
      color:var(--accent);
      padding:0;
    }
    .pax-count{
      width:18px;
      text-align:center;
      font-weight:500;
    }

    .pax-cabin{
      margin-top:8px;
      border-radius:999px;
      border:1px solid var(--line);
      display:grid;
      grid-template-columns:1fr 1fr;
      overflow:hidden;
    }
    .pax-cabin-btn{
      border:none;
      border-radius:0;
      padding:8px 4px;
      font-size:13px;
      background:#f9fafb;
      color:var(--muted);
    }
    .pax-cabin-btn.active{
      background:var(--accent);
      color:#ffffff;
    }

    /* –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ */
    .favorites-block,
    .compare-block{
      margin-bottom:10px;
      background:#f9fafb;
      border-style:dashed;
      border-color:#d1d5db;
    }

    .favorites-list,
    .compare-list{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }

    .mini-flight{
      border-radius:14px;
      border:1px solid #e5e7eb;
      background:#ffffff;
      padding:8px 10px;
      font-size:13px;
      min-width:180px;
      cursor:pointer;
    }
    .mini-flight:hover{
      border-color:var(--accent);
      box-shadow:0 8px 20px rgba(15,23,42,0.12);
    }
    .mini-flight-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .mini-flight-meta{
      font-size:12px;
      color:var(--muted);
    }

    .hidden{display:none !important;}

    @media (max-width:900px){
      .two-col{grid-template-columns:1fr}

      .search-grid{
        grid-template-columns:1fr;
      }

      .swap-cell{
        justify-content:flex-start;
      }

      .search-actions-row{
        justify-content:flex-start;
        flex-wrap:wrap;
      }

      .pax-panel{
        right:auto;
        left:0;
      }

      .result-main{
        grid-template-columns:1fr;
        align-items:flex-start;
      }

      .result-main-right{
        align-items:flex-start;
        text-align:left;
      }

      .result-footer{
        flex-direction:column;
        align-items:flex-start;
      }
      .result-footer-actions{
        justify-content:flex-start;
      }
    }

    /* overlay –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-overlay{
      position:fixed;
      inset:0;
      background:#ffffff;
      backdrop-filter:blur(12px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .loading-overlay.hidden{display:none;}

    .loading-inner{
      text-align:center;
    }

    .loading-logo-wrap{
      position:relative;
      display:inline-block;
      max-width:260px;
      width:100%;
      margin:0 auto;
      animation:logo-float 3s ease-in-out infinite;
    }

    .loading-logo-video{
      display:block;
      max-width:260px;
      max-height:40vh;
      width:100%;
      height:auto;
      border-radius:24px;
    }

    .loading-logo-wrap::before{
      content:"";
      position:absolute;
      left:10%;
      right:10%;
      bottom:-10px;
      height:18px;
      border-radius:999px;
      background:radial-gradient(ellipse at center, rgba(7,94,84,0.45), transparent 60%);
      filter:blur(8px);
      opacity:0.75;
      animation:glow-pulse 2.2s ease-in-out infinite;
    }

    @keyframes logo-float{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(-8px); }
    }

    @keyframes glow-pulse{
      0%,100%{
        transform:scaleX(1);
        opacity:0.6;
      }
      50%{
        transform:scaleX(1.12);
        opacity:0.9;
      }
    }

    .loading-text{
      margin-top:14px;
      font-size:16px;
      color:var(--muted);
    }

    .version{
      position:fixed;
      bottom:8px;
      right:10px;
      font-size:12px;
      color:#64748b;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius:8px;
      padding:4px 7px;
      z-index:990;
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- –ë—Ä–µ–Ω–¥ -->
  <header class="brand">
    <img src="Logo-Full.png" alt="Yuvia" class="brand-logo">
    <div class="brand-text">
      <div class="brand-name">Yuvia</div>
      <div class="brand-tagline">–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–≤–µ–ª-–∫–æ–Ω—Å—å–µ—Ä–∂</div>
      <div class="brand-subline">–ø–æ–∏—Å–∫ –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤</div>
    </div>
  </header>

  <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
  <div class="card" id="searchForm">
    <div class="search-grid">
      <!-- –õ–∏–Ω–∏—è 1: —Ç–µ–∫—Å—Ç -->
      <div class="label">–û—Ç–∫—É–¥–∞</div>
      <div></div>
      <div class="label">–ö—É–¥–∞</div>
      <div class="label">–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞</div>
      <div class="label">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è</div>
      <div class="label">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</div>

      <!-- –õ–∏–Ω–∏—è 2: –±–ª–æ–∫–∏ -->
      <div>
        <input id="origin" placeholder="–ú–æ—Å–∫–≤–∞" autocomplete="off" />
      </div>

      <div class="swap-cell swap-cell--full">
        <button type="button" class="swap-btn" id="swapInline" aria-label="–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏ –≥–æ—Ä–æ–¥–∞">‚áÜ</button>
      </div>

      <div>
        <input id="destination" placeholder="–ö–∞–∑–∞–Ω—å" autocomplete="off" />
      </div>

      <div>
        <input id="depart" type="date" />
      </div>

      <div>
        <input id="ret" type="date" />
      </div>

      <div class="pax-field">
        <button type="button" class="pax-trigger" id="paxTrigger">
          <div class="pax-main" id="paxMainText">1 –ø–∞—Å—Å–∞–∂–∏—Ä</div>
          <div class="pax-sub" id="paxSubText">—ç–∫–æ–Ω–æ–º</div>
          <span class="pax-chevron">‚ñæ</span>
        </button>

        <!-- —Å–∫—Ä—ã—Ç—ã–π —Å–µ–ª–µ–∫—Ç –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
        <select id="adults" style="display:none">
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
        </select>

        <!-- –ø–∞–Ω–µ–ª—å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ -->
        <div class="pax-panel hidden" id="paxPanel">
          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">–í–∑—Ä–æ—Å–ª—ã–µ</div>
              <div class="pax-note">–æ—Ç 12 –ª–µ—Ç</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="adults" data-delta="-1">‚àí</button>
              <div class="pax-count" data-kind="adults">1</div>
              <button class="pax-btn" type="button" data-kind="adults" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">–î–µ—Ç–∏</div>
              <div class="pax-note">–æ—Ç 2 –¥–æ 12 –ª–µ—Ç</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="children" data-delta="-1">‚àí</button>
              <div class="pax-count" data-kind="children">0</div>
              <button class="pax-btn" type="button" data-kind="children" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">–ú–ª–∞–¥–µ–Ω—Ü—ã</div>
              <div class="pax-note">–¥–æ 2 –ª–µ—Ç (–±–µ–∑ –º–µ—Å—Ç–∞)</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="infants" data-delta="-1">‚àí</button>
              <div class="pax-count" data-kind="infants">0</div>
              <button class="pax-btn" type="button" data-kind="infants" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-cabin">
            <button type="button" class="pax-cabin-btn active" data-cabin="eco">–≠–∫–æ–Ω–æ–º</button>
            <button type="button" class="pax-cabin-btn" data-cabin="business">–ë–∏–∑–Ω–µ—Å</button>
          </div>
        </div>
      </div>

      <!-- –õ–∏–Ω–∏—è 3: –ø–æ–¥—Å–∫–∞–∑–∫–∏ -->
      <div class="hint" id="originIataHint"></div>
      <div></div>
      <div class="hint" id="destIataHint"></div>
      <div class="hint" id="departHint"></div>
      <div class="hint" id="retHint"></div>
      <div class="pax-hint-placeholder"></div>
    </div>

    <!-- 4 —Å—Ç—Ä–æ–∫–∞: –∫–Ω–æ–ø–∫–∏ -->
    <div class="search-actions-row">
      <button class="btn-primary" id="doSearch">–ò—Å–∫–∞—Ç—å</button>
      <button class="btn-ghost" id="toggleAdvanced">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫</button>
    </div>

    <!-- —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –±–ª–æ–∫ -->
    <div id="advancedBlock" class="advanced hidden">
      <div class="divider"></div>
      <div class="grid grid-2">
        <div>
          <div class="label">–í–∞–ª—é—Ç–∞</div>
          <select id="currency">
            <option value="RUB">RUB ‚ÇΩ</option>
            <option value="USD">USD $</option>
            <option value="EUR">EUR ‚Ç¨</option>
          </select>
        </div>
        <div>
          <div class="label">–ú–∞—Ä—à—Ä—É—Ç</div>
          <select id="oneway">
            <option value="no">–¢—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ</option>
            <option value="yes">–¢–æ–ª—å–∫–æ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É</option>
          </select>
        </div>
        <div>
          <div class="label">–ì–∏–±–∫–∏–µ –¥–∞—Ç—ã</div>
          <select id="flexMode">
            <option value="none">–û—Ç–∫–ª—é—á–µ–Ω–æ</option>
            <option value="weekend">–ë–ª–∏–∂–∞–π—à–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ</option>
            <option value="plus3">¬± 3 –¥–Ω—è</option>
            <option value="plus7">¬± 7 –¥–Ω–µ–π</option>
          </select>
        </div>
        <div>
          <div class="label">–ö–ª–∞—Å—Å –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</div>
          <select id="cabin">
            <option value="eco">–≠–∫–æ–Ω–æ–º</option>
            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end;gap:6px;align-items:flex-end">
          <button class="btn-secondary" id="swap">–ü–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏</button>
          <button class="btn-ghost" id="copyLink">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="btn-ghost" id="reset">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        </div>
      </div>
      <div class="hint" id="weekendHint" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã -->
  <div class="section-title">–ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã</div>
  <div class="chips" id="recentChips"></div>

  <!-- –§–∏–ª—å—Ç—Ä—ã + —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
  <div class="two-col">
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card filters-block">
      <div class="section-title" style="margin-top:0">–§–∏–ª—å—Ç—Ä—ã</div>

      <div class="label">–ü–µ—Ä–µ—Å–∞–¥–∫–∏</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="radio" name="stops" value="any" checked> –ª—é–±—ã–µ</label>
        <label class="pill"><input type="radio" name="stops" value="0"> —Ç–æ–ª—å–∫–æ –ø—Ä—è–º—ã–µ</label>
        <label class="pill"><input type="radio" name="stops" value="1"> –Ω–µ –±–æ–ª–µ–µ 1</label>
      </div>

      <div class="label" style="margin-top:10px">–í—Ä–µ–º—è –≤—ã–ª–µ—Ç–∞</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="checkbox" class="depwin" value="night"> –Ω–æ—á—å (00‚Äì06)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="morning"> —É—Ç—Ä–æ (06‚Äì12)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="day"> –¥–µ–Ω—å (12‚Äì18)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="evening"> –≤–µ—á–µ—Ä (18‚Äì24)</label>
      </div>

      <div class="label" style="margin-top:10px">–í—Ä–µ–º—è –ø—Ä–∏–ª—ë—Ç–∞</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="checkbox" class="arrwin" value="night"> –Ω–æ—á—å</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="morning"> —É—Ç—Ä–æ</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="day"> –¥–µ–Ω—å</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="evening"> –≤–µ—á–µ—Ä</label>
      </div>

      <div class="label" style="margin-top:10px">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á–∞—Å—ã, –º–∞–∫—Å–∏–º—É–º)</div>
      <input type="number" id="durMax" min="0" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 5" style="width:100%">

      <div class="label" style="margin-top:10px">–¶–µ–Ω–∞</div>
      <div class="row" style="gap:6px;align-items:center">
        <input type="number" id="priceMin" placeholder="–º–∏–Ω" style="flex:1;min-width:0">
        <span>‚Äî</span>
        <input type="number" id="priceMax" placeholder="–º–∞–∫—Å" style="flex:1;min-width:0">
      </div>

      <div class="label" style="margin-top:10px">–ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏</div>
      <select id="airlineFilter" multiple size="6" style="width:100%"></select>

      <div class="label" style="margin-top:10px">–ê—ç—Ä–æ–ø–æ—Ä—Ç—ã</div>
      <select id="airportFilter" multiple size="6" style="width:100%"></select>

      <button class="btn-ghost" id="clearFilters" style="margin-top:12px;width:100%">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div>
      <!-- –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–π—Å—ã -->
      <div id="favoritesBlock" class="card favorites-block hidden"></div>

      <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–π—Å–æ–≤ -->
      <div id="compareBlock" class="card compare-block hidden"></div>

      <div class="toolbar">
        <div class="label" style="margin:0">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</div>
        <select id="sortBy">
          <option value="yuvia_score">–°–Ω–∞—á–∞–ª–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ Yuvia</option>
          <option value="price_asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à—ë–≤—ã–µ</option>
          <option value="price_desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
          <option value="duration_asc">–ö–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å</option>
          <option value="depart_asc">–†–∞–Ω–Ω–∏–π –≤—ã–ª–µ—Ç</option>
        </select>
        <div class="chip" id="summaryChip" title="–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ —Ü–µ–Ω–µ">‚Äî</div>
      </div>

      <div class="section-title" style="margin-top:4px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
      <div id="results" class="grid"></div>

      <div class="section-title">–°–æ—Å–µ–¥–Ω–∏–µ –¥–∞—Ç—ã</div>
      <div id="matrix" class="chips"></div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-inner">
    <div class="loading-logo-wrap">
      <video
        class="loading-logo-video"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      >
        <source src="Yuvia_Anim.webm" type="video/webm">
      </video>
    </div>
    <div class="loading-text">–ò—â–µ–º –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã...</div>
  </div>
</div>

<div class="version">–≤–µ—Ä—Å–∏—è 13.1</div>

<script>
/* ========= helpers ========= */
const $ = (sel)=>document.querySelector(sel);
const fmt2 = (n)=>String(n).padStart(2,'0');
const todayLocal = (()=>{ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),t.getDate()); })();

function parseDateSmart(s){
  if(!s) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [y,m,d] = s.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    return isNaN(dt)?null:dt;
  }
  if(/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(s)){
    const [dd,mm,yy] = s.split('.').map(Number);
    const dt = new Date(yy, mm-1, dd);
    return isNaN(dt)?null:dt;
  }
  return null;
}
function toISO(d){
  if(!d) return "";
  const y = d.getFullYear();
  const m = fmt2(d.getMonth() + 1);
  const day = fmt2(d.getDate());
  return `${y}-${m}-${day}`;
}

function ddmmyyyy(d){return `${fmt2(d.getDate())}.${fmt2(d.getMonth()+1)}.${d.getFullYear()}`;}

function weekendAround(today=new Date()){
  const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const wd = t.getDay();
  let sat = new Date(t);
  sat.setDate(t.getDate() + ((6 - (wd||7)) % 7) || 7);
  if (wd === 6 || wd === 0) { sat.setDate(sat.getDate() + 7); }
  const sun = new Date(sat); sun.setDate(sat.getDate()+1);
  return {sat, sun};
}
function clampToFuture(d){
  if(!d) return null;
  return d < todayLocal ? todayLocal : d;
}

function timeWindowStrToRange(v){
  if(v==='night') return [0,6];
  if(v==='morning') return [6,12];
  if(v==='day') return [12,18];
  if(v==='evening') return [18,24];
  return null;
}

/* ========= state: –Ω–µ–¥–∞–≤–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã ========= */
function saveRecent(item){
  const key='recent';
  const list = JSON.parse(localStorage.getItem(key)||'[]');
  const norm = JSON.stringify({...item, ts:undefined});
  const idx = list.findIndex(x=>JSON.stringify({...x,ts:undefined})===norm);
  if(idx!==-1) list.splice(idx,1);
  list.unshift({...item, ts:Date.now()});
  while(list.length>5) list.pop();
  localStorage.setItem(key, JSON.stringify(list));
  renderRecent();
}
function renderRecent(){
  const cont = $('#recentChips'); cont.innerHTML='';
  const list = JSON.parse(localStorage.getItem('recent')||'[]');
  list.forEach(r=>{
    const chip = document.createElement('div'); chip.className='chip';
    const d = r.depart ? ddmmyyyy(parseDateSmart(r.depart)) : '';
    chip.textContent = `${r.origin_city} ‚Üí ${r.dest_city} ${d}${r.oneway==='yes'?' (OW)':''}`;
    chip.onclick=()=>{applyState(r); doSearch();};
    cont.appendChild(chip);
  });
}
function applyState(st){
  $('#origin').value = st.origin_city || '';
  $('#destination').value = st.dest_city || '';
  $('#depart').value = st.depart || '';
  $('#ret').value = st.ret || '';
  $('#currency').value = st.currency || 'RUB';
  $('#adults').value = st.adults || '1';
  $('#oneway').value = st.oneway || 'no';
  $('#flexMode').value = st.flex || 'none';
  originIATA = st.origin_iata || '';
  destIATA = st.dest_iata || '';
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  toggleOneWay();
  updateWeekendHint();
}
function syncURLFromState(params){
  const qp = new URLSearchParams(window.location.search);
  Object.entries(params).forEach(([k,v])=>{
    if(v===undefined || v===null || v==='') qp.delete(k); else qp.set(k,String(v));
  });
  const url = `${location.pathname}?${qp.toString()}`;
  history.replaceState(null,'',url);
}
function restoreFromURL(){
  const p = new URLSearchParams(location.search);
  const get = (k, def='') => p.get(k) ?? def;
  const s = {
    origin_city: get('oc'),
    dest_city:   get('dc'),
    depart:      get('d'),
    ret:         get('r'),
    currency:    get('cur','RUB'),
    adults:      get('ad','1'),
    oneway:      get('ow','no'),
    flex:        get('fx','none'),
    origin_iata: get('oi') || '',
    dest_iata:   get('di') || ''
  };
  if(s.origin_city || s.dest_city) applyState(s);
}

/* ========= –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ ========= */
let originIATA = '', destIATA = '';

async function suggestCity(q){
  if(!q || q.length<2) return [];
  const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(q)}&locale=ru&types[]=city`;
  const r = await fetch(url); if(!r.ok) return [];
  return await r.json();
}

let suggestBox = null;
let suggestInput = null;
function ensureSuggestBox(){
  if(suggestBox) return suggestBox;
  suggestBox = document.createElement('div');
  Object.assign(suggestBox.style,{
    position:'absolute',
    background:'#ffffff',
    border:'1px solid #e2e8f0',
    borderRadius:'8px',
    boxShadow:'0 12px 30px rgba(15,23,42,0.15)',
    zIndex:9999,
    minWidth:'220px',
    maxHeight:'260px',
    overflowY:'auto',
    fontSize:'14px'
  });
  document.body.appendChild(suggestBox);
  suggestBox.hidden = true;
  return suggestBox;
}
function closeSuggest(){
  if(!suggestBox) return;
  suggestBox.hidden = true;
  suggestBox.innerHTML = '';
  suggestInput = null;
}
function openSuggestFor(input, items, onPick){
  const box = ensureSuggestBox();
  box.innerHTML = '';
  items.slice(0,7).forEach(item=>{
    const row = document.createElement('div');
    row.textContent = `${item.name}, ${item.country_name} (${item.code})`;
    Object.assign(row.style,{padding:'8px 10px',cursor:'pointer'});
    row.onmouseenter=()=>row.style.background='#f1f5f9';
    row.onmouseleave=()=>row.style.background='#ffffff';
    row.onmousedown = e=>e.preventDefault();
    row.onclick=()=>{
      input.value=item.name;
      onPick(item);
      closeSuggest();
    };
    box.appendChild(row);
  });
  const r = input.getBoundingClientRect();
  box.style.left = (r.left + window.scrollX)+'px';
  box.style.top = (r.bottom + window.scrollY)+'px';
  box.style.width = r.width+'px';
  suggestInput = input;
  box.hidden = false;
}
document.addEventListener('pointerdown',(e)=>{
  if(!suggestBox || suggestBox.hidden) return;
  if(e.target===suggestInput) return;
  if(!suggestBox.contains(e.target)) closeSuggest();
},true);
window.addEventListener('scroll',closeSuggest,true);
window.addEventListener('resize',closeSuggest);
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSuggest(); });

function attachSuggest(inputEl, onPick){
  inputEl.addEventListener('input', async ()=>{
    const q = inputEl.value.trim();
    if(q.length<2){ closeSuggest(); return; }
    const list = await suggestCity(q);
    if(!list.length){ closeSuggest(); return; }
    openSuggestFor(inputEl,list,onPick);
  });
  inputEl.addEventListener('focus', async ()=>{
    const q = inputEl.value.trim();
    if(q.length<2){ return; }
    const list = await suggestCity(q);
    if(list.length) openSuggestFor(inputEl,list,onPick);
  });
}

attachSuggest($('#origin'), (item)=>{ originIATA=item.code; $('#originIataHint').textContent='IATA: '+originIATA; });
attachSuggest($('#destination'), (item)=>{ destIATA=item.code; $('#destIataHint').textContent='IATA: '+destIATA; });

/* ========= one-way ========= */
function toggleOneWay(){
  const ow = $('#oneway').value==='yes';
  const ret = $('#ret');
  if(ow){ ret.value=''; ret.disabled=true; $('#retHint').textContent=''; }
  else { ret.disabled=false; }
}
$('#oneway').addEventListener('change',()=>{
  toggleOneWay();
  syncURLFromState({ow:$('#oneway').value});
});

/* ========= –≥–∏–±–∫–∏–µ –¥–∞—Ç—ã ========= */
function updateWeekendHint(){
  const fm = $('#flexMode').value;
  const h = $('#weekendHint');
  if(fm!=='weekend'){ h.textContent=''; return; }
  const {sat,sun}=weekendAround(new Date());
  h.textContent = `–ë–ª–∏–∂–∞–π—à–∏–µ –≤—ã—Ö–æ–¥–Ω—ã–µ: ${ddmmyyyy(sat)} ‚Äî ${ddmmyyyy(sun)}`;
}
$('#flexMode').addEventListener('change',()=>{
  updateWeekendHint();
  syncURLFromState({fx:$('#flexMode').value});
});

/* ========= –¥–∏–ø–ª–∏–Ω–∫ –Ω–∞ Aviasales ========= */
const MARKER = 672309;
function buildDeeplink({ori, dst, d1, d2, currency, adults, oneway}){
  const DD1 = d1 ? (fmt2(d1.getDate()) + fmt2(d1.getMonth()+1)) : '';
  const DD2 = d2 ? (fmt2(d2.getDate()) + fmt2(d2.getMonth()+1)) : '';
  let slug = '';
  if(oneway==='yes'){
    slug = `/${ori}${DD1}${dst}1`;
  } else {
    slug = `/${ori}${DD1}${dst}${DD2}1`;
  }
  const params = new URLSearchParams({
    marker: MARKER,
    with_request: 'true',
    adults: String(adults||1),
    currency: (currency||'RUB').toLowerCase(),
    utm_source: 'yuvia_miniapp'
  });
  return `https://www.aviasales.ru/search${slug}?${params.toString()}`;
}

/* ========= API ========= */
const API_BASE = 'https://yuvia-flights-api.yuviabot.workers.dev';

async function callJSON(path){
  const url = path.startsWith('http') ? path : API_BASE + path;
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/* ========= —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ + –∏–∑–±—Ä–∞–Ω–Ω–æ–µ/—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ========= */
let allResults = [];
let baseCurrency = 'RUB';
let favorites = [];
let compareList = [];

function loadFavorites(){
  try{
    favorites = JSON.parse(localStorage.getItem('yuvia_favs') || '[]');
  }catch(e){
    favorites = [];
  }
}
function saveFavorites(){
  localStorage.setItem('yuvia_favs', JSON.stringify(favorites));
}
function isFavorite(id){
  return favorites.some(f=>f.id===id);
}

function toggleFavoriteById(id){
  const idx = favorites.findIndex(f=>f.id===id);
  if(idx!==-1){
    favorites.splice(idx,1);
  }else{
    const f = allResults.find(x=>x.id===id);
    if(f) favorites.push(f);
  }
  saveFavorites();
  renderFavoritesBlock();
  applyFiltersAndSort(); // —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –æ–±–Ω–æ–≤–∏–ª–∏—Å—å
}

function clearFavorites(){
  favorites = [];
  saveFavorites();
  renderFavoritesBlock();
  applyFiltersAndSort();
}

/* —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ */
function isInCompare(id){
  return compareList.some(f=>f.id===id);
}
function toggleCompareById(id){
  const idx = compareList.findIndex(f=>f.id===id);
  if(idx!==-1){
    compareList.splice(idx,1);
  }else{
    const f = allResults.find(x=>x.id===id);
    if(f) compareList.push(f);
  }
  renderCompareBlock();
  applyFiltersAndSort();
}
function clearCompare(){
  compareList = [];
  renderCompareBlock();
}

function scrollToResult(id){
  const el = document.querySelector(`.result[data-id="${id}"]`);
  if(!el) return;
  el.classList.add('highlighted');
  el.scrollIntoView({behavior:'smooth', block:'center'});
  setTimeout(()=>el.classList.remove('highlighted'), 1600);
}

/* ========= skeleton + matrix ========= */
function showLoadingSkeleton(){
  const r = $('#results'); r.innerHTML='';
  for(let i=0;i<4;i++){
    const s=document.createElement('div'); s.className='skeleton'; r.appendChild(s);
  }
}
function showMatrix(chips){
  const m = $('#matrix'); m.innerHTML='';
  chips.forEach(c=>{
    const el=document.createElement('div'); el.className='chip';
    el.textContent = `${c.dstr} ¬∑ –æ—Ç ${c.price} ${c.currency}`;
    el.onclick=()=>{
      const dt = parseDateSmart(c.dstr);
      if(dt) $('#depart').value = toISO(dt);
      syncURLFromState({d:$('#depart').value});
      doSearch();
    };
    m.appendChild(el);
  });
}
function renderAirlinesFilter(){
  const sel = $('#airlineFilter');
  const set = new Set(allResults.map(x=>x.airline).filter(Boolean));
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>`<option value="${a}">${a}</option>`).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function renderAirportsFilter(){
  const sel = $('#airportFilter');
  const set = new Set();
  allResults.forEach(x=>{
    if(x.origin_airport) set.add(`FROM:${x.origin_airport}`);
    if(x.dest_airport) set.add(`TO:${x.dest_airport}`);
  });
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>{
    return `<option value="${a}">${a.replace(/^FROM:/,'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ').replace(/^TO:/,'–ü—Ä–∏–±—ã—Ç–∏–µ: ')}</option>`;
  }).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function summarize(){
  if(!allResults.length){ $('#summaryChip').textContent='‚Äî'; return; }
  const prices = allResults.map(x=>x.price).sort((a,b)=>a-b);
  const min = prices[0];
  const avg = Math.round(prices.reduce((s,v)=>s+v,0)/prices.length);
  $('#summaryChip').textContent = `–æ—Ç ${min.toLocaleString('ru-RU')} ¬∑ —Å—Ä–µ–¥–Ω—è—è ${avg.toLocaleString('ru-RU')} ${baseCurrency}`;
}

/* ========= –ò–∑–±—Ä–∞–Ω–Ω–æ–µ / —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ========= */
function renderFavoritesBlock(){
  const block = $('#favoritesBlock');
  if(!block) return;
  if(!favorites.length){
    block.classList.add('hidden');
    block.innerHTML='';
    return;
  }
  block.classList.remove('hidden');
  const listHtml = favorites.map(f=>{
    const title=`${f.origin} ‚Üí ${f.destination}`;
    const meta=`${f.depDateStr || ''}${f.duration_hours? ' ¬∑ '+f.duration_hours+' —á':''}`;
    return `
      <div class="mini-flight" onclick="scrollToResult('${f.id}')">
        <div class="mini-flight-title">${title}</div>
        <div class="mini-flight-meta">${meta} ¬∑ ${f.price.toLocaleString('ru-RU')} ${f.currency}</div>
      </div>`;
  }).join('');
  block.innerHTML = `
    <div class="section-title" style="margin-top:0">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–π—Å—ã</div>
    <div class="favorites-list">${listHtml}</div>
    <button class="btn-ghost btn-sm" style="margin-top:8px" onclick="clearFavorites()">–û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
  `;
}

function renderCompareBlock(){
  const block = $('#compareBlock');
  if(!block) return;
  if(!compareList.length){
    block.classList.add('hidden');
    block.innerHTML='';
    return;
  }
  block.classList.remove('hidden');
  const listHtml = compareList.map(f=>{
    const title=`${f.origin} ‚Üí ${f.destination}`;
    const meta=`${f.depDateStr || ''}${f.duration_hours? ' ¬∑ '+f.duration_hours+' —á':''}`;
    return `
      <div class="mini-flight" onclick="scrollToResult('${f.id}')">
        <div class="mini-flight-title">${title}</div>
        <div class="mini-flight-meta">${meta} ¬∑ ${f.price.toLocaleString('ru-RU')} ${f.currency}</div>
      </div>`;
  }).join('');
  block.innerHTML = `
    <div class="section-title" style="margin-top:0">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–π—Å–æ–≤ (${compareList.length})</div>
    <div class="compare-list">${listHtml}</div>
    <button class="btn-ghost btn-sm" style="margin-top:8px" onclick="clearCompare()">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
  `;
}

/* ========= —Ñ–∏–ª—å—Ç—Ä—ã ========= */
function withinWindow(timeStr, windowsSelected){
  if(!windowsSelected.length || !timeStr) return true;
  const m = timeStr.match(/^(\d{2}):(\d{2})/);
  if(!m) return true;
  const hh = +m[1] + (+m[2]/60);
  return windowsSelected.some(w=>{
    const [a,b]=timeWindowStrToRange(w); return (hh>=a && hh<b);
  });
}

/* ========= —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ========= */
function applyFiltersAndSort(){
  const r = $('#results'); r.innerHTML='';
  if(!allResults.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML=`<div class="bad">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏.</div><div class="hint">–ü–æ–ø—Ä–æ–±—É–π –ø–æ–º–µ–Ω—è—Ç—å –¥–∞—Ç—ã, –≤–∞–ª—é—Ç—É –∏–ª–∏ —Å–Ω—è—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã. –ù–∏–∂–µ ‚Äî —Ü–µ–Ω—ã –Ω–∞ —Å–æ—Å–µ–¥–Ω–∏–µ –¥–Ω–∏.</div>`;
    r.appendChild(empty);
    return;
  }

  const stops = (document.querySelector('input[name="stops"]:checked')||{}).value || 'any';
  const depWins = Array.from(document.querySelectorAll('.depwin:checked')).map(x=>x.value);
  const arrWins = Array.from(document.querySelectorAll('.arrwin:checked')).map(x=>x.value);
  const durMax = parseInt($('#durMax').value,10);
  const pmin = parseInt($('#priceMin').value,10);
  const pmax = parseInt($('#priceMax').value,10);
  const airlineSel = new Set(Array.from($('#airlineFilter').selectedOptions||[]).map(o=>o.value));
  const airportSel = new Set(Array.from($('#airportFilter').selectedOptions||[]).map(o=>o.value));

  let list = allResults.filter(x=>{
    if(stops==='0' && x.transfers>0) return false;
    if(stops==='1' && x.transfers>1) return false;
    if(Number.isFinite(durMax) && x.duration_hours>durMax) return false;
    if(Number.isFinite(pmin) && x.price<pmin) return false;
    if(Number.isFinite(pmax) && x.price>pmax) return false;
    if(airlineSel.size && !airlineSel.has(x.airline)) return false;
    if(airportSel.size){
      const from = `FROM:${x.origin_airport||''}`;
      const to   = `TO:${x.dest_airport||''}`;
      if(!airportSel.has(from) && !airportSel.has(to)) return false;
    }
    if(!withinWindow(x.depTime, depWins)) return false;
    if(!withinWindow(x.arrTime, arrWins)) return false;
    return true;
  });

  const s = $('#sortBy').value;
  list.sort((a,b)=>{
    if(s==='yuvia_score') return (b.rating||0)-(a.rating||0);
    if(s==='price_asc') return a.price-b.price;
    if(s==='price_desc') return b.price-a.price;
    if(s==='duration_asc') return a.duration-b.duration;
    if(s==='depart_asc') return (a.depSort||0)-(b.depSort||0);
    return 0;
  });

  if(!list.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML=`<div class="bad">–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å.</div><div class="hint">–°–Ω–∏–º–∏ —á–∞—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã.</div>`;
    r.appendChild(empty);
    return;
  }

  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –±–µ–π–¥–∂–∞ "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è Yuvia"
  const maxRating = Math.max(...list.map(f=>f.rating||0), 0);

  list.forEach(x=>{
    const el=document.createElement('div'); el.className='result';
    el.dataset.id = x.id;

    const transfersText = x.transfers===0
      ? '–±–µ–∑ –ø–µ—Ä–µ—Å–∞–¥–æ–∫'
      : x.transfers===1
        ? '1 –ø–µ—Ä–µ—Å–∞–¥–∫–∞'
        : `${x.transfers} –ø–µ—Ä–µ—Å–∞–¥–∫–∏`;

    const durationLabel = x.durStr || (x.duration_hours?`${x.duration_hours} —á`:'‚Äî');

    const ratingStr = x.rating ? x.rating.toFixed(1).replace('.',',') : '';
    const stressMap = {low:'–Ω–∏–∑–∫–∏–π',medium:'—Å—Ä–µ–¥–Ω–∏–π',high:'–≤—ã—Å–æ–∫–∏–π'};
    const stressLabel = x.stressLevel ? stressMap[x.stressLevel] : '';
    const stressClass = x.stressLevel ? `badge-stress-${x.stressLevel}` : '';

    const isFav = isFavorite(x.id);
    const inCompare = isInCompare(x.id);

    const logoHtml = x.airlineCode ? `
      <div class="airline-logo">
        <img src="https://pics.avs.io/48/48/${x.airlineCode}.png" alt="${x.airlineCode}" onerror="this.parentNode.textContent='${(x.airlineCode||'').slice(0,2)}'">
      </div>` : `
      <div class="airline-logo">${(x.airlineCode||x.airline||'').slice(0,2) || '‚Äî'}</div>
    `;

    const isRecommended = x.rating && (x.rating >= maxRating - 0.3);

    el.innerHTML = `
      <div class="result-main">
        <div>
          <div class="result-main-left-top">${x.origin} ${x.origin_airport?`(${x.origin_airport})`:''} ‚Üí ${x.destination} ${x.dest_airport?`(${x.dest_airport})`:''}</div>
          <div class="result-main-left-sub">${x.depDateStr}${x.retDateStr?(' ‚Äî '+x.retDateStr):''}</div>
          <div class="result-main-left-times">
            ${x.depTime || '--:--'} ¬∑ –ø—Ä–∏–ª—ë—Ç ${x.arrTime || '--:--'}
          </div>
        </div>
        <div class="route-timeline">
          <div class="route-timeline-top">
            <span>${durationLabel}</span>
            <span>${transfersText}</span>
          </div>
          <div class="route-line">
            <div class="route-line-fill"></div>
            <div class="route-bird-plane" aria-hidden="true">üïäÔ∏è‚úàÔ∏è</div>
          </div>
        </div>
        <div class="result-main-right">
          <div class="price">${x.price.toLocaleString('ru-RU')} ${x.currency}</div>
          <div class="airline-logo-wrap">
            ${logoHtml}
            <span>${x.airline || '–∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}</span>
          </div>
          <a href="${x.deeplink}" target="_blank" rel="noopener">
            <button class="btn-primary btn-sm">–ù–∞ Aviasales</button>
          </a>
        </div>
      </div>

      <div class="result-tags">
        ${ratingStr ? `<span class="badge badge-rating" title="–û—Ü–µ–Ω–∫–∞ Yuvia: —É—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ—Å–∞–¥–∫–∏, –Ω–æ—á–Ω—ã–µ –ø–µ—Ä–µ–ª—ë—Ç—ã –∏ –µ—â—ë –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–æ—Ä–æ–≤.">–û—Ü–µ–Ω–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ ${ratingStr}</span>` : ''}
        ${stressLabel ? `<span class="badge ${stressClass}" title="–°—Ç—Ä–µ—Å—Å Yuvia: –Ω–æ—á–Ω—ã–µ –≤—ã–ª–µ—Ç—ã, –∫–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—ã–∫–æ–≤–∫–∏, —Å–º–µ–Ω–∞ –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤ –∏ —Ç.–ø.">—Å—Ç—Ä–µ—Å—Å: ${stressLabel}</span>` : ''}
        <span class="badge badge-chip">${transfersText}</span>
        ${x.duration_hours ? `<span class="badge badge-chip">–≤ –ø—É—Ç–∏ ~${x.duration_hours} —á</span>` : ''}
        ${isRecommended ? `<span class="badge badge-yuvia">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è Yuvia</span>` : ''}
      </div>

      <div class="result-footer">
        <div>
          <strong>–¢—É–¥–∞:</strong> ${x.depDateStr || ''}${x.depTime?(' ¬∑ –≤—ã–ª–µ—Ç '+x.depTime):''}
          ${x.arrTime?(' ¬∑ –ø—Ä–∏–ª—ë—Ç '+x.arrTime):''}
          <br>
          <strong>–ü–µ—Ä–µ—Å–∞–¥–∫–∏:</strong> ${transfersText}
        </div>
        <div class="result-footer-actions">
          <button type="button" class="btn-ghost btn-sm btn-fav" data-id="${x.id}">
            ${isFav ? '‚òÖ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : '‚òÜ –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}
          </button>
          <button type="button" class="btn-ghost btn-sm btn-compare" data-id="${x.id}">
            ${inCompare ? '‚úì –í —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏' : '‚áÑ –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ'}
          </button>
          <button type="button" class="btn-ghost btn-sm btn-help" data-id="${x.id}">
            –ü–æ–º–æ—â—å Yuvia
          </button>
        </div>
      </div>
    `;
    r.appendChild(el);
  });

  // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ/—Å—Ä–∞–≤–Ω–µ–Ω–∏—è/–ø–æ–º–æ—â–∏
  document.querySelectorAll('.btn-fav').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id = btn.getAttribute('data-id');
      toggleFavoriteById(id);
    });
  });
  document.querySelectorAll('.btn-compare').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id = btn.getAttribute('data-id');
      toggleCompareById(id);
    });
  });
  document.querySelectorAll('.btn-help').forEach(btn=>{
    btn.addEventListener('click',()=>{
      alert('–°–∫–æ—Ä–æ –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è AI-—Ä–∞–∑–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–∞ –æ—Ç Yuvia ‚ú®');
    });
  });
}

['change','input'].forEach(ev=>{
  $('#sortBy').addEventListener(ev,applyFiltersAndSort);
  $('#priceMin').addEventListener(ev,applyFiltersAndSort);
  $('#priceMax').addEventListener(ev,applyFiltersAndSort);
  $('#durMax').addEventListener(ev,applyFiltersAndSort);
  $('#airlineFilter').addEventListener(ev,applyFiltersAndSort);
  $('#airportFilter').addEventListener(ev,applyFiltersAndSort);
  document.querySelectorAll('input[name="stops"]').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
  document.querySelectorAll('.depwin').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
  document.querySelectorAll('.arrwin').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
});

/* ========= –ø—Ä–æ—Å—Ç–∞—è "–æ—Ü–µ–Ω–∫–∞ Yuvia" ========= */
function computeRatingAndStress(x){
  let rating = 9.5;
  const t = x.duration_hours || 0;
  if(t>3) rating -= (t-3)*0.35;
  rating -= (x.transfers||0)*1.7;

  const depTime = x.depTime || '';
  if(/^(\d{2}):/.test(depTime)){
    const hh = parseInt(depTime.slice(0,2),10);
    if(hh<6 || hh>=23) rating -= 0.8; // –Ω–æ—á–Ω–æ–π –≤—ã–ª–µ—Ç
  }

  rating = Math.max(4, Math.min(10, rating));
  rating = Math.round(rating*10)/10;

  let stressLevel='medium';
  if(rating>=8.5) stressLevel='low';
  else if(rating<7) stressLevel='high';

  return {rating, stressLevel};
}

/* ========= –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–π—Å–∞ ========= */
function normalizeFlight(x,{ori,dst,cur,d1,d2,oneway,adults}){
  const depDateStr = x.depart_date ? x.depart_date.split('T')[0].split('-').reverse().join('.') : '';
  const retDateStr = x.return_date ? x.return_date.split('T')[0].split('-').reverse().join('.') : '';
  const depTime = x.depart_time || x.departure_time || '';
  const arrTime = x.arrival_time || x.arr_time || '';
  const hh = depTime ? parseInt(depTime.slice(0,2),10) : null;
  const airlineCode = x.airline_code || x.airline_iata || x.airline || '';
  const dur = x.duration || x.duration_to || 0;
  const duration_hours = x.duration_hours ?? Math.round((dur||0)/60);

  const deeplink = buildDeeplink({ori,dst,d1,d2:(oneway==='yes'?null:d2),currency:cur,adults,oneway});

  const base = {
    origin:x.origin,
    destination:x.destination,
    origin_airport:x.origin_airport || x.origin_airport_code || x.origin_airport_iata || '',
    dest_airport:x.destination_airport || x.destination_airport_code || x.destination_airport_iata || '',
    price:Math.round(x.price ?? x.value ?? 0),
    currency:x.currency || cur,
    airline:x.airline || airlineCode || '',
    airlineCode,
    transfers:(typeof x.transfers==='number')?x.transfers:(x.number_of_changes ?? 0),
    duration:dur,
    duration_to:dur,
    duration_hours,
    durStr:duration_hours?`${duration_hours} —á`:'',
    depTime, arrTime,
    depSort:(hh===null?0:hh*60 + (parseInt(depTime.slice(3,5),10)||0)),
    depDateStr, retDateStr,
    deeplink
  };

  const {rating, stressLevel} = computeRatingAndStress(base);

  const id = [
    ori,dst,
    depDateStr,retDateStr,
    depTime,arrTime,
    airlineCode,
    base.price
  ].join('|');

  return {...base, rating, stressLevel, id};
}

/* ========= matrix helper ========= */
function showMatrixSafe(ori,dst,cur,d1,flex){
  const params = new URLSearchParams({origin:ori,destination:dst,currency:cur,center:toISO(d1)});
  if(flex==='plus3') params.set('range','3');
  else if(flex==='plus7') params.set('range','7');
  else if(flex==='weekend') params.set('range','1');
  else params.set('range','0');
  return callJSON(`/api/matrix?${params.toString()}`)
    .then(m=>{
      const chips=(m.data||[]).slice(0,12).map(it=>({dstr:it.date_str,price:it.price,currency:it.currency}));
      showMatrix(chips);
    })
    .catch(()=>{});
}

/* ========= loading overlay ========= */
function setLoading(on, delay = 0){
  const ov = $('#loadingOverlay');
  if(!ov) return;
  if(on){
    ov.classList.remove('hidden');
  } else {
    if(delay > 0){
      setTimeout(()=>ov.classList.add('hidden'), delay);
    } else {
      ov.classList.add('hidden');
    }
  }
}

/* ========= –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ–∏—Å–∫ ========= */
async function doSearch(){
  const oriCity = $('#origin').value.trim();
  const dstCity = $('#destination').value.trim();
  if(!oriCity || !dstCity){ alert('–£–∫–∞–∂–∏ –≥–æ—Ä–æ–¥–∞ –≤—ã–ª–µ—Ç–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'); return; }

  async function ensureIataFor(city, known){
    if(known) return known;
    const s = await suggestCity(city);
    return s[0]?.code || '';
  }
  if(!originIATA) originIATA = await ensureIataFor(oriCity, originIATA);
  if(!destIATA) destIATA = await ensureIataFor(dstCity, destIATA);
  const ori = originIATA, dst = destIATA;
  if(!ori || !dst){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IATA –∫–æ–¥(—ã)'); return; }

  const ow = $('#oneway').value;
  const cur = $('#currency').value; baseCurrency = cur;
  const adults = +$('#adults').value || 1;

  let d1 = clampToFuture(parseDateSmart($('#depart').value));
  let d2 = parseDateSmart($('#ret').value);
  const flex = $('#flexMode').value;

  if(flex==='weekend'){
    const {sat,sun}=weekendAround(new Date());
    d1=sat; if(ow!=='yes') d2=sun;
    $('#depart').value = toISO(d1);
    if(ow!=='yes') $('#ret').value = toISO(d2);
  }
  if(!d1){ $('#departHint').textContent='–£–∫–∞–∂–∏ –¥–∞—Ç—É –≤—ã–ª–µ—Ç–∞'; alert('–£–∫–∞–∂–∏ –¥–∞—Ç—É –≤—ã–ª–µ—Ç–∞'); return; }
  if(d1<todayLocal){ d1=todayLocal; $('#depart').value=toISO(d1); }
  if(ow!=='yes' && d2 && d2<d1){ $('#retHint').textContent='–í–æ–∑–≤—Ä–∞—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –≤—ã–ª–µ—Ç–∞'; alert('–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –≤—ã–ª–µ—Ç–∞'); return; }
  if(ow==='yes'){ $('#retHint').textContent=''; }

  const state = {
    origin_city:oriCity, dest_city:dstCity,
    origin_iata:ori, dest_iata:dst,
    depart:$('#depart').value, ret:$('#ret').value,
    currency:cur, adults:String(adults), oneway:ow, flex
  };
  saveRecent(state);
  syncURLFromState({
    oc:oriCity, dc:dstCity, d:state.depart, r:state.ret,
    cur:cur, ad:adults, ow:ow, fx:flex, oi:ori, di:dst
  });

  setLoading(true);
  showLoadingSkeleton();
  showMatrixSafe(ori,dst,cur,d1,flex);

  const q = new URLSearchParams({
    origin:ori,destination:dst,currency:cur,
    oneway:ow==='yes'?'1':'0',
    depart:toISO(d1),
    ret:(ow==='yes'||!d2)?'':toISO(d2),
    adults:String(adults)
  });

  let json;
  try{
    json = await callJSON(`/api/search?${q.toString()}`);
  }catch(e){
    $('#results').innerHTML = `<div class="card"><div class="bad">–û—à–∏–±–∫–∞: ${e.message}</div><div class="hint">–ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∏—Å–∫ –ø–æ–∑–∂–µ.</div></div>`;
    setLoading(false, 4000);
    return;
  }

  const listRaw = (json.data||[]).filter(x=>x.price>0 && x.origin===ori && x.destination===dst);
  allResults = listRaw.map(x=>normalizeFlight(x,{ori,dst,cur,d1,d2,oneway:ow,adults}));

  renderAirlinesFilter();
  renderAirportsFilter();
  summarize();
  renderFavoritesBlock();
  renderCompareBlock();
  applyFiltersAndSort();
  setLoading(false, 4000);
}

/* ========= –∫–Ω–æ–ø–∫–∏ ========= */
$('#doSearch').addEventListener('click',e=>{ e.preventDefault(); doSearch(); });

function swapCities(){
  const a=$('#origin').value, b=$('#destination').value;
  $('#origin').value=b; $('#destination').value=a;
  const ia=originIATA; originIATA=destIATA; destIATA=ia;
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  syncURLFromState({oc:$('#origin').value.trim(), dc:$('#destination').value.trim(), oi:originIATA, di:destIATA});
}
['#swap','#swapInline'].forEach(id=>{
  const el = document.querySelector(id);
  if(el) el.addEventListener('click',swapCities);
});

$('#copyLink').addEventListener('click',()=>{
  const d1=parseDateSmart($('#depart').value), d2=parseDateSmart($('#ret').value);
  const link = buildDeeplink({
    ori:originIATA, dst:destIATA,
    d1,d2, currency:$('#currency').value,
    adults:+$('#adults').value||1, oneway:$('#oneway').value
  });
  navigator.clipboard.writeText(link).then(()=>alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'));
});
$('#reset').addEventListener('click',()=>{
  $('#origin').value=''; $('#destination').value='';
  $('#depart').value=''; $('#ret').value='';
  $('#currency').value='RUB'; $('#adults').value='1';
  $('#oneway').value='no'; $('#flexMode').value='none';
  originIATA=''; destIATA='';
  $('#originIataHint').textContent=''; $('#destIataHint').textContent='';
  $('#results').innerHTML=''; $('#matrix').innerHTML='';
  updateWeekendHint();
  syncURLFromState({oc:null,dc:null,d:null,r:null,cur:null,ad:null,ow:null,fx:null,oi:null,di:null});
  initPaxFromAdultsSelect();
  renderFavoritesBlock();
  renderCompareBlock();
});
$('#clearFilters').addEventListener('click',()=>{
  document.querySelector('input[name="stops"][value="any"]').checked=true;
  document.querySelectorAll('.depwin,.arrwin').forEach(cb=>cb.checked=false);
  $('#durMax').value=''; $('#priceMin').value=''; $('#priceMax').value='';
  Array.from($('#airlineFilter').options).forEach(o=>o.selected=false);
  Array.from($('#airportFilter').options).forEach(o=>o.selected=false);
  applyFiltersAndSort();
});
$('#toggleAdvanced').addEventListener('click',e=>{
  e.preventDefault();
  const block = $('#advancedBlock');
  const isHidden = block.classList.contains('hidden');
  block.classList.toggle('hidden',!isHidden);
  $('#toggleAdvanced').textContent = isHidden ? '–°–∫—Ä—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫' : '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫';
});

/* ========= –¥–∞—Ç—ã: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ========= */
function initMinDateHints(){
  const iso = toISO(todayLocal);
  $('#depart').min = iso;
  $('#ret').min = iso;
  $('#departHint').textContent = `> ${ddmmyyyy(todayLocal)}`;
}

function normalizeDepartDate(){
  let d = parseDateSmart($('#depart').value);
  d = clampToFuture(d);
  if(!d) return;
  const iso = toISO(d);
  $('#depart').value = iso;
  $('#ret').min = iso;

  const r = parseDateSmart($('#ret').value);
  if(r && r<d){
    $('#ret').value='';
    $('#retHint').textContent='';
  }
}

['change','blur','input'].forEach(ev=>{
  $('#depart').addEventListener(ev, normalizeDepartDate);
});
function normalizeReturnDate(){
  let r = parseDateSmart($('#ret').value);
  if(!r) return;
  r = clampToFuture(r);
  const d = parseDateSmart($('#depart').value);
  if(d && r < d) r = d;
  $('#ret').value = toISO(r);
}

['change','blur','input'].forEach(ev=>{
  $('#ret').addEventListener(ev, normalizeReturnDate);
});

/* ========= –±–ª–æ–∫ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ ========= */
const paxState = {adults:1, children:0, infants:0, cabin:'eco'};

function updatePaxSummary(){
  const total = paxState.adults + paxState.children + paxState.infants;
  const main = $('#paxMainText');
  const sub = $('#paxSubText');
  main.textContent = `${total} –ø–∞—Å—Å–∞–∂–∏—Ä${total===1?'':'–æ–≤'}`;
  sub.textContent = paxState.cabin==='eco' ? '—ç–∫–æ–Ω–æ–º' : '–±–∏–∑–Ω–µ—Å';

  const sel = $('#adults');
  if(sel) sel.value = String(total);

  ['adults','children','infants'].forEach(kind=>{
    const cnt = document.querySelector(`.pax-count[data-kind="${kind}"]`);
    if(cnt) cnt.textContent = paxState[kind];
  });
}

function initPaxFromAdultsSelect(){
  const sel = $('#adults');
  if(!sel) return;
  const n = parseInt(sel.value || '1',10);
  paxState.adults = isNaN(n)?1:Math.max(1,n);
  paxState.children = 0;
  paxState.infants = 0;
  paxState.cabin = 'eco';
  updatePaxSummary();
}

document.querySelectorAll('.pax-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const kind = btn.dataset.kind;
    const delta = parseInt(btn.dataset.delta,10);
    const min = kind==='adults'?1:0;
    const max = 9;
    let val = paxState[kind] + delta;
    if(val<min) val=min;
    if(val>max) val=max;
    paxState[kind] = val;
    updatePaxSummary();
  });
});

document.querySelectorAll('.pax-cabin-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    paxState.cabin = btn.dataset.cabin;
    document.querySelectorAll('.pax-cabin-btn').forEach(b=>b.classList.toggle('active',b===btn));
    const cabinSelect = $('#cabin');
    if(cabinSelect){
      cabinSelect.value = paxState.cabin;
    }
    updatePaxSummary();
  });
});

const paxTrigger = $('#paxTrigger');
const paxPanel = $('#paxPanel');
paxTrigger.addEventListener('click',()=>{
  paxPanel.classList.toggle('hidden');
});
document.addEventListener('click',e=>{
  if(!paxPanel.contains(e.target) && !paxTrigger.contains(e.target)){
    paxPanel.classList.add('hidden');
  }
});

/* ========= init ========= */
updateWeekendHint();
renderRecent();
toggleOneWay();
initMinDateHints();
restoreFromURL();
initPaxFromAdultsSelect();
loadFavorites();
renderFavoritesBlock();
renderCompareBlock();
</script>
</body>
</html>
