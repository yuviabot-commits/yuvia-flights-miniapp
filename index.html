<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yuvia · Поиск авиабилетов</title>

   <!-- Иконка вкладки -->
  <link rel="icon" type="image/png" href="favicon.png" sizes="256x256">
<link rel="shortcut icon" type="image/png" href="favicon.png">

  <style>
    :root{
      /* Палитра под логотип */
      --bg:#ffffff;                 /* чисто белый фон */
      --surface:#ffffff;
      --ink:#053227;                /* тёмная ель */
      --muted:#6b7280;

      --accent:#075e54;             /* тёмный зелёный */
      --accent-soft:#e3f3ee;
      --accent-soft-2:#fff7e3;
      --berry:#b1365b;
      --sun:#f6c453;

      --danger:#dc2626;
      --ok:#16a34a;
      --line:#e2e8f0;
      --shadow-soft:0 18px 45px rgba(7,94,84,0.10);
      --radius-lg:18px;
      --radius-pill:999px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      background:var(--bg);
    }

    .wrap{
      max-width:1140px;
      margin:0 auto;
      padding:18px 16px 32px;
    }

    .card{
      background:var(--surface);
      border-radius:var(--radius-lg);
      border:1px solid rgba(148,163,184,0.28);
      box-shadow:var(--shadow-soft);
      padding:14px 18px;
    }

    /* форма поиска чуть темнее */
    #searchForm{
      background:#f3faf8;
      border-color:rgba(7,94,84,0.18);
    }

    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .row{display:flex; gap:10px; align-items:center}

    input, select, button{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      padding:10px 12px;
      background:#ffffff;
    }

    input:focus, select:focus{
      outline:none;
      border-color:rgba(34,197,133,0.9);
      box-shadow:0 0 0 1px rgba(34,197,133,0.4);
    }

    button{
      cursor:pointer;
      border-radius:var(--radius-pill);
      border:1px solid transparent;
      padding:10px 18px;
      background:var(--accent);
      color:#f9fafb;
      font-weight:500;
      white-space:nowrap;
    }

    .btn-primary{
      background:linear-gradient(135deg,#075e54,#0f766e);
      color:#f9fafb;
      box-shadow:0 10px 25px rgba(7,94,84,0.35);
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,#064e3b,#0d6b60);
    }
    .btn-secondary{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:rgba(45,212,191,0.6);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border-color:rgba(148,163,184,0.6);
    }

    .hint{font-size:12px;color:var(--muted);margin-top:3px}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}

    .section-title{
      margin:18px 0 10px;
      font-weight:600;
      font-size:16px;
    }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border-radius:var(--radius-pill);
      padding:7px 11px;
      background:rgba(177,54,91,0.08);
      color:#7a1238;
      border:1px solid rgba(177,54,91,0.35);
      font-size:13px;
      cursor:pointer;
    }
    .chip#summaryChip{
      background:var(--accent-soft);
      color:var(--accent);
      border-color:rgba(45,212,191,0.45);
      cursor:default;
    }

    .divider{
      height:1px;
      margin:14px 0 10px;
      background:linear-gradient(90deg,rgba(148,163,184,0.3),rgba(148,163,184,0));
    }

    .two-col{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      gap:16px;
      margin-top:12px;
    }

    .filters-block .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:var(--radius-pill);
      border:1px solid var(--line);
      font-size:13px;
      background:#f9fafb;
    }

    .filters-block .pill input{
      width:auto;
      padding:0;
      border:none;
      box-shadow:none;
    }

    .toolbar{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--surface);
      border:1px solid rgba(148,163,184,0.25);
      border-radius:var(--radius-pill);
      padding:8px 11px;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .toolbar select{
      border-radius:999px;
      padding:7px 14px;
    }

    .result{
      display:grid;
      grid-template-columns:minmax(0,1fr) auto;
      gap:8px 12px;
      padding:13px 14px;
      margin-bottom:8px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#ffffff;
    }

    .result-main-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .result-meta,
    .result-times{
      font-size:13px;
      color:var(--muted);
    }
    .price{
      font-weight:700;
      font-size:18px;
      white-space:nowrap;
    }
    .airline-logo{
      display:inline-block;
      height:24px;
      width:auto;
      border-radius:6px;
      margin-top:4px;
    }

    .bad{color:var(--danger)}
    .ok{color:var(--ok)}

    .skeleton{
      height:62px;
      border-radius:12px;
      background:linear-gradient(90deg,#f4f7fb 25%,#edf2f7 37%,#f4f7fb 63%);
      background-size:200% 100%;
      animation:sh 1.1s ease-in-out infinite;
    }
    @keyframes sh{
      0%{background-position:-200% 0}
      100%{background-position:200% 0}
    }

    /* Бренд в шапке */
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:12px;
    }
    .brand-logo{
      width:72px;
      height:auto;
    }
    .brand-name{
      font-size:26px;
      font-weight:650;
      letter-spacing:0.03em;
    }
    .brand-tagline{
      font-size:13px;
      color:var(--muted);
    }
    .brand-subline{
      font-size:13px;
      color:var(--berry);
      text-transform:none;
      letter-spacing:.06em;
      margin-top:4px;
      font-weight:500;
    }

    .advanced.hidden{display:none;}

    /* ------- Форма поиска: 4 строки ------- */

/* ------- Форма поиска: 4 линии ------- */

/* одинаковая высота всех полей */
.search-grid input[type="text"],
.search-grid input[type="date"],
.pax-trigger{
  height:48px;
}

/* 3 строки внутри сетки: 
   1 — текст, 2 — поля, 3 — подсказки */
.search-grid{
  display:grid;
  grid-template-columns:
    1.15fr  /* Откуда */
    36px    /* стрелка */
    1.15fr  /* Куда */
    16px    /* отступ */
    0.9fr   /* Дата вылета */
    8px     /* маленький отступ между датами */
    0.9fr   /* Дата возвращения */
    16px    /* отступ */
    0.95fr; /* Пассажиры */
  grid-template-rows:auto auto auto;
  row-gap:4px;
}


    /* 4-я строка – кнопки */
    .search-actions-row{
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
/* строка 1 — текст, прижат к НИЗУ клетки */
.search-grid .label{
  margin:0;
  align-self:flex-end;
}

/* строка 3 — подсказки, прижаты к ВЕРХУ клетки */
.search-grid .hint{
  margin:0;
  align-self:flex-start;
  font-size:12px;
}
/* стрелка — один блок на три строки, по центру */
.swap-cell{
  display:flex;
  align-items:center;
  justify-content:center;
}
.swap-cell--full{
  grid-row:1 / 4;   /* занимает строки 1–3 */
}

.swap-btn{
  padding:0;
  border:none;
  background:transparent;
  font-size:20px;
  line-height:1;
  color:#075e54;
  cursor:pointer;
}
.swap-btn:hover{
  background:#ecfdf5;
  border-radius:999px;
}

/* Пассажиры */
.pax-field{position:relative;}

.pax-trigger{
  width:100%;
  border-radius:12px;
  border:1px solid var(--line);
  padding:6px 34px 6px 12px;  /* чуть меньше отступы */
  background:#ffffff;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  justify-content:center;
  cursor:pointer;
  position:relative;
  color:var(--ink);
}

.pax-main{
  font-size:13px;
  font-weight:600;
}
.pax-sub{
  font-size:10px;
  color:#9ca3af;
  margin-top:1px;
}

.pax-chevron{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  font-size:13px;
  color:var(--muted);
}
    /* панель с выбором пассажиров — выпадающее окошко */
.pax-panel{
  position:absolute;
  right:0;
  margin-top:6px;
  background:#ffffff;
  border-radius:16px;
  box-shadow:0 18px 45px rgba(15,23,42,0.18);
  padding:14px 18px 12px;
  width:280px;
  z-index:50;
}

/* скрыта по умолчанию */
.pax-panel.hidden{
  display:none;
}

.pax-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.pax-label-wrap{
  max-width:60%;
}
.pax-title{
  font-size:14px;
  font-weight:500;
}
.pax-note{
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
}
.pax-counter{
  display:flex;
  align-items:center;
  gap:10px;
}
.pax-btn{
  width:32px;
  height:32px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#ffffff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  line-height:1;
  color:var(--accent);
  padding:0;
}
.pax-count{
  width:18px;
  text-align:center;
  font-weight:500;
}

.pax-cabin{
  margin-top:8px;
  border-radius:999px;
  border:1px solid var(--line);
  display:grid;
  grid-template-columns:1fr 1fr;
  overflow:hidden;
}
.pax-cabin-btn{
  border:none;
  border-radius:0;
  padding:8px 4px;
  font-size:13px;
  background:#f9fafb;
  color:var(--muted);
}
.pax-cabin-btn.active{
  background:var(--accent);
  color:#ffffff;
}


.pax-hint-placeholder{
  min-height:16px;
  font-size:12px;
}

    /* адаптив */
@media (max-width:900px){
  .two-col{grid-template-columns:1fr}

  .search-grid{
    grid-template-columns:1fr;
  }

  .swap-cell--full{
    grid-row:auto;
    justify-content:flex-start;
    margin-top:4px;
  }

  .search-actions-row{
    justify-content:flex-start;
    flex-wrap:wrap;
  }

  .pax-panel{
    right:auto;
    left:0;
  }
}


    /* overlay загрузки */
.loading-overlay{
  position:fixed;
  inset:0;
  background:#ffffff;  /* ← ключевая строка */
  backdrop-filter:blur(12px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.loading-overlay.hidden{display:none;}

.loading-inner{
  text-align:center;
  /* overflow убрали, чтобы не резало видео */
}

/* маленькая птица по центру */
.loading-logo-wrap{
  position:relative;
  display:inline-block;
  max-width:260px;   /* можно 180–240 по вкусу */
  width:100%;
  margin:0 auto;
  animation:logo-float 3s ease-in-out infinite;
}

/* само видео */
.loading-logo-video{
  display:block;
  max-width:260px;
  max-height:40vh;   /* не больше 40% высоты экрана */
  width:100%;
  height:auto;
  border-radius:24px;
}

/* мягкое свечение под птицей */
.loading-logo-wrap::before{
  content:"";
  position:absolute;
  left:10%;
  right:10%;
  bottom:-10px;
  height:18px;
  border-radius:999px;
  background:radial-gradient(ellipse at center, rgba(7,94,84,0.45), transparent 60%);
  filter:blur(8px);
  opacity:0.75;
  animation:glow-pulse 2.2s ease-in-out infinite;
}

@keyframes logo-float{
  0%,100%{ transform:translateY(0); }
  50%{ transform:translateY(-8px); }
}

@keyframes glow-pulse{
  0%,100%{
    transform:scaleX(1);
    opacity:0.6;
  }
  50%{
    transform:scaleX(1.12);
    opacity:0.9;
  }
}


.loading-text{
  margin-top:14px;
  font-size:16px;
  color:var(--muted);
}

/* ---------- Анимированный логотип в оверлее ---------- */

/* контейнер под слои логотипа */
.loading-logo-anim{
  position:relative;
  width:210px;   /* можно 180–220, подбери на глаз */
  height:300px;
  margin:0 auto;
}

/* каждый слой растянут на весь холст */
.loading-logo-anim .logo-layer{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  pointer-events:none;
}

/* тело слегка «дышит» */
.loading-logo-anim .logo-bird{
  animation:bird-bob 1.2s ease-in-out infinite;
}

/* крыло – основная анимация */
.loading-logo-anim .logo-wing{
  transform-origin:28% 52%;  /* точка крепления крыла */
  animation:wing-flap 0.6s ease-in-out infinite;
}

/* солнце чуть подпрыгивает */
.loading-logo-anim .logo-sun{
  animation:sun-bob 2.4s ease-in-out infinite;
}

/* если позже добавишь дугу / надпись */
.loading-logo-anim .logo-arca{
  animation:arc-sway 2.4s ease-in-out infinite;
}
.loading-logo-anim .logo-wordmark{
  animation:none;
}

/* ---------- keyframes ---------- */

@keyframes wing-flap{
  0%,100%{
    transform:rotate(0deg);
  }
  50%{
    transform:rotate(-18deg) translateY(-6px);
  }
}

@keyframes bird-bob{
  0%,100%{
    transform:translateY(0);
  }
  50%{
    transform:translateY(-4px);
  }
}

@keyframes arc-sway{
  0%,100%{
    transform:rotate(0deg);
  }
  50%{
    transform:rotate(3deg);
  }
}

@keyframes sun-bob{
  0%,100%{
    transform:translateY(0);
  }
  50%{
    transform:translateY(-3px);
  }
}
/* контейнер с логотипом — маленькая птичка по центру */
.loading-logo-wrap{
  position:relative;
  display:inline-block;
  max-width:180px;     /* максимум ширины */
  width:100%;          /* на маленьких экранах сжимается */
  margin:0 auto;
  animation:logo-float 3s ease-in-out infinite;
}

/* само видео */
.loading-logo-video{
  display:block;
  max-width:180px;     /* чтобы точно не разъезжалось */
  max-height:30vh;     /* не больше 40% высоты экрана */
  width:100%;
  height:auto;
  border-radius:24px;
}


/* мягкое свечение под птицей */
.loading-logo-wrap::before{
  content:"";
  position:absolute;
  left:15%;
  right:15%;
  bottom:-8px;
  height:16px;
  border-radius:999px;
  background:radial-gradient(ellipse at center, rgba(7,94,84,0.45), transparent 60%);
  filter:blur(6px);
  opacity:0.7;
  animation:glow-pulse 2.2s ease-in-out infinite;
}

/* покачивание логотипа вверх-вниз */
@keyframes logo-float{
  0%,100%{
    transform:translateY(0);
  }
  50%{
    transform:translateY(-8px);
  }
}

/* пульсирующее свечение */
@keyframes glow-pulse{
  0%,100%{
    transform:scaleX(1);
    opacity:0.6;
  }
  50%{
    transform:scaleX(1.12);
    opacity:0.9;
  }
}

    .version{
      position:fixed;
      bottom:8px;
      right:10px;
      font-size:12px;
      color:#64748b;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      border-radius:8px;
      padding:4px 7px;
      z-index:990;
    }
  </style>
</head>
<body>
<div class="wrap">
  <!-- Бренд -->
  <header class="brand">
    <!-- НОВЫЙ ЛОГОТИП -->
    <img src="Logo-Full.png" alt="Yuvia" class="brand-logo">
    <div class="brand-text">
      <div class="brand-name">Yuvia</div>
      <div class="brand-tagline">персональный тревел-консьерж</div>
      <div class="brand-subline">поиск авиабилетов</div>
    </div>
  </header>

  <!-- Форма поиска -->
  <!-- Форма поиска -->
  <div class="card" id="searchForm">
    <div class="search-grid">
      <!-- Линия 1: текст -->
      <div class="label">Откуда</div>
      <div></div>
      <div class="label">Куда</div>
      <div></div>
      <div class="label">Дата вылета</div>
      <div></div>
      <div class="label">Дата возвращения</div>
      <div></div>
      <div class="label">Пассажиры</div>

      <!-- Линия 2: блоки -->
      <div>
        <input id="origin" placeholder="Москва" autocomplete="off" />
      </div>

      <div class="swap-cell swap-cell--full">
        <button type="button" class="swap-btn" id="swapInline" aria-label="Поменять местами города">⇆</button>
      </div>

      <div>
        <input id="destination" placeholder="Казань" autocomplete="off" />
      </div>

      <div></div>

      <div>
        <input id="depart" type="date" />
      </div>

      <div></div>

      <div>
        <input id="ret" type="date" />
      </div>

      <div></div>

      <div class="pax-field">
        <button type="button" class="pax-trigger" id="paxTrigger">
          <div class="pax-main" id="paxMainText">1 пассажир</div>
          <div class="pax-sub" id="paxSubText">эконом</div>
          <span class="pax-chevron">▾</span>
        </button>

        <!-- скрытый селект для скриптов -->
        <select id="adults" style="display:none">
          <option>1</option><option>2</option><option>3</option>
          <option>4</option><option>5</option><option>6</option>
        </select>

        <!-- панель пассажиров — как у тебя была -->
        <div class="pax-panel hidden" id="paxPanel">
          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">Взрослые</div>
              <div class="pax-note">от 12 лет</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="adults" data-delta="-1">−</button>
              <div class="pax-count" data-kind="adults">1</div>
              <button class="pax-btn" type="button" data-kind="adults" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">Дети</div>
              <div class="pax-note">от 2 до 12 лет</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="children" data-delta="-1">−</button>
              <div class="pax-count" data-kind="children">0</div>
              <button class="pax-btn" type="button" data-kind="children" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-row">
            <div class="pax-label-wrap">
              <div class="pax-title">Младенцы</div>
              <div class="pax-note">до 2 лет (без места)</div>
            </div>
            <div class="pax-counter">
              <button class="pax-btn" type="button" data-kind="infants" data-delta="-1">−</button>
              <div class="pax-count" data-kind="infants">0</div>
              <button class="pax-btn" type="button" data-kind="infants" data-delta="1">+</button>
            </div>
          </div>

          <div class="pax-cabin">
            <button type="button" class="pax-cabin-btn active" data-cabin="eco">Эконом</button>
            <button type="button" class="pax-cabin-btn" data-cabin="business">Бизнес</button>
          </div>
        </div>
      </div>

      <!-- Линия 3: подсказки -->
      <div class="hint" id="originIataHint"></div>
      <div></div>
      <div class="hint" id="destIataHint"></div>
      <div></div>
      <div class="hint" id="departHint"></div>
      <div></div>
      <div class="hint" id="retHint"></div>
      <div></div>
      <div class="pax-hint-placeholder"></div>
    </div>

    <!-- 4 строка: кнопки -->
    <div class="search-actions-row">
      <button class="btn-primary" id="doSearch">Искать</button>
      <button class="btn-ghost" id="toggleAdvanced">Расширенный поиск</button>
    </div>

    <!-- расширенный блок -->
    <div id="advancedBlock" class="advanced hidden">
      <div class="divider"></div>
      <div class="grid grid-2">
        <div>
          <div class="label">Валюта</div>
          <select id="currency">
            <option value="RUB">RUB ₽</option>
            <option value="USD">USD $</option>
            <option value="EUR">EUR €</option>
          </select>
        </div>
        <div>
          <div class="label">Маршрут</div>
          <select id="oneway">
            <option value="no">Туда-обратно</option>
            <option value="yes">Только в одну сторону</option>
          </select>
        </div>
        <div>
          <div class="label">Гибкие даты</div>
          <select id="flexMode">
            <option value="none">Отключено</option>
            <option value="weekend">Ближайшие выходные</option>
            <option value="plus3">± 3 дня</option>
            <option value="plus7">± 7 дней</option>
          </select>
        </div>
        <div>
          <div class="label">Класс обслуживания</div>
          <select id="cabin">
            <option value="eco">Эконом</option>
            <option value="business">Бизнес</option>
          </select>
        </div>
        <div class="row" style="justify-content:flex-end;gap:6px;align-items:flex-end">
          <button class="btn-secondary" id="swap">Поменять местами</button>
          <button class="btn-ghost" id="copyLink">Скопировать ссылку</button>
          <button class="btn-ghost" id="reset">Сбросить форму</button>
        </div>
      </div>
      <div class="hint" id="weekendHint" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Недавние запросы -->
  <div class="section-title">Недавние запросы</div>
  <div class="chips" id="recentChips"></div>

  <!-- Фильтры + результаты -->
  <div class="two-col">
    <!-- Фильтры -->
    <div class="card filters-block">
      <div class="section-title" style="margin-top:0">Фильтры</div>

      <div class="label">Пересадки</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="radio" name="stops" value="any" checked> любые</label>
        <label class="pill"><input type="radio" name="stops" value="0"> только прямые</label>
        <label class="pill"><input type="radio" name="stops" value="1"> не более 1</label>
      </div>

      <div class="label" style="margin-top:10px">Время вылета</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="checkbox" class="depwin" value="night"> ночь (00–06)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="morning"> утро (06–12)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="day"> день (12–18)</label>
        <label class="pill"><input type="checkbox" class="depwin" value="evening"> вечер (18–24)</label>
      </div>

      <div class="label" style="margin-top:10px">Время прилёта</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px">
        <label class="pill"><input type="checkbox" class="arrwin" value="night"> ночь</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="morning"> утро</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="day"> день</label>
        <label class="pill"><input type="checkbox" class="arrwin" value="evening"> вечер</label>
      </div>

      <div class="label" style="margin-top:10px">Длительность (часы, максимум)</div>
      <input type="number" id="durMax" min="0" step="1" placeholder="например, 5" style="width:100%">

      <div class="label" style="margin-top:10px">Цена</div>
      <div class="row" style="gap:6px;align-items:center">
        <input type="number" id="priceMin" placeholder="мин" style="flex:1;min-width:0">
        <span>—</span>
        <input type="number" id="priceMax" placeholder="макс" style="flex:1;min-width:0">
      </div>

      <div class="label" style="margin-top:10px">Авиакомпании</div>
      <select id="airlineFilter" multiple size="6" style="width:100%"></select>

      <div class="label" style="margin-top:10px">Аэропорты</div>
      <select id="airportFilter" multiple size="6" style="width:100%"></select>

      <button class="btn-ghost" id="clearFilters" style="margin-top:12px;width:100%">Сбросить фильтры</button>
    </div>

    <!-- Результаты -->
    <div>
      <div class="toolbar">
        <div class="label" style="margin:0">Сортировка</div>
        <select id="sortBy">
          <option value="price_asc">Сначала дешёвые</option>
          <option value="price_desc">Сначала дорогие</option>
          <option value="duration_asc">Короткий путь</option>
          <option value="depart_asc">Ранний вылет</option>
        </select>
        <div class="chip" id="summaryChip" title="Краткая сводка по результатам">—</div>
      </div>

      <div class="section-title" style="margin-top:4px">Результаты</div>
      <div id="results" class="grid"></div>

      <div class="section-title">Соседние даты</div>
      <div id="matrix" class="chips"></div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-inner">
    <div class="loading-logo-wrap">
      <video
        class="loading-logo-video"
        autoplay
        muted
        loop
        playsinline
        preload="auto"
      >
        <!-- сначала webm, как более “родной” для браузеров -->
        <source src="Yuvia_Anim.webm" type="video/webm">
      </video>
    </div>
    <div class="loading-text">Ищем лучшие варианты...</div>
  </div>
</div>


<div class="version">версия 11.8</div>

<script>
/* ========= helpers ========= */
const $ = (sel)=>document.querySelector(sel);
const fmt2 = (n)=>String(n).padStart(2,'0');
const todayLocal = (()=>{ const t=new Date(); return new Date(t.getFullYear(),t.getMonth(),t.getDate()); })();

function parseDateSmart(s){
  if(!s) return null;
  // ISO: YYYY-MM-DD
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [y,m,d] = s.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    return isNaN(dt)?null:dt;
  }
  // DD.MM.YYYY
  if(/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(s)){
    const [dd,mm,yy] = s.split('.').map(Number);
    const dt = new Date(yy, mm-1, dd);
    return isNaN(dt)?null:dt;
  }
  return null;
}
function toISO(d){
  if(!d) return "";
  const y = d.getFullYear();
  const m = fmt2(d.getMonth() + 1);
  const day = fmt2(d.getDate());
  return `${y}-${m}-${day}`;
}

function ddmmyyyy(d){return `${fmt2(d.getDate())}.${fmt2(d.getMonth()+1)}.${d.getFullYear()}`;}

function weekendAround(today=new Date()){
  const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const wd = t.getDay(); // 0=Вс ... 6=Сб
  let sat = new Date(t);
  sat.setDate(t.getDate() + ((6 - (wd||7)) % 7) || 7);
  if (wd === 6 || wd === 0) { sat.setDate(sat.getDate() + 7); }
  const sun = new Date(sat); sun.setDate(sat.getDate()+1);
  return {sat, sun};
}
function clampToFuture(d){
  if(!d) return null;
  return d < todayLocal ? todayLocal : d;
}

function timeWindowStrToRange(v){
  if(v==='night') return [0,6];
  if(v==='morning') return [6,12];
  if(v==='day') return [12,18];
  if(v==='evening') return [18,24];
  return null;
}

/* ========= state: недавние запросы ========= */
function saveRecent(item){
  const key='recent';
  const list = JSON.parse(localStorage.getItem(key)||'[]');
  const norm = JSON.stringify({...item, ts:undefined});
  const idx = list.findIndex(x=>JSON.stringify({...x,ts:undefined})===norm);
  if(idx!==-1) list.splice(idx,1);
  list.unshift({...item, ts:Date.now()});
  while(list.length>5) list.pop();
  localStorage.setItem(key, JSON.stringify(list));
  renderRecent();
}
function renderRecent(){
  const cont = $('#recentChips'); cont.innerHTML='';
  const list = JSON.parse(localStorage.getItem('recent')||'[]');
  list.forEach(r=>{
    const chip = document.createElement('div'); chip.className='chip';
    const d = r.depart ? ddmmyyyy(parseDateSmart(r.depart)) : '';
    chip.textContent = `${r.origin_city} → ${r.dest_city} ${d}${r.oneway==='yes'?' (OW)':''}`;
    chip.onclick=()=>{applyState(r); doSearch();};
    cont.appendChild(chip);
  });
}
function applyState(st){
  $('#origin').value = st.origin_city || '';
  $('#destination').value = st.dest_city || '';
  $('#depart').value = st.depart || '';
  $('#ret').value = st.ret || '';
  $('#currency').value = st.currency || 'RUB';
  $('#adults').value = st.adults || '1';
  $('#oneway').value = st.oneway || 'no';
  $('#flexMode').value = st.flex || 'none';
  originIATA = st.origin_iata || '';
  destIATA = st.dest_iata || '';
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  toggleOneWay();
  updateWeekendHint();
}
function syncURLFromState(params){
  const qp = new URLSearchParams(window.location.search);
  Object.entries(params).forEach(([k,v])=>{
    if(v===undefined || v===null || v==='') qp.delete(k); else qp.set(k,String(v));
  });
  const url = `${location.pathname}?${qp.toString()}`;
  history.replaceState(null,'',url);
}
function restoreFromURL(){
  const p = new URLSearchParams(location.search);
  const get = (k, def='') => p.get(k) ?? def;
  const s = {
    origin_city: get('oc'),
    dest_city:   get('dc'),
    depart:      get('d'),
    ret:         get('r'),
    currency:    get('cur','RUB'),
    adults:      get('ad','1'),
    oneway:      get('ow','no'),
    flex:        get('fx','none'),
    origin_iata: get('oi') || '',
    dest_iata:   get('di') || ''
  };
  if(s.origin_city || s.dest_city) applyState(s);
}

/* ========= подсказки городов ========= */
let originIATA = '', destIATA = '';

async function suggestCity(q){
  if(!q || q.length<2) return [];
  const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(q)}&locale=ru&types[]=city`;
  const r = await fetch(url); if(!r.ok) return [];
  return await r.json();
}

let suggestBox = null;
let suggestInput = null;
function ensureSuggestBox(){
  if(suggestBox) return suggestBox;
  suggestBox = document.createElement('div');
  Object.assign(suggestBox.style,{
    position:'absolute',
    background:'#ffffff',
    border:'1px solid #e2e8f0',
    borderRadius:'8px',
    boxShadow:'0 12px 30px rgba(15,23,42,0.15)',
    zIndex:9999,
    minWidth:'220px',
    maxHeight:'260px',
    overflowY:'auto',
    fontSize:'14px'
  });
  document.body.appendChild(suggestBox);
  suggestBox.hidden = true;
  return suggestBox;
}
function closeSuggest(){
  if(!suggestBox) return;
  suggestBox.hidden = true;
  suggestBox.innerHTML = '';
  suggestInput = null;
}
function openSuggestFor(input, items, onPick){
  const box = ensureSuggestBox();
  box.innerHTML = '';
  items.slice(0,7).forEach(item=>{
    const row = document.createElement('div');
    row.textContent = `${item.name}, ${item.country_name} (${item.code})`;
    Object.assign(row.style,{padding:'8px 10px',cursor:'pointer'});
    row.onmouseenter=()=>row.style.background='#f1f5f9';
    row.onmouseleave=()=>row.style.background='#ffffff';
    row.onmousedown = e=>e.preventDefault();
    row.onclick=()=>{
      input.value=item.name;
      onPick(item);
      closeSuggest();
    };
    box.appendChild(row);
  });
  const r = input.getBoundingClientRect();
  box.style.left = (r.left + window.scrollX)+'px';
  box.style.top = (r.bottom + window.scrollY)+'px';
  box.style.width = r.width+'px';
  suggestInput = input;
  box.hidden = false;
}
document.addEventListener('pointerdown',(e)=>{
  if(!suggestBox || suggestBox.hidden) return;
  if(e.target===suggestInput) return;
  if(!suggestBox.contains(e.target)) closeSuggest();
},true);
window.addEventListener('scroll',closeSuggest,true);
window.addEventListener('resize',closeSuggest);
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeSuggest(); });

function attachSuggest(inputEl, onPick){
  inputEl.addEventListener('input', async ()=>{
    const q = inputEl.value.trim();
    if(q.length<2){ closeSuggest(); return; }
    const list = await suggestCity(q);
    if(!list.length){ closeSuggest(); return; }
    openSuggestFor(inputEl,list,onPick);
  });
  inputEl.addEventListener('focus', async ()=>{
    const q = inputEl.value.trim();
    if(q.length<2){ return; }
    const list = await suggestCity(q);
    if(list.length) openSuggestFor(inputEl,list,onPick);
  });
}

attachSuggest($('#origin'), (item)=>{ originIATA=item.code; $('#originIataHint').textContent='IATA: '+originIATA; });
attachSuggest($('#destination'), (item)=>{ destIATA=item.code; $('#destIataHint').textContent='IATA: '+destIATA; });

/* ========= one-way ========= */
function toggleOneWay(){
  const ow = $('#oneway').value==='yes';
  const ret = $('#ret');
  if(ow){ ret.value=''; ret.disabled=true; $('#retHint').textContent=''; }
  else { ret.disabled=false; }
}
$('#oneway').addEventListener('change',()=>{
  toggleOneWay();
  syncURLFromState({ow:$('#oneway').value});
});

/* ========= гибкие даты ========= */
function updateWeekendHint(){
  const fm = $('#flexMode').value;
  const h = $('#weekendHint');
  if(fm!=='weekend'){ h.textContent=''; return; }
  const {sat,sun}=weekendAround(new Date());
  h.textContent = `Ближайшие выходные: ${ddmmyyyy(sat)} — ${ddmmyyyy(sun)}`;
}
$('#flexMode').addEventListener('change',()=>{
  updateWeekendHint();
  syncURLFromState({fx:$('#flexMode').value});
});

/* ========= диплинк на Aviasales ========= */
const MARKER = 672309;
function buildDeeplink({ori, dst, d1, d2, currency, adults, oneway}){
  const DD1 = d1 ? (fmt2(d1.getDate()) + fmt2(d1.getMonth()+1)) : '';
  const DD2 = d2 ? (fmt2(d2.getDate()) + fmt2(d2.getMonth()+1)) : '';
  let slug = '';
  if(oneway==='yes'){
    slug = `/${ori}${DD1}${dst}1`;
  } else {
    slug = `/${ori}${DD1}${dst}${DD2}1`;
  }
  const params = new URLSearchParams({
    marker: MARKER,
    with_request: 'true',
    adults: String(adults||1),
    currency: (currency||'RUB').toLowerCase(),
    utm_source: 'yuvia_miniapp'
  });
  return `https://www.aviasales.ru/search${slug}?${params.toString()}`;
}

/* ========= API ========= */
const API_BASE = 'https://yuvia-flights-api.yuviabot.workers.dev';

async function callJSON(path){
  const url = path.startsWith('http') ? path : API_BASE + path;
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/* ========= состояние результатов ========= */
let allResults = [];
let baseCurrency = 'RUB';

function showLoadingSkeleton(){
  const r = $('#results'); r.innerHTML='';
  for(let i=0;i<4;i++){
    const s=document.createElement('div'); s.className='skeleton'; r.appendChild(s);
  }
}
function showMatrix(chips){
  const m = $('#matrix'); m.innerHTML='';
  chips.forEach(c=>{
    const el=document.createElement('div'); el.className='chip';
    el.textContent = `${c.dstr} · от ${c.price} ${c.currency}`;
    el.onclick=()=>{
      const dt = parseDateSmart(c.dstr);
      if(dt) $('#depart').value = toISO(dt);
      syncURLFromState({d:$('#depart').value});
      doSearch();
    };
    m.appendChild(el);
  });
}
function renderAirlinesFilter(){
  const sel = $('#airlineFilter');
  const set = new Set(allResults.map(x=>x.airline).filter(Boolean));
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>`<option value="${a}">${a}</option>`).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function renderAirportsFilter(){
  const sel = $('#airportFilter');
  const set = new Set();
  allResults.forEach(x=>{
    if(x.origin_airport) set.add(`FROM:${x.origin_airport}`);
    if(x.dest_airport) set.add(`TO:${x.dest_airport}`);
  });
  const cur = new Set(Array.from(sel.selectedOptions||[]).map(o=>o.value));
  sel.innerHTML = [...set].sort().map(a=>{
    return `<option value="${a}">${a.replace(/^FROM:/,'Отправление: ').replace(/^TO:/,'Прибытие: ')}</option>`;
  }).join('');
  Array.from(sel.options).forEach(o=>{ if(cur.has(o.value)) o.selected=true; });
}
function summarize(){
  if(!allResults.length){ $('#summaryChip').textContent='—'; return; }
  const prices = allResults.map(x=>x.price).sort((a,b)=>a-b);
  const min = prices[0];
  const avg = Math.round(prices.reduce((s,v)=>s+v,0)/prices.length);
  $('#summaryChip').textContent = `от ${min.toLocaleString('ru-RU')} · средняя ${avg.toLocaleString('ru-RU')} ${baseCurrency}`;
}

function withinWindow(timeStr, windowsSelected){
  if(!windowsSelected.length || !timeStr) return true;
  const m = timeStr.match(/^(\d{2}):(\d{2})/);
  if(!m) return true;
  const hh = +m[1] + (+m[2]/60);
  return windowsSelected.some(w=>{
    const [a,b]=timeWindowStrToRange(w); return (hh>=a && hh<b);
  });
}

function applyFiltersAndSort(){
  const r = $('#results'); r.innerHTML='';
  if(!allResults.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML=`<div class="bad">Ничего не нашли.</div><div class="hint">Попробуй поменять даты, валюту или снять фильтры. Ниже — цены на соседние дни.</div>`;
    r.appendChild(empty);
    return;
  }

  const stops = (document.querySelector('input[name="stops"]:checked')||{}).value || 'any';
  const depWins = Array.from(document.querySelectorAll('.depwin:checked')).map(x=>x.value);
  const arrWins = Array.from(document.querySelectorAll('.arrwin:checked')).map(x=>x.value);
  const durMax = parseInt($('#durMax').value,10);
  const pmin = parseInt($('#priceMin').value,10);
  const pmax = parseInt($('#priceMax').value,10);
  const airlineSel = new Set(Array.from($('#airlineFilter').selectedOptions||[]).map(o=>o.value));
  const airportSel = new Set(Array.from($('#airportFilter').selectedOptions||[]).map(o=>o.value));

  let list = allResults.filter(x=>{
    if(stops==='0' && x.transfers>0) return false;
    if(stops==='1' && x.transfers>1) return false;
    if(Number.isFinite(durMax) && x.duration_hours>durMax) return false;
    if(Number.isFinite(pmin) && x.price<pmin) return false;
    if(Number.isFinite(pmax) && x.price>pmax) return false;
    if(airlineSel.size && !airlineSel.has(x.airline)) return false;
    if(airportSel.size){
      const from = `FROM:${x.origin_airport||''}`;
      const to   = `TO:${x.dest_airport||''}`;
      if(!airportSel.has(from) && !airportSel.has(to)) return false;
    }
    if(!withinWindow(x.depTime, depWins)) return false;
    if(!withinWindow(x.arrTime, arrWins)) return false;
    return true;
  });

  const s = $('#sortBy').value;
  list.sort((a,b)=>{
    if(s==='price_asc') return a.price-b.price;
    if(s==='price_desc') return b.price-a.price;
    if(s==='duration_asc') return a.duration-b.duration;
    if(s==='depart_asc') return (a.depSort||0)-(b.depSort||0);
    return 0;
  });

  if(!list.length){
    const empty=document.createElement('div'); empty.className='card';
    empty.innerHTML=`<div class="bad">После применения фильтров ничего не осталось.</div><div class="hint">Сними часть фильтров или расширь диапазоны.</div>`;
    r.appendChild(empty);
    return;
  }

  list.forEach(x=>{
    const el=document.createElement('div'); el.className='result';
    const left=document.createElement('div');
    const transfersText = x.transfers===0
      ? 'без пересадок'
      : x.transfers===1
        ? '1 пересадка'
        : `${x.transfers} пересадки`;
    left.innerHTML=`
      <div class="result-main-title">
        ${x.origin} ${x.origin_airport?`(${x.origin_airport})`:''}
        → ${x.destination} ${x.dest_airport?`(${x.dest_airport})`:''}
      </div>
      <div class="result-meta">
        ${x.depDateStr}${x.retDateStr?(' — '+x.retDateStr):''}
        · ${x.airline || 'авиакомпания неизвестна'}
        · ${transfersText}
        · длительность: ${x.durStr || (x.duration_hours?x.duration_hours+' ч':'—')}
      </div>
      <div class="result-times">
        ${x.depTime?('вылет: '+x.depTime):''}
        ${x.arrTime?(' · прилёт: '+x.arrTime):''}
      </div>
    `;
    const right=document.createElement('div');
    right.style.textAlign='right';
    const logoHtml = x.airlineCode
      ? `<img class="airline-logo" src="https://pics.avs.io/80/24/${x.airlineCode}.png" alt="${x.airlineCode}" onerror="this.style.display='none'">`
      : '';
    right.innerHTML=`
      <div class="price">${x.price.toLocaleString('ru-RU')} ${x.currency}</div>
      ${logoHtml}
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <a href="${x.deeplink}" target="_blank" rel="noopener">
          <button class="btn-primary">На Aviasales</button>
        </a>
      </div>
    `;
    el.appendChild(left); el.appendChild(right);
    r.appendChild(el);
  });
}

['change','input'].forEach(ev=>{
  $('#sortBy').addEventListener(ev,applyFiltersAndSort);
  $('#priceMin').addEventListener(ev,applyFiltersAndSort);
  $('#priceMax').addEventListener(ev,applyFiltersAndSort);
  $('#durMax').addEventListener(ev,applyFiltersAndSort);
  $('#airlineFilter').addEventListener(ev,applyFiltersAndSort);
  $('#airportFilter').addEventListener(ev,applyFiltersAndSort);
  document.querySelectorAll('input[name="stops"]').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
  document.querySelectorAll('.depwin').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
  document.querySelectorAll('.arrwin').forEach(n=>n.addEventListener(ev,applyFiltersAndSort));
});

/* ========= нормализация рейса ========= */
function normalizeFlight(x,{ori,dst,cur,d1,d2,oneway,adults}){
  const depDateStr = x.depart_date ? x.depart_date.split('T')[0].split('-').reverse().join('.') : '';
  const retDateStr = x.return_date ? x.return_date.split('T')[0].split('-').reverse().join('.') : '';
  const depTime = x.depart_time || x.departure_time || '';
  const arrTime = x.arrival_time || x.arr_time || '';
  const hh = depTime ? parseInt(depTime.slice(0,2),10) : null;
  const airlineCode = x.airline_code || x.airline_iata || x.airline || '';
  const dur = x.duration || x.duration_to || 0;
  const duration_hours = x.duration_hours ?? Math.round((dur||0)/60);

  const deeplink = buildDeeplink({ori,dst,d1,d2:(oneway==='yes'?null:d2),currency:cur,adults,oneway});

  return {
    origin:x.origin,
    destination:x.destination,
    origin_airport:x.origin_airport || x.origin_airport_code || x.origin_airport_iata || '',
    dest_airport:x.destination_airport || x.destination_airport_code || x.destination_airport_iata || '',
    price:Math.round(x.price ?? x.value ?? 0),
    currency:x.currency || cur,
    airline:x.airline || airlineCode || '',
    airlineCode,
    transfers:(typeof x.transfers==='number')?x.transfers:(x.number_of_changes ?? 0),
    duration:dur,
    duration_to:dur,
    duration_hours,
    durStr:duration_hours?`${duration_hours} ч`:'',
    depTime, arrTime,
    depSort:(hh===null?0:hh*60 + (parseInt(depTime.slice(3,5),10)||0)),
    depDateStr, retDateStr,
    deeplink
  };
}

/* ========= matrix helper ========= */
function showMatrixSafe(ori,dst,cur,d1,flex){
  const params = new URLSearchParams({origin:ori,destination:dst,currency:cur,center:toISO(d1)});
  if(flex==='plus3') params.set('range','3');
  else if(flex==='plus7') params.set('range','7');
  else if(flex==='weekend') params.set('range','1');
  else params.set('range','0');
  return callJSON(`/api/matrix?${params.toString()}`)
    .then(m=>{
      const chips=(m.data||[]).slice(0,12).map(it=>({dstr:it.date_str,price:it.price,currency:it.currency}));
      showMatrix(chips);
    })
    .catch(()=>{});
}

/* ========= loading overlay ========= */
function setLoading(on, delay = 0){
  const ov = $('#loadingOverlay');
  if(!ov) return;

  if(on){
    // Показать оверлей сразу
    ov.classList.remove('hidden');
  } else {
    // Скрыть с задержкой
    if(delay > 0){
      setTimeout(()=>ov.classList.add('hidden'), delay);
    } else {
      ov.classList.add('hidden');
    }
  }
}


/* ========= основной поиск ========= */
async function doSearch(){
  const oriCity = $('#origin').value.trim();
  const dstCity = $('#destination').value.trim();
  if(!oriCity || !dstCity){ alert('Укажи города вылета и назначения'); return; }

  async function ensureIataFor(city, known){
    if(known) return known;
    const s = await suggestCity(city);
    return s[0]?.code || '';
  }
  if(!originIATA) originIATA = await ensureIataFor(oriCity, originIATA);
  if(!destIATA) destIATA = await ensureIataFor(dstCity, destIATA);
  const ori = originIATA, dst = destIATA;
  if(!ori || !dst){ alert('Не удалось определить IATA код(ы)'); return; }

  const ow = $('#oneway').value;
  const cur = $('#currency').value; baseCurrency = cur;
  const adults = +$('#adults').value || 1;

  let d1 = clampToFuture(parseDateSmart($('#depart').value));
  let d2 = parseDateSmart($('#ret').value);
  const flex = $('#flexMode').value;

  if(flex==='weekend'){
    const {sat,sun}=weekendAround(new Date());
    d1=sat; if(ow!=='yes') d2=sun;
    $('#depart').value = toISO(d1);
    if(ow!=='yes') $('#ret').value = toISO(d2);
  }
  if(!d1){ $('#departHint').textContent='Укажи дату вылета'; alert('Укажи дату вылета'); return; }
  if(d1<todayLocal){ d1=todayLocal; $('#depart').value=toISO(d1); }
  if(ow!=='yes' && d2 && d2<d1){ $('#retHint').textContent='Возврат не может быть раньше вылета'; alert('Дата возврата раньше вылета'); return; }
  if(ow==='yes'){ $('#retHint').textContent=''; }

  const state = {
    origin_city:oriCity, dest_city:dstCity,
    origin_iata:ori, dest_iata:dst,
    depart:$('#depart').value, ret:$('#ret').value,
    currency:cur, adults:String(adults), oneway:ow, flex
  };
  saveRecent(state);
  syncURLFromState({
    oc:oriCity, dc:dstCity, d:state.depart, r:state.ret,
    cur:cur, ad:adults, ow:ow, fx:flex, oi:ori, di:dst
  });

  setLoading(true);
  showLoadingSkeleton();
  showMatrixSafe(ori,dst,cur,d1,flex);

  const q = new URLSearchParams({
    origin:ori,destination:dst,currency:cur,
    oneway:ow==='yes'?'1':'0',
    depart:toISO(d1),
    ret:(ow==='yes'||!d2)?'':toISO(d2),
    adults:String(adults)
  });

  let json;
  try{
    json = await callJSON(`/api/search?${q.toString()}`);
  }catch(e){
    $('#results').innerHTML = `<div class="card"><div class="bad">Ошибка: ${e.message}</div><div class="hint">Попробуй повторить поиск позже.</div></div>`;
   setLoading(false, 4000);
    return;
  }

  const listRaw = (json.data||[]).filter(x=>x.price>0 && x.origin===ori && x.destination===dst);
  allResults = listRaw.map(x=>normalizeFlight(x,{ori,dst,cur,d1,d2,oneway:ow,adults}));

  renderAirlinesFilter();
  renderAirportsFilter();
  summarize();
  applyFiltersAndSort();
 setLoading(false, 4000);
}

/* ========= кнопки ========= */
$('#doSearch').addEventListener('click',e=>{ e.preventDefault(); doSearch(); });

function swapCities(){
  const a=$('#origin').value, b=$('#destination').value;
  $('#origin').value=b; $('#destination').value=a;
  const ia=originIATA; originIATA=destIATA; destIATA=ia;
  $('#originIataHint').textContent = originIATA?('IATA: '+originIATA):'';
  $('#destIataHint').textContent = destIATA?('IATA: '+destIATA):'';
  syncURLFromState({oc:$('#origin').value.trim(), dc:$('#destination').value.trim(), oi:originIATA, di:destIATA});
}
['#swap','#swapInline'].forEach(id=>{
  const el = document.querySelector(id);
  if(el) el.addEventListener('click',swapCities);
});

$('#copyLink').addEventListener('click',()=>{
  const d1=parseDateSmart($('#depart').value), d2=parseDateSmart($('#ret').value);
  const link = buildDeeplink({
    ori:originIATA, dst:destIATA,
    d1,d2, currency:$('#currency').value,
    adults:+$('#adults').value||1, oneway:$('#oneway').value
  });
  navigator.clipboard.writeText(link).then(()=>alert('Ссылка скопирована'));
});
$('#reset').addEventListener('click',()=>{
  $('#origin').value=''; $('#destination').value='';
  $('#depart').value=''; $('#ret').value='';
  $('#currency').value='RUB'; $('#adults').value='1';
  $('#oneway').value='no'; $('#flexMode').value='none';
  originIATA=''; destIATA='';
  $('#originIataHint').textContent=''; $('#destIataHint').textContent='';
  $('#results').innerHTML=''; $('#matrix').innerHTML='';
  updateWeekendHint();
  syncURLFromState({oc:null,dc:null,d:null,r:null,cur:null,ad:null,ow:null,fx:null,oi:null,di:null});
  initPaxFromAdultsSelect();
});
$('#clearFilters').addEventListener('click',()=>{
  document.querySelector('input[name="stops"][value="any"]').checked=true;
  document.querySelectorAll('.depwin,.arrwin').forEach(cb=>cb.checked=false);
  $('#durMax').value=''; $('#priceMin').value=''; $('#priceMax').value='';
  Array.from($('#airlineFilter').options).forEach(o=>o.selected=false);
  Array.from($('#airportFilter').options).forEach(o=>o.selected=false);
  applyFiltersAndSort();
});
$('#toggleAdvanced').addEventListener('click',e=>{
  e.preventDefault();
  const block = $('#advancedBlock');
  const isHidden = block.classList.contains('hidden');
  block.classList.toggle('hidden',!isHidden);
  $('#toggleAdvanced').textContent = isHidden ? 'Скрыть расширенный поиск' : 'Расширенный поиск';
});

/* ========= даты: ограничения ========= */
function initMinDateHints(){
  const iso = toISO(todayLocal);
  $('#depart').min = iso;
  $('#ret').min = iso;
  $('#departHint').textContent = `> ${ddmmyyyy(todayLocal)}`;
}

function normalizeDepartDate(){
  let d = parseDateSmart($('#depart').value);
  d = clampToFuture(d);
  if(!d) return;
  const iso = toISO(d);
  $('#depart').value = iso;
  $('#ret').min = iso;

  const r = parseDateSmart($('#ret').value);
  if(r && r<d){
    $('#ret').value='';
    $('#retHint').textContent='';
  }
}

['change','blur','input'].forEach(ev=>{
  $('#depart').addEventListener(ev, normalizeDepartDate);
});
function normalizeReturnDate(){
  let r = parseDateSmart($('#ret').value);
  if(!r) return;
  r = clampToFuture(r);
  const d = parseDateSmart($('#depart').value);
  if(d && r < d) r = d;
  $('#ret').value = toISO(r);
}

['change','blur','input'].forEach(ev=>{
  $('#ret').addEventListener(ev, normalizeReturnDate);
});

/* ========= блок пассажиров ========= */
const paxState = {adults:1, children:0, infants:0, cabin:'eco'};

function updatePaxSummary(){
  const total = paxState.adults + paxState.children + paxState.infants;
  const main = $('#paxMainText');
  const sub = $('#paxSubText');
  main.textContent = `${total} пассажир${total===1?'':'ов'}`;
  sub.textContent = paxState.cabin==='eco' ? 'эконом' : 'бизнес';

  const sel = $('#adults');
  if(sel) sel.value = String(total);

  ['adults','children','infants'].forEach(kind=>{
    const cnt = document.querySelector(`.pax-count[data-kind="${kind}"]`);
    if(cnt) cnt.textContent = paxState[kind];
  });
}

function initPaxFromAdultsSelect(){
  const sel = $('#adults');
  if(!sel) return;
  const n = parseInt(sel.value || '1',10);
  paxState.adults = isNaN(n)?1:Math.max(1,n);
  paxState.children = 0;
  paxState.infants = 0;
  paxState.cabin = 'eco';
  updatePaxSummary();
}

document.querySelectorAll('.pax-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const kind = btn.dataset.kind;
    const delta = parseInt(btn.dataset.delta,10);
    const min = kind==='adults'?1:0;
    const max = 9;
    let val = paxState[kind] + delta;
    if(val<min) val=min;
    if(val>max) val=max;
    paxState[kind] = val;
    updatePaxSummary();
  });
});

document.querySelectorAll('.pax-cabin-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    paxState.cabin = btn.dataset.cabin;
    document.querySelectorAll('.pax-cabin-btn').forEach(b=>b.classList.toggle('active',b===btn));
    const cabinSelect = $('#cabin');
    if(cabinSelect){
      cabinSelect.value = paxState.cabin;
    }
    updatePaxSummary();
  });
});

const paxTrigger = $('#paxTrigger');
const paxPanel = $('#paxPanel');
paxTrigger.addEventListener('click',()=>{
  paxPanel.classList.toggle('hidden');
});
document.addEventListener('click',e=>{
  if(!paxPanel.contains(e.target) && !paxTrigger.contains(e.target)){
    paxPanel.classList.add('hidden');
  }
});

/* ========= init ========= */
updateWeekendHint();
renderRecent();
toggleOneWay();
initMinDateHints();
restoreFromURL();
initPaxFromAdultsSelect();
</script>
</body>
</html>
